/*! For license information please see bundle.2d312cdf7d5d73b39ac2.js.LICENSE.txt */
(()=>{"use strict";function e(t){return e="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},e(t)}function t(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,i(o.key),o)}}function i(t){var i=function(t){if("object"!=e(t)||!t)return t;var i=t[Symbol.toPrimitive];if(void 0!==i){var n=i.call(t,"string");if("object"!=e(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(t)}(t);return"symbol"==e(i)?i:i+""}var n=function(){return e=function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.canvas=t,this.context=t.getContext("2d"),this.isRunning=!1,this.isPaused=!1,this.lastTime=0,this.targetFPS=60,this.frameTime=1e3/this.targetFPS,this.systems=new Map,this.scenes=new Map,this.currentScene=null,this.gameLoop=this.gameLoop.bind(this)},(i=[{key:"registerSystem",value:function(e,t){this.systems.set(e,t)}},{key:"getSystem",value:function(e){return this.systems.get(e)}},{key:"registerScene",value:function(e,t){this.scenes.set(e,t)}},{key:"getCurrentScene",value:function(){return this.currentScene}},{key:"switchScene",value:function(e){console.log("Attempting to switch to scene:",e),console.log("Available scenes:",Array.from(this.scenes.keys()));var t=this.scenes.get(e);if(!t)throw console.error("Scene '".concat(e,"' not found")),new Error("Scene '".concat(e,"' not found"));console.log("Found scene:",t.name),this.currentScene&&this.currentScene.exit&&(console.log("Exiting current scene:",this.currentScene.name),this.currentScene.exit()),this.currentScene=t,console.log("Set current scene to:",this.currentScene.name),this.currentScene.enter&&(console.log("Entering new scene:",this.currentScene.name),this.currentScene.enter())}},{key:"start",value:function(){this.isRunning||(this.isRunning=!0,this.isPaused=!1,this.lastTime=performance.now(),this.systems.forEach(function(e){e.initialize&&e.initialize()}),requestAnimationFrame(this.gameLoop))}},{key:"stop",value:function(){this.isRunning=!1,this.isPaused=!1,this.systems.forEach(function(e){e.cleanup&&e.cleanup()})}},{key:"pause",value:function(){this.isPaused=!0}},{key:"resume",value:function(){this.isRunning&&(this.isPaused=!1,this.lastTime=performance.now(),requestAnimationFrame(this.gameLoop))}},{key:"gameLoop",value:function(e){if(this.isRunning&&!this.isPaused){var t=this.getSystem("performance");t&&t.startFrame();var i=Math.min(e-this.lastTime,2*this.frameTime);this.lastTime=e,this.update(i/1e3),t&&t.endUpdate(),this.render(),t&&(t.endRender(),t.endFrame()),requestAnimationFrame(this.gameLoop)}}},{key:"update",value:function(e){this.currentScene&&this.currentScene.update&&this.currentScene.update(e),this.systems.forEach(function(t){t.update&&t.update(e)})}},{key:"render",value:function(){var e=this;if(this.getSystem("render"),this.context.clearRect(0,0,this.canvas.width,this.canvas.height),!this.currentScene&&this.scenes.size>0){console.log("No current scene, setting default scene...");var t=this.scenes.values().next().value;this.currentScene=t,this.currentScene.enter&&this.currentScene.enter()}this.currentScene&&this.currentScene.render&&this.currentScene.render(this.context),this.systems.forEach(function(t){t.render&&t.render(e.context)})}},{key:"resize",value:function(e,t){console.log("GameEngine.resize called: ".concat(e,"x").concat(t)),this.systems.forEach(function(i){i.onResize&&i.onResize(e,t)})}}])&&t(e.prototype,i),Object.defineProperty(e,"prototype",{writable:!1}),e;var e,i}();function o(e){return o="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},o(e)}function r(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,a(n.key),n)}}function a(e){var t=function(e){if("object"!=o(e)||!e)return e;var t=e[Symbol.toPrimitive];if(void 0!==t){var i=t.call(e,"string");if("object"!=o(i))return i;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(e)}(e);return"symbol"==o(t)?t:t+""}var s={MENU:"menu",PLAYING:"playing",PAUSED:"paused",GAME_OVER:"game_over",LEADERBOARD:"leaderboard",SETTINGS:"settings"},l=function(){return e=function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.currentState=s.MENU,this.previousState=null,this.stateChangeListeners=new Map},(t=[{key:"changeState",value:function(e){if(!Object.values(s).includes(e))throw new Error("Invalid game state: ".concat(e));this.currentState!==e&&(this.previousState=this.currentState,this.currentState=e,this.notifyStateChange(this.previousState,this.currentState))}},{key:"getCurrentState",value:function(){return this.currentState}},{key:"getPreviousState",value:function(){return this.previousState}},{key:"isState",value:function(e){return this.currentState===e}},{key:"addStateChangeListener",value:function(e,t){this.stateChangeListeners.set(e,t)}},{key:"removeStateChangeListener",value:function(e){this.stateChangeListeners.delete(e)}},{key:"notifyStateChange",value:function(e,t){this.stateChangeListeners.forEach(function(i){try{i(e,t)}catch(e){console.error("State change listener error:",e)}})}},{key:"reset",value:function(){this.currentState=s.MENU,this.previousState=null}}])&&r(e.prototype,t),Object.defineProperty(e,"prototype",{writable:!1}),e;var e,t}();function c(e){return c="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},c(e)}function u(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),i.push.apply(i,n)}return i}function h(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?u(Object(i),!0).forEach(function(t){f(e,t,i[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):u(Object(i)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))})}return e}function f(e,t,i){return(t=p(t))in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}function d(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,p(n.key),n)}}function p(e){var t=function(e){if("object"!=c(e)||!e)return e;var t=e[Symbol.toPrimitive];if(void 0!==t){var i=t.call(e,"string");if("object"!=c(i))return i;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(e)}(e);return"symbol"==c(t)?t:t+""}var y=function(){return e=function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.canvas=t,this.isPressed=!1,this.direction=0,this.startPosition={x:0,y:0},this.currentPosition={x:0,y:0},this.minSwipeDistance=30,this.touchSensitivity=1,this.tapThreshold=10,this.longPressTime=500,this.touchZones={left:{x:0,y:0,width:this.canvas.width/2,height:this.canvas.height},right:{x:this.canvas.width/2,y:0,width:this.canvas.width/2,height:this.canvas.height}},this.touchStartTime=0,this.keys={},this.keysPressed={},this.justTapped=!1,this.justSwiped=!1,this.touchStartHandler=this.handleTouchStart.bind(this),this.touchMoveHandler=this.handleTouchMove.bind(this),this.touchEndHandler=this.handleTouchEnd.bind(this),this.keyDownHandler=this.handleKeyDown.bind(this),this.keyUpHandler=this.handleKeyUp.bind(this),this.bindEvents()},(t=[{key:"bindEvents",value:function(){this.canvas.addEventListener("touchstart",this.touchStartHandler,{passive:!1}),this.canvas.addEventListener("touchmove",this.touchMoveHandler,{passive:!1}),this.canvas.addEventListener("touchend",this.touchEndHandler,{passive:!1}),this.canvas.addEventListener("touchcancel",this.touchEndHandler,{passive:!1}),document.addEventListener("keydown",this.keyDownHandler),document.addEventListener("keyup",this.keyUpHandler),this.canvas.addEventListener("mousedown",this.handleMouseDown.bind(this)),this.canvas.addEventListener("mousemove",this.handleMouseMove.bind(this)),this.canvas.addEventListener("mouseup",this.handleMouseUp.bind(this))}},{key:"unbindEvents",value:function(){this.canvas.removeEventListener("touchstart",this.touchStartHandler),this.canvas.removeEventListener("touchmove",this.touchMoveHandler),this.canvas.removeEventListener("touchend",this.touchEndHandler),this.canvas.removeEventListener("touchcancel",this.touchEndHandler),document.removeEventListener("keydown",this.keyDownHandler),document.removeEventListener("keyup",this.keyUpHandler)}},{key:"handleTouchStart",value:function(e){if(e.preventDefault(),e.touches.length>0){var t=e.touches[0],i=this.canvas.getBoundingClientRect();this.startPosition.x=(t.clientX-i.left)*(this.canvas.width/i.width),this.startPosition.y=(t.clientY-i.top)*(this.canvas.height/i.height),this.currentPosition=h({},this.startPosition),this.isPressed=!0,this.direction=0,this.touchStartTime=Date.now(),this.updateDirectionFromPosition(),console.log("Touch start at:",this.startPosition,"Zone:",this.getTouchZone())}}},{key:"handleTouchMove",value:function(e){if(e.preventDefault(),this.isPressed&&0!==e.touches.length){var t=e.touches[0],i=this.canvas.getBoundingClientRect();this.currentPosition.x=(t.clientX-i.left)*(this.canvas.width/i.width),this.currentPosition.y=(t.clientY-i.top)*(this.canvas.height/i.height);var n=this.currentPosition.x-this.startPosition.x,o=this.currentPosition.y-this.startPosition.y;Math.sqrt(n*n+o*o)>this.minSwipeDistance&&(Math.abs(n)>Math.abs(o)?this.direction=n>0?1:-1:this.direction=0)}}},{key:"handleTouchEnd",value:function(e){var t=this;if(e.preventDefault(),e.changedTouches&&e.changedTouches.length>0){var i=e.changedTouches[0],n=this.canvas.getBoundingClientRect();this.currentPosition.x=i.clientX-n.left,this.currentPosition.y=i.clientY-n.top}this.getSwipeDistance()<this.minSwipeDistance?(this.justTapped=!0,this.justSwiped=!1):(this.justTapped=!1,this.justSwiped=!0),this.isPressed=!1,this.direction=0,setTimeout(function(){t.isPressed||(t.startPosition={x:0,y:0},t.currentPosition={x:0,y:0},t.justTapped=!1,t.justSwiped=!1)},100)}},{key:"handleKeyDown",value:function(e){switch(this.keys[e.code]=!0,this.keysPressed[e.code]=!0,e.code){case"ArrowLeft":case"KeyA":this.direction=-1,this.isPressed=!0,e.preventDefault();break;case"ArrowRight":case"KeyD":this.direction=1,this.isPressed=!0,e.preventDefault();break;case"Enter":case"Space":case"Escape":case"ArrowUp":case"ArrowDown":case"KeyW":case"KeyS":e.preventDefault()}}},{key:"handleKeyUp",value:function(e){switch(this.keys[e.code]=!1,e.code){case"ArrowLeft":case"KeyA":case"ArrowRight":case"KeyD":this.direction=0,this.isPressed=!1,e.preventDefault();break;case"Enter":case"Space":case"Escape":case"ArrowUp":case"ArrowDown":case"KeyW":case"KeyS":e.preventDefault()}}},{key:"handleMouseDown",value:function(e){var t=this.canvas.getBoundingClientRect();this.startPosition.x=e.clientX-t.left,this.startPosition.y=e.clientY-t.top,this.currentPosition=h({},this.startPosition),this.isPressed=!0,this.direction=0}},{key:"handleMouseMove",value:function(e){if(this.isPressed){var t=this.canvas.getBoundingClientRect();this.currentPosition.x=e.clientX-t.left,this.currentPosition.y=e.clientY-t.top;var i=this.currentPosition.x-this.startPosition.x;Math.abs(i)>this.minSwipeDistance?this.direction=i>0?1:-1:this.direction=0}}},{key:"handleMouseUp",value:function(e){var t=this,i=this.canvas.getBoundingClientRect();this.currentPosition.x=e.clientX-i.left,this.currentPosition.y=e.clientY-i.top,this.getSwipeDistance()<this.minSwipeDistance?(this.justTapped=!0,this.justSwiped=!1):(this.justTapped=!1,this.justSwiped=!0),this.isPressed=!1,this.direction=0,setTimeout(function(){t.isPressed||(t.startPosition={x:0,y:0},t.currentPosition={x:0,y:0},t.justTapped=!1,t.justSwiped=!1)},100)}},{key:"getCurrentInput",value:function(){return{isPressed:this.isPressed,direction:this.direction,startPosition:h({},this.startPosition),currentPosition:h({},this.currentPosition),swipeDistance:this.getSwipeDistance(),swipeAngle:this.getSwipeAngle(),isTap:this.isPressed?this.isTap():this.justTapped,isSwipe:this.isPressed?this.isSwipe():this.justSwiped}}},{key:"getSwipeDistance",value:function(){var e=this.currentPosition.x-this.startPosition.x,t=this.currentPosition.y-this.startPosition.y;return Math.sqrt(e*e+t*t)}},{key:"getSwipeAngle",value:function(){var e=this.currentPosition.x-this.startPosition.x,t=this.currentPosition.y-this.startPosition.y;return Math.atan2(t,e)}},{key:"isTap",value:function(){return this.getSwipeDistance()<this.minSwipeDistance}},{key:"isSwipe",value:function(){return this.getSwipeDistance()>=this.minSwipeDistance}},{key:"getTouchZone",value:function(){return this.startPosition.x<this.canvas.width/2?"left":"right"}},{key:"updateDirectionFromPosition",value:function(){var e=this.getTouchZone();this.isTap()&&("left"===e?this.direction=-1:"right"===e&&(this.direction=1))}},{key:"isLongPress",value:function(){return this.isPressed&&Date.now()-this.touchStartTime>this.longPressTime}},{key:"getTouchDuration",value:function(){return this.isPressed?Date.now()-this.touchStartTime:0}},{key:"isMovingLeft",value:function(){return-1===this.direction}},{key:"isMovingRight",value:function(){return 1===this.direction}},{key:"isStopped",value:function(){return 0===this.direction}},{key:"reset",value:function(){this.isPressed=!1,this.direction=0,this.startPosition={x:0,y:0},this.currentPosition={x:0,y:0}}},{key:"setSensitivity",value:function(e){this.touchSensitivity=Math.max(.1,Math.min(2,e))}},{key:"setMinSwipeDistance",value:function(e){this.minSwipeDistance=Math.max(5,e)}},{key:"update",value:function(){this.keysPressed={}}},{key:"isKeyPressed",value:function(e){return!!this.keysPressed[e]}},{key:"isKeyHeld",value:function(e){return!!this.keys[e]}},{key:"onResize",value:function(e,t){console.log("InputManager.onResize called: ".concat(e,"x").concat(t)),this.touchZones={left:{x:0,y:0,width:e/2,height:t},right:{x:e/2,y:0,width:e/2,height:t}},console.log("Updated touch zones:",this.touchZones)}},{key:"cleanup",value:function(){this.unbindEvents()}}])&&d(e.prototype,t),Object.defineProperty(e,"prototype",{writable:!1}),e;var e,t}();function v(e){return v="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},v(e)}function m(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,g(n.key),n)}}function g(e){var t=function(e){if("object"!=v(e)||!e)return e;var t=e[Symbol.toPrimitive];if(void 0!==t){var i=t.call(e,"string");if("object"!=v(i))return i;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(e)}(e);return"symbol"==v(t)?t:t+""}var b=function(){return e=function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.canvas=t,this.context=t.getContext("2d"),this.smoothing=!0,this.frameCount=0,this.lastFPSUpdate=0,this.currentFPS=0,this.renderTime=0,this.layers=new Map,this.layerOrder=[],this.initializeCanvas()},t=[{key:"initializeCanvas",value:function(){this.setupRenderingQuality()}},{key:"setupRenderingQuality",value:function(){this.context.imageSmoothingEnabled=this.smoothing,this.context.imageSmoothingEnabled&&(this.context.imageSmoothingQuality="high"),this.context.textRenderingOptimization="optimizeQuality",this.context.lineCap="round",this.context.lineJoin="round"}},{key:"beginFrame",value:function(){var e=performance.now();return this.clear(),this.context.setTransform(1,0,0,1,0,0),e}},{key:"endFrame",value:function(e){this.renderTime=performance.now()-e,this.updateFPS()}},{key:"clear",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;e?(this.context.fillStyle=e,this.context.fillRect(0,0,this.canvas.width,this.canvas.height)):this.context.clearRect(0,0,this.canvas.width,this.canvas.height)}},{key:"setTransform",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1,o=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0;this.context.setTransform(i*Math.cos(o),i*Math.sin(o),-n*Math.sin(o),n*Math.cos(o),e,t)}},{key:"save",value:function(){this.context.save()}},{key:"restore",value:function(){this.context.restore()}},{key:"setClipRect",value:function(e,t,i,n){this.context.beginPath(),this.context.rect(e,t,i,n),this.context.clip()}},{key:"drawRect",value:function(e,t,i,n){var o=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null,r=arguments.length>5&&void 0!==arguments[5]?arguments[5]:null,a=arguments.length>6&&void 0!==arguments[6]?arguments[6]:1;o&&(this.context.fillStyle=o,this.context.fillRect(e,t,i,n)),r&&(this.context.strokeStyle=r,this.context.lineWidth=a,this.context.strokeRect(e,t,i,n))}},{key:"drawCircle",value:function(e,t,i){var n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,o=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null,r=arguments.length>5&&void 0!==arguments[5]?arguments[5]:1;this.context.beginPath(),this.context.arc(e,t,i,0,2*Math.PI),n&&(this.context.fillStyle=n,this.context.fill()),o&&(this.context.strokeStyle=o,this.context.lineWidth=r,this.context.stroke())}},{key:"drawText",value:function(e,t,i){var n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"16px Arial",o=arguments.length>4&&void 0!==arguments[4]?arguments[4]:"#000000",r=arguments.length>5&&void 0!==arguments[5]?arguments[5]:null,a=arguments.length>6&&void 0!==arguments[6]?arguments[6]:"left",s=arguments.length>7&&void 0!==arguments[7]?arguments[7]:"top";this.context.font=n,this.context.textAlign=a,this.context.textBaseline=s,r&&(this.context.strokeStyle=r,this.context.strokeText(e,t,i)),o&&(this.context.fillStyle=o,this.context.fillText(e,t,i))}},{key:"drawLine",value:function(e,t,i,n){var o=arguments.length>4&&void 0!==arguments[4]?arguments[4]:"#000000",r=arguments.length>5&&void 0!==arguments[5]?arguments[5]:1;this.context.beginPath(),this.context.moveTo(e,t),this.context.lineTo(i,n),this.context.strokeStyle=o,this.context.lineWidth=r,this.context.stroke()}},{key:"drawGradient",value:function(e,t,i,n,o){var r;switch(arguments.length>5&&void 0!==arguments[5]?arguments[5]:"vertical"){case"horizontal":r=this.context.createLinearGradient(e,t,e+i,t);break;case"vertical":default:r=this.context.createLinearGradient(e,t,e,t+n);break;case"radial":r=this.context.createRadialGradient(e+i/2,t+n/2,0,e+i/2,t+n/2,Math.max(i,n)/2)}o.forEach(function(e){r.addColorStop(e.offset,e.color)}),this.context.fillStyle=r,this.context.fillRect(e,t,i,n)}},{key:"updateFPS",value:function(){this.frameCount++;var e=performance.now();e-this.lastFPSUpdate>=1e3&&(this.currentFPS=Math.round(1e3*this.frameCount/(e-this.lastFPSUpdate)),this.frameCount=0,this.lastFPSUpdate=e)}},{key:"getPerformanceInfo",value:function(){return{fps:this.currentFPS,renderTime:this.renderTime,canvasSize:{width:this.canvas.width,height:this.canvas.height}}}},{key:"onResize",value:function(e,t){console.log("RenderManager.onResize called: ".concat(e,"x").concat(t)),this.setupRenderingQuality()}},{key:"resize",value:function(e,t){this.canvas.width=e,this.canvas.height=t,this.canvas.style.width=e+"px",this.canvas.style.height=t+"px",this.setupRenderingQuality()}},{key:"setQuality",value:function(e){this.smoothing=e,this.setupRenderingQuality()}},{key:"getContext",value:function(){return this.context}},{key:"getCanvas",value:function(){return this.canvas}}],t&&m(e.prototype,t),Object.defineProperty(e,"prototype",{writable:!1}),e;var e,t}(),w={canvas:{width:375,height:667,backgroundColor:"#87CEEB",minWidth:320,minHeight:480,maxWidth:480,aspectRatio:9/16},player:{size:{width:32,height:32},moveSpeed:200,jumpHeight:120,jumpVelocity:-400,color:"#FF6B6B",startPosition:{x:187.5,y:627}},physics:{gravity:900,terminalVelocity:1200,airResistance:.99},platforms:{spacing:120,minWidth:60,maxWidth:150,height:20,normalChance:.7,smallChance:.3,slidingChance:0,spikeChance:0,slideSpeed:100,slideRange:150,spikeHeight:15,spikeCount:3},game:{targetFPS:60,speedIncrement:.05,maxSpeedMultiplier:2,initialJumpInterval:.8,minJumpInterval:.3,pointsPerLevel:10,bonusPointsForCombo:5,difficultyIncreaseInterval:10,maxDifficulty:5},ui:{fontSize:{small:14,medium:18,large:24,xlarge:32},responsive:{baseWidth:375,baseHeight:667,minScale:.7,maxScale:1.5},colors:{primary:"#2C3E50",secondary:"#3498DB",success:"#27AE60",warning:"#F39C12",danger:"#E74C3C",text:"#2C3E50",background:"#ECF0F1",overlay:"rgba(0, 0, 0, 0.7)"},padding:{small:8,medium:16,large:24},borderRadius:8,buttonHeight:50},audio:{masterVolume:.7,sfxVolume:.8,musicVolume:.5,sounds:{jump:"assets/sounds/jump.mp3",land:"assets/sounds/land.mp3",death:"assets/sounds/death.mp3",levelUp:"assets/sounds/levelup.mp3",click:"assets/sounds/click.mp3"},music:{background:"assets/music/background.mp3"}},storage:{keys:{highScore:"infiniteJump_highScore",leaderboard:"infiniteJump_leaderboard",settings:"infiniteJump_settings",playerName:"infiniteJump_playerName"},leaderboardSize:10,autoSave:!0},camera:{followSpeed:.3,offsetY:150,smoothing:!0,bounds:{minY:0,maxY:1/0},autoScrollSpeed:40,autoScrollAcceleration:1,maxAutoScrollSpeed:100},particles:{trailParticles:{maxCount:20,lifetime:.3,fadeSpeed:2},jumpParticles:{count:5,lifetime:.5,spread:30},deathParticles:{count:15,lifetime:1,spread:60}},debug:{enabled:!1,showFPS:!1,showCollisionBoxes:!1,showCameraInfo:!1,logLevel:"warn"},mobile:{preventZoom:!0,preventScroll:!0,fullscreen:!0,orientation:"portrait",touchSensitivity:1,minSwipeDistance:20,tapThreshold:10,longPressTime:500},pwa:{name:"無限跳躍",shortName:"Jump Game",description:"挑戰你的極限，看你能跳多高！",themeColor:"#2196F3",backgroundColor:"#ffffff",display:"fullscreen",orientation:"portrait"},analytics:{enabled:!1,trackingId:"",events:{gameStart:"game_start",gameOver:"game_over",levelReached:"level_reached",highScore:"high_score"}}};function S(e,t){var i=w.ui.responsive,n=e/i.baseWidth,o=t/i.baseHeight,r=Math.min(n,o);return Math.max(i.minScale,Math.min(i.maxScale,r))}function k(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1,i=w.ui.fontSize[e]||w.ui.fontSize.medium;return Math.round(i*t)}function x(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1;return Math.round(e*t)}function P(e){return P="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},P(e)}function E(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),i.push.apply(i,n)}return i}function T(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?E(Object(i),!0).forEach(function(t){O(e,t,i[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):E(Object(i)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))})}return e}function O(e,t,i){return(t=C(t))in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}function M(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,C(n.key),n)}}function C(e){var t=function(e){if("object"!=P(e)||!e)return e;var t=e[Symbol.toPrimitive];if(void 0!==t){var i=t.call(e,"string");if("object"!=P(i))return i;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(e)}(e);return"symbol"==P(t)?t:t+""}var A=function(){return e=function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.canvas=t,this.position={x:0,y:0},this.targetPosition={x:0,y:0},this.followSpeed=w.camera.followSpeed,this.offsetY=w.camera.offsetY,this.smoothing=w.camera.smoothing,this.autoScrollSpeed=w.camera.autoScrollSpeed,this.autoScrollAcceleration=w.camera.autoScrollAcceleration,this.maxAutoScrollSpeed=w.camera.maxAutoScrollSpeed,this.currentAutoScrollSpeed=this.autoScrollSpeed,this.bounds={minX:-1/0,maxX:1/0,minY:w.camera.bounds.minY,maxY:w.camera.bounds.maxY},this.shake={intensity:0,duration:0,currentTime:0,offsetX:0,offsetY:0},this.zoom=1,this.targetZoom=1,this.zoomSpeed=.1,this.target=null},t=[{key:"setTarget",value:function(e){this.target=e}},{key:"update",value:function(e){this.updateAutoScroll(e),this.updateFollow(e),this.updateZoom(e),this.updateShake(e),this.applyBounds()}},{key:"updateAutoScroll",value:function(e){this.currentAutoScrollSpeed=Math.min(this.currentAutoScrollSpeed+this.autoScrollAcceleration*e,this.maxAutoScrollSpeed),this.position.y-=this.currentAutoScrollSpeed*e,this.targetPosition.y-=this.currentAutoScrollSpeed*e}},{key:"updateFollow",value:function(e){if(this.target)if(this._forcePositionFrame)this._forcePositionFrame=!1;else if(this.targetPosition.x=this.target.position.x-this.canvas.width/2,this.smoothing){var t=Math.min(this.followSpeed*e*60,1);this.position.x+=(this.targetPosition.x-this.position.x)*t}else this.position.x=this.targetPosition.x}},{key:"updateZoom",value:function(e){if(Math.abs(this.zoom-this.targetZoom)>.01){var t=this.targetZoom-this.zoom;this.zoom+=t*this.zoomSpeed*e*60}}},{key:"updateShake",value:function(e){if(this.shake.duration<=0)return this.shake.offsetX=0,void(this.shake.offsetY=0);if(this.shake.currentTime+=e,this.shake.currentTime>=this.shake.duration)this.shake.duration=0,this.shake.currentTime=0,this.shake.offsetX=0,this.shake.offsetY=0;else{var t=this.shake.currentTime/this.shake.duration,i=this.shake.intensity*(1-t);this.shake.offsetX=(Math.random()-.5)*i*2,this.shake.offsetY=(Math.random()-.5)*i*2}}},{key:"applyBounds",value:function(){this.position.x=Math.max(this.bounds.minX,Math.min(this.bounds.maxX,this.position.x)),this.bounds.maxY!==1/0&&(this.position.y=Math.min(this.bounds.maxY,this.position.y))}},{key:"applyTransform",value:function(e){var t=-(this.position.x+this.shake.offsetX),i=-(this.position.y+this.shake.offsetY);e.save(),e.translate(t,i),e.scale(this.zoom,this.zoom)}},{key:"restoreTransform",value:function(e){e.restore()}},{key:"setPosition",value:function(e,t){this.position.x=e,this.position.y=t,this.targetPosition.x=e,this.targetPosition.y=t}},{key:"forcePosition",value:function(e,t){this.position.x=e,this.position.y=t,this.targetPosition.x=e,this.targetPosition.y=t,this._forcePositionFrame=!0}},{key:"move",value:function(e,t){this.position.x+=e,this.position.y+=t,this.targetPosition.x+=e,this.targetPosition.y+=t}},{key:"setZoom",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];this.targetZoom=Math.max(.1,Math.min(5,e)),t&&(this.zoom=this.targetZoom)}},{key:"startShake",value:function(e,t){this.shake.intensity=e,this.shake.duration=t,this.shake.currentTime=0}},{key:"stopShake",value:function(){this.shake.duration=0,this.shake.currentTime=0,this.shake.offsetX=0,this.shake.offsetY=0}},{key:"setBounds",value:function(e,t,i,n){this.bounds.minX=e,this.bounds.maxX=t,this.bounds.minY=i,this.bounds.maxY=n}},{key:"setFollowSpeed",value:function(e){this.followSpeed=Math.max(.01,Math.min(1,e))}},{key:"setOffsetY",value:function(e){this.offsetY=e}},{key:"setSmoothing",value:function(e){this.smoothing=e}},{key:"worldToScreen",value:function(e,t){return{x:(e-this.position.x-this.shake.offsetX)*this.zoom,y:(t-this.position.y-this.shake.offsetY)*this.zoom}}},{key:"screenToWorld",value:function(e,t){return{x:e/this.zoom+this.position.x+this.shake.offsetX,y:t/this.zoom+this.position.y+this.shake.offsetY}}},{key:"isInView",value:function(e,t,i,n){return e+i>=this.position.x-50&&e<=this.position.x+this.canvas.width+50&&t+n>=this.position.y-50&&t<=this.position.y+this.canvas.height+50}},{key:"getInfo",value:function(){return{position:T({},this.position),targetPosition:T({},this.targetPosition),zoom:this.zoom,targetZoom:this.targetZoom,shake:T({},this.shake),bounds:T({},this.bounds),target:this.target?this.target.constructor.name:null}}},{key:"onResize",value:function(e,t){console.log("CameraSystem.onResize called: ".concat(e,"x").concat(t)),this.target&&this.updateTargetPosition()}},{key:"reset",value:function(){this.position={x:0,y:0},this.targetPosition={x:0,y:0},this.zoom=1,this.targetZoom=1,this.stopShake(),this.target=null,this.currentAutoScrollSpeed=this.autoScrollSpeed}}],t&&M(e.prototype,t),Object.defineProperty(e,"prototype",{writable:!1}),e;var e,t}();function j(e){return j="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},j(e)}function z(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,F(n.key),n)}}function F(e){var t=function(e){if("object"!=j(e)||!e)return e;var t=e[Symbol.toPrimitive];if(void 0!==t){var i=t.call(e,"string");if("object"!=j(i))return i;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(e)}(e);return"symbol"==j(t)?t:t+""}var I=function(){return e=function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.gravity=w.physics.gravity,this.terminalVelocity=w.physics.terminalVelocity,this.airResistance=w.physics.airResistance,this.collisionPairs=[],this.entities=[]},(t=[{key:"initialize",value:function(){console.log("Physics system initialized")}},{key:"update",value:function(e){var t=this;this.entities.forEach(function(i){i.physics&&t.updateEntityPhysics(i,e)}),this.handleCollisions()}},{key:"updateEntityPhysics",value:function(e,t){var i=e.physics;i.affectedByGravity&&(i.velocity.y+=this.gravity*t,i.velocity.y>this.terminalVelocity&&(i.velocity.y=this.terminalVelocity)),i.airResistance&&(i.velocity.x*=Math.pow(this.airResistance,60*t),i.velocity.y*=Math.pow(this.airResistance,60*t)),e.position.x+=i.velocity.x*t,e.position.y+=i.velocity.y*t,this.checkBounds(e)}},{key:"checkBounds",value:function(e){var t=e.physics;t.checkBounds&&(e.position.x<t.bounds.left?(e.position.x=t.bounds.left,t.bounceOnBounds?t.velocity.x=-t.velocity.x*t.bounciness:t.velocity.x=0):e.position.x>t.bounds.right&&(e.position.x=t.bounds.right,t.bounceOnBounds?t.velocity.x=-t.velocity.x*t.bounciness:t.velocity.x=0),e.position.y<t.bounds.top?(e.position.y=t.bounds.top,t.bounceOnBounds?t.velocity.y=-t.velocity.y*t.bounciness:t.velocity.y=0):e.position.y>t.bounds.bottom&&(e.position.y=t.bounds.bottom,t.bounceOnBounds?t.velocity.y=-t.velocity.y*t.bounciness:t.velocity.y=0))}},{key:"handleCollisions",value:function(){this.collisionPairs=[];for(var e=0;e<this.entities.length;e++)for(var t=e+1;t<this.entities.length;t++){var i=this.entities[e],n=this.entities[t];this.checkCollision(i,n)&&(this.collisionPairs.push({entityA:i,entityB:n}),this.resolveCollision(i,n))}}},{key:"checkCollision",value:function(e,t){return!(!e.collider||!t.collider)&&!!this.shouldCollide(e,t)&&this.checkRectCollision(this.getColliderBounds(e),this.getColliderBounds(t))}},{key:"shouldCollide",value:function(e,t){var i=e.collider.layer||0,n=t.collider.layer||0,o=e.collider.mask||4294967295;return 0!==(i&(t.collider.mask||4294967295))&&0!==(n&o)}},{key:"getColliderBounds",value:function(e){var t=e.collider,i=t.offset?t.offset.x:0,n=t.offset?t.offset.y:0;return{x:e.position.x+i-t.width/2,y:e.position.y+n-t.height/2,width:t.width,height:t.height}}},{key:"checkRectCollision",value:function(e,t){return e.x<t.x+t.width&&e.x+e.width>t.x&&e.y<t.y+t.height&&e.y+e.height>t.y}},{key:"resolveCollision",value:function(e,t){e.onCollision&&e.onCollision(t),t.onCollision&&t.onCollision(e),e.physics&&t.physics&&this.resolvePhysicsCollision(e,t)}},{key:"resolvePhysicsCollision",value:function(e,t){var i=this.getColliderBounds(e),n=this.getColliderBounds(t),o=Math.min(i.x+i.width,n.x+n.width)-Math.max(i.x,n.x),r=Math.min(i.y+i.height,n.y+n.height)-Math.max(i.y,n.y);if(o<r){var a=o/2;i.x<n.x?(e.position.x-=a,t.position.x+=a):(e.position.x+=a,t.position.x-=a);var s=e.physics.velocity.x;e.physics.velocity.x=t.physics.velocity.x*e.physics.bounciness,t.physics.velocity.x=s*t.physics.bounciness}else{var l=r/2;i.y<n.y?(e.position.y-=l,t.position.y+=l):(e.position.y+=l,t.position.y-=l);var c=e.physics.velocity.y;e.physics.velocity.y=t.physics.velocity.y*e.physics.bounciness,t.physics.velocity.y=c*t.physics.bounciness}}},{key:"addEntity",value:function(e){this.entities.includes(e)||this.entities.push(e)}},{key:"removeEntity",value:function(e){var t=this.entities.indexOf(e);t>-1&&this.entities.splice(t,1)}},{key:"clearEntities",value:function(){this.entities=[],this.collisionPairs=[]}},{key:"setGravity",value:function(e){this.gravity=e}},{key:"setTerminalVelocity",value:function(e){this.terminalVelocity=e}},{key:"setAirResistance",value:function(e){this.airResistance=e}},{key:"getCollisionPairs",value:function(){return this.collisionPairs}},{key:"cleanup",value:function(){this.clearEntities()}}])&&z(e.prototype,t),Object.defineProperty(e,"prototype",{writable:!1}),e;var e,t}();function B(e){return B="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},B(e)}function R(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),i.push.apply(i,n)}return i}function D(e,t,i){return(t=U(t))in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}function L(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){var i=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=i){var n,o,r,a,s=[],l=!0,c=!1;try{if(r=(i=i.call(e)).next,0===t){if(Object(i)!==i)return;l=!1}else for(;!(l=(n=r.call(i)).done)&&(s.push(n.value),s.length!==t);l=!0);}catch(e){c=!0,o=e}finally{try{if(!l&&null!=i.return&&(a=i.return(),Object(a)!==a))return}finally{if(c)throw o}}return s}}(e,t)||function(e,t){if(e){if("string"==typeof e)return W(e,t);var i={}.toString.call(e).slice(8,-1);return"Object"===i&&e.constructor&&(i=e.constructor.name),"Map"===i||"Set"===i?Array.from(e):"Arguments"===i||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(i)?W(e,t):void 0}}(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function W(e,t){(null==t||t>e.length)&&(t=e.length);for(var i=0,n=Array(t);i<t;i++)n[i]=e[i];return n}function G(){var e,t,i="function"==typeof Symbol?Symbol:{},n=i.iterator||"@@iterator",o=i.toStringTag||"@@toStringTag";function r(i,n,o,r){var l=n&&n.prototype instanceof s?n:s,c=Object.create(l.prototype);return Y(c,"_invoke",function(i,n,o){var r,s,l,c=0,u=o||[],h=!1,f={p:0,n:0,v:e,a:d,f:d.bind(e,4),d:function(t,i){return r=t,s=0,l=e,f.n=i,a}};function d(i,n){for(s=i,l=n,t=0;!h&&c&&!o&&t<u.length;t++){var o,r=u[t],d=f.p,p=r[2];i>3?(o=p===n)&&(l=r[(s=r[4])?5:(s=3,3)],r[4]=r[5]=e):r[0]<=d&&((o=i<2&&d<r[1])?(s=0,f.v=n,f.n=r[1]):d<p&&(o=i<3||r[0]>n||n>p)&&(r[4]=i,r[5]=n,f.n=p,s=0))}if(o||i>1)return a;throw h=!0,n}return function(o,u,p){if(c>1)throw TypeError("Generator is already running");for(h&&1===u&&d(u,p),s=u,l=p;(t=s<2?e:l)||!h;){r||(s?s<3?(s>1&&(f.n=-1),d(s,l)):f.n=l:f.v=l);try{if(c=2,r){if(s||(o="next"),t=r[o]){if(!(t=t.call(r,l)))throw TypeError("iterator result is not an object");if(!t.done)return t;l=t.value,s<2&&(s=0)}else 1===s&&(t=r.return)&&t.call(r),s<2&&(l=TypeError("The iterator does not provide a '"+o+"' method"),s=1);r=e}else if((t=(h=f.n<0)?l:i.call(n,f))!==a)break}catch(t){r=e,s=1,l=t}finally{c=1}}return{value:t,done:h}}}(i,o,r),!0),c}var a={};function s(){}function l(){}function c(){}t=Object.getPrototypeOf;var u=[][n]?t(t([][n]())):(Y(t={},n,function(){return this}),t),h=c.prototype=s.prototype=Object.create(u);function f(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,c):(e.__proto__=c,Y(e,o,"GeneratorFunction")),e.prototype=Object.create(h),e}return l.prototype=c,Y(h,"constructor",c),Y(c,"constructor",l),l.displayName="GeneratorFunction",Y(c,o,"GeneratorFunction"),Y(h),Y(h,o,"Generator"),Y(h,n,function(){return this}),Y(h,"toString",function(){return"[object Generator]"}),(G=function(){return{w:r,m:f}})()}function Y(e,t,i,n){var o=Object.defineProperty;try{o({},"",{})}catch(e){o=0}Y=function(e,t,i,n){function r(t,i){Y(e,t,function(e){return this._invoke(t,i,e)})}t?o?o(e,t,{value:i,enumerable:!n,configurable:!n,writable:!n}):e[t]=i:(r("next",0),r("throw",1),r("return",2))},Y(e,t,i,n)}function N(e,t,i,n,o,r,a){try{var s=e[r](a),l=s.value}catch(e){return void i(e)}s.done?t(l):Promise.resolve(l).then(n,o)}function V(e){return function(){var t=this,i=arguments;return new Promise(function(n,o){var r=e.apply(t,i);function a(e){N(r,n,o,a,s,"next",e)}function s(e){N(r,n,o,a,s,"throw",e)}a(void 0)})}}function _(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,U(n.key),n)}}function U(e){var t=function(e){if("object"!=B(e)||!e)return e;var t=e[Symbol.toPrimitive];if(void 0!==t){var i=t.call(e,"string");if("object"!=B(i))return i;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(e)}(e);return"symbol"==B(t)?t:t+""}var H=function(){return e=function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.audioContext=null,this.isInitialized=!1,this.audioBuffers=new Map,this.settings={masterVolume:1,sfxVolume:.8,musicVolume:.6,enabled:!0},this.activeSources=new Set,this.backgroundMusic=null,this.musicSource=null,this.audioFiles={jump:"./assets/audio/jump.wav",land:"./assets/audio/land.wav",gameOver:"./assets/audio/game-over.wav",backgroundMusic:"./assets/audio/background.wav"},this.initializeAudioContext()},t=[{key:"initializeAudioContext",value:function(){try{var e=window.AudioContext||window.webkitAudioContext;if(!e)return void console.warn("Web Audio API not supported");this.audioContext=new e,console.log("AudioContext initialized successfully"),this.handleAutoplayPolicy()}catch(e){console.error("Failed to initialize AudioContext:",e)}}},{key:"handleAutoplayPolicy",value:function(){var e=this;if(this.audioContext){var t=function(){"suspended"===e.audioContext.state?e.audioContext.resume().then(function(){console.log("AudioContext resumed"),e.isInitialized=!0}):e.isInitialized=!0,document.removeEventListener("touchstart",t),document.removeEventListener("click",t)};document.addEventListener("touchstart",t,{once:!0}),document.addEventListener("click",t,{once:!0}),"running"===this.audioContext.state&&(this.isInitialized=!0)}}},{key:"loadAudio",value:(n=V(G().m(function e(t,i){var n,o,r,a;return G().w(function(e){for(;;)switch(e.p=e.n){case 0:if(this.audioContext){e.n=1;break}return console.warn("AudioContext not available"),e.a(2);case 1:return e.p=1,e.n=2,fetch(i);case 2:return n=e.v,e.n=3,n.arrayBuffer();case 3:return o=e.v,e.n=4,this.audioContext.decodeAudioData(o);case 4:r=e.v,this.audioBuffers.set(t,r),console.log("Audio loaded: ".concat(t)),e.n=6;break;case 5:e.p=5,a=e.v,console.error("Failed to load audio ".concat(t,":"),a);case 6:return e.a(2)}},e,this,[[1,5]])})),function(e,t){return n.apply(this,arguments)})},{key:"loadAllAudio",value:(i=V(G().m(function e(){var t,i,n=this;return G().w(function(e){for(;;)switch(e.p=e.n){case 0:return t=Object.entries(this.audioFiles).map(function(e){var t=L(e,2),i=t[0],o=t[1];return n.loadAudio(i,o)}),e.p=1,e.n=2,Promise.all(t);case 2:console.log("All audio files loaded"),e.n=4;break;case 3:e.p=3,i=e.v,console.error("Failed to load some audio files:",i);case 4:return e.a(2)}},e,this,[[1,3]])})),function(){return i.apply(this,arguments)})},{key:"playSound",value:function(e){var t=this,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(!this.isInitialized||!this.settings.enabled||!this.audioContext)return null;var n=this.audioBuffers.get(e);if(!n)return console.warn("Audio not found: ".concat(e)),null;try{var o=this.audioContext.createBufferSource();o.buffer=n;var r=this.audioContext.createGain(),a=(i.volume||1)*this.settings.sfxVolume*this.settings.masterVolume;return r.gain.setValueAtTime(a,this.audioContext.currentTime),o.connect(r),r.connect(this.audioContext.destination),i.loop&&(o.loop=!0),i.playbackRate&&o.playbackRate.setValueAtTime(i.playbackRate,this.audioContext.currentTime),o.start(0),this.activeSources.add(o),o.onended=function(){t.activeSources.delete(o)},o}catch(t){return console.error("Failed to play sound ".concat(e,":"),t),null}}},{key:"playBackgroundMusic",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"backgroundMusic",t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(this.isInitialized&&this.settings.enabled&&this.audioContext){this.stopBackgroundMusic();var i=this.audioBuffers.get(e);if(i)try{this.musicSource=this.audioContext.createBufferSource(),this.musicSource.buffer=i,this.musicSource.loop=!0;var n=this.audioContext.createGain(),o=(t.volume||1)*this.settings.musicVolume*this.settings.masterVolume;n.gain.setValueAtTime(o,this.audioContext.currentTime),this.musicSource.connect(n),n.connect(this.audioContext.destination),this.musicSource.start(0),this.backgroundMusic=n,console.log("Background music started: ".concat(e))}catch(t){console.error("Failed to play background music ".concat(e,":"),t)}else console.warn("Background music not found: ".concat(e))}}},{key:"stopBackgroundMusic",value:function(){if(this.musicSource){try{this.musicSource.stop()}catch(e){}this.musicSource=null,this.backgroundMusic=null}}},{key:"stopAllSounds",value:function(){this.activeSources.forEach(function(e){try{e.stop()}catch(e){}}),this.activeSources.clear(),this.stopBackgroundMusic()}},{key:"setMasterVolume",value:function(e){this.settings.masterVolume=Math.max(0,Math.min(1,e))}},{key:"setSfxVolume",value:function(e){this.settings.sfxVolume=Math.max(0,Math.min(1,e))}},{key:"setMusicVolume",value:function(e){if(this.settings.musicVolume=Math.max(0,Math.min(1,e)),this.backgroundMusic){var t=this.settings.musicVolume*this.settings.masterVolume;this.backgroundMusic.gain.setValueAtTime(t,this.audioContext.currentTime)}}},{key:"setEnabled",value:function(e){this.settings.enabled=e,e||this.stopAllSounds()}},{key:"getSettings",value:function(){return function(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?R(Object(i),!0).forEach(function(t){D(e,t,i[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):R(Object(i)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))})}return e}({},this.settings)}},{key:"isAvailable",value:function(){return this.isInitialized&&this.audioContext&&this.settings.enabled}},{key:"destroy",value:function(){this.stopAllSounds(),this.audioContext&&(this.audioContext.close(),this.audioContext=null),this.audioBuffers.clear(),this.activeSources.clear(),this.isInitialized=!1}}],t&&_(e.prototype,t),Object.defineProperty(e,"prototype",{writable:!1}),e;var e,t,i,n}();function K(e){return K="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},K(e)}function X(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),i.push.apply(i,n)}return i}function q(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?X(Object(i),!0).forEach(function(t){J(e,t,i[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):X(Object(i)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))})}return e}function J(e,t,i){return(t=Q(t))in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}function Z(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,Q(n.key),n)}}function Q(e){var t=function(e){if("object"!=K(e)||!e)return e;var t=e[Symbol.toPrimitive];if(void 0!==t){var i=t.call(e,"string");if("object"!=K(i))return i;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(e)}(e);return"symbol"==K(t)?t:t+""}var $=function(){return e=function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.screenInfo={width:0,height:0,devicePixelRatio:1,orientation:"portrait",isTouch:!1,isMobile:!1,isTablet:!1,isDesktop:!1},this.responsive={scale:1,baseWidth:w.ui.responsive.baseWidth,baseHeight:w.ui.responsive.baseHeight,breakpoints:{mobile:480,tablet:768,desktop:1024}},this.touchAreas={minTouchSize:44,padding:8},this.resizeListeners=[],this.orientationListeners=[],this.initialize()},t=[{key:"initialize",value:function(){this.detectDevice(),this.updateScreenInfo(),this.calculateResponsiveValues(),this.setupEventListeners(),console.log("ResponsiveManager initialized:",this.screenInfo)}},{key:"detectDevice",value:function(){var e=navigator.userAgent.toLowerCase(),t=window.innerWidth;this.screenInfo.isTouch="ontouchstart"in window||navigator.maxTouchPoints>0,this.screenInfo.isMobile=/mobile|android|iphone|ipod|blackberry|iemobile|opera mini/i.test(e)||this.screenInfo.isTouch&&t<this.responsive.breakpoints.tablet,this.screenInfo.isTablet=/tablet|ipad/i.test(e)||this.screenInfo.isTouch&&t>=this.responsive.breakpoints.tablet&&t<this.responsive.breakpoints.desktop,this.screenInfo.isDesktop=!this.screenInfo.isMobile&&!this.screenInfo.isTablet,console.log("Device detected:",{mobile:this.screenInfo.isMobile,tablet:this.screenInfo.isTablet,desktop:this.screenInfo.isDesktop,touch:this.screenInfo.isTouch})}},{key:"updateScreenInfo",value:function(){this.screenInfo.width=window.innerWidth,this.screenInfo.height=window.innerHeight,this.screenInfo.devicePixelRatio=window.devicePixelRatio||1,this.screenInfo.width>this.screenInfo.height?this.screenInfo.orientation="landscape":this.screenInfo.orientation="portrait",console.log("Screen info updated:",this.screenInfo)}},{key:"calculateResponsiveValues",value:function(){this.responsive.scale=S(this.screenInfo.width,this.screenInfo.height),this.updateGameConfig(),console.log("Responsive values calculated:",{scale:this.responsive.scale,gameWidth:w.canvas.width,gameHeight:w.canvas.height})}},{key:"updateGameConfig",value:function(){w.canvas.width=this.screenInfo.width,w.canvas.height=this.screenInfo.height,w.canvas.scale=this.responsive.scale,w.player.startPosition.x=this.screenInfo.width/2,w.player.startPosition.y=this.screenInfo.height-60,this.screenInfo.isMobile?this.adjustForMobile():this.screenInfo.isTablet?this.adjustForTablet():this.adjustForDesktop()}},{key:"adjustForMobile",value:function(){w.mobile.touchSensitivity=1.2,w.mobile.minSwipeDistance=15,w.ui.buttonHeight=Math.max(44,x(50,this.responsive.scale)),w.ui.fontSize.small=k("small",this.responsive.scale),w.ui.fontSize.medium=k("medium",this.responsive.scale),w.ui.fontSize.large=k("large",this.responsive.scale);var e=Math.max(.8,this.responsive.scale);w.player.size.width=x(32,e),w.player.size.height=x(32,e),console.log("Adjusted for mobile device")}},{key:"adjustForTablet",value:function(){w.mobile.touchSensitivity=1,w.mobile.minSwipeDistance=20,w.ui.buttonHeight=x(55,this.responsive.scale),w.player.size.width=x(36,this.responsive.scale),w.player.size.height=x(36,this.responsive.scale),console.log("Adjusted for tablet device")}},{key:"adjustForDesktop",value:function(){w.mobile.touchSensitivity=.8,w.ui.buttonHeight=x(45,this.responsive.scale),w.player.size.width=x(40,this.responsive.scale),w.player.size.height=x(40,this.responsive.scale),console.log("Adjusted for desktop device")}},{key:"setupEventListeners",value:function(){window.addEventListener("resize",this.handleResize.bind(this)),window.addEventListener("orientationchange",this.handleOrientationChange.bind(this)),window.visualViewport&&window.visualViewport.addEventListener("resize",this.handleVisualViewportResize.bind(this))}},{key:"handleResize",value:function(){var e=this;console.log("Window resize detected"),clearTimeout(this.resizeTimeout),this.resizeTimeout=setTimeout(function(){e.updateScreenInfo(),e.calculateResponsiveValues(),e.notifyResizeListeners()},100)}},{key:"handleOrientationChange",value:function(){var e=this;console.log("Orientation change detected"),setTimeout(function(){e.updateScreenInfo(),e.calculateResponsiveValues(),e.notifyOrientationListeners()},300)}},{key:"handleVisualViewportResize",value:function(){if(console.log("Visual viewport resize detected"),window.visualViewport){var e=window.visualViewport,t=window.innerHeight-e.height;t>100?this.handleVirtualKeyboard(t):this.handleVirtualKeyboardHidden()}}},{key:"handleVirtualKeyboard",value:function(e){console.log("Virtual keyboard shown, height:",e);var t=this.screenInfo.height-e;this.notifyResizeListeners({type:"keyboard-shown",keyboardHeight:e,availableHeight:t})}},{key:"handleVirtualKeyboardHidden",value:function(){console.log("Virtual keyboard hidden"),this.notifyResizeListeners({type:"keyboard-hidden"})}},{key:"addResizeListener",value:function(e){this.resizeListeners.push(e)}},{key:"removeResizeListener",value:function(e){var t=this.resizeListeners.indexOf(e);t>-1&&this.resizeListeners.splice(t,1)}},{key:"addOrientationListener",value:function(e){this.orientationListeners.push(e)}},{key:"removeOrientationListener",value:function(e){var t=this.orientationListeners.indexOf(e);t>-1&&this.orientationListeners.splice(t,1)}},{key:"notifyResizeListeners",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=q({screenInfo:this.screenInfo,responsive:this.responsive},e);this.resizeListeners.forEach(function(e){try{e(t)}catch(e){console.error("Error in resize listener:",e)}})}},{key:"notifyOrientationListeners",value:function(){var e={screenInfo:this.screenInfo,responsive:this.responsive};this.orientationListeners.forEach(function(t){try{t(e)}catch(e){console.error("Error in orientation listener:",e)}})}},{key:"getTouchAreaSize",value:function(e){var t=x(e,this.responsive.scale);return Math.max(this.touchAreas.minTouchSize,t)}},{key:"getResponsivePadding",value:function(e){return x(w.ui.padding[e]||w.ui.padding.medium,this.responsive.scale)}},{key:"isPortrait",value:function(){return"portrait"===this.screenInfo.orientation}},{key:"isLandscape",value:function(){return"landscape"===this.screenInfo.orientation}},{key:"getSafeArea",value:function(){var e=this.getCSSEnvValue("safe-area-inset-top")||0,t=this.getCSSEnvValue("safe-area-inset-bottom")||0,i=this.getCSSEnvValue("safe-area-inset-left")||0,n=this.getCSSEnvValue("safe-area-inset-right")||0;return{top:e,bottom:t,left:i,right:n,width:this.screenInfo.width-i-n,height:this.screenInfo.height-e-t}}},{key:"getCSSEnvValue",value:function(e){try{var t=getComputedStyle(document.documentElement).getPropertyValue("env(".concat(e,")"));return t?parseInt(t,10):0}catch(e){return 0}}},{key:"recalculate",value:function(){this.detectDevice(),this.updateScreenInfo(),this.calculateResponsiveValues(),this.notifyResizeListeners({type:"manual-recalculate"})}},{key:"getInfo",value:function(){return{screenInfo:q({},this.screenInfo),responsive:q({},this.responsive),safeArea:this.getSafeArea()}}},{key:"destroy",value:function(){window.removeEventListener("resize",this.handleResize.bind(this)),window.removeEventListener("orientationchange",this.handleOrientationChange.bind(this)),window.visualViewport&&window.visualViewport.removeEventListener("resize",this.handleVisualViewportResize.bind(this)),this.resizeTimeout&&clearTimeout(this.resizeTimeout),this.resizeListeners=[],this.orientationListeners=[],console.log("ResponsiveManager destroyed")}}],t&&Z(e.prototype,t),Object.defineProperty(e,"prototype",{writable:!1}),e;var e,t}();function ee(e){return ee="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},ee(e)}function te(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),i.push.apply(i,n)}return i}function ie(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?te(Object(i),!0).forEach(function(t){ne(e,t,i[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):te(Object(i)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))})}return e}function ne(e,t,i){return(t=re(t))in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}function oe(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,re(n.key),n)}}function re(e){var t=function(e){if("object"!=ee(e)||!e)return e;var t=e[Symbol.toPrimitive];if(void 0!==t){var i=t.call(e,"string");if("object"!=ee(i))return i;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(e)}(e);return"symbol"==ee(t)?t:t+""}var ae=function(){return e=function e(t,i){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.responsiveManager=t,this.inputManager=i,this.optimizations={touch:{preventZoom:!0,preventScroll:!0,preventContextMenu:!0,enableFastClick:!0},performance:{reducedAnimations:!1,lowQualityMode:!1,frameRateLimit:60},ui:{largerButtons:!0,simplifiedInterface:!1,hideAddressBar:!0},battery:{enablePowerSaving:!1,reducedEffects:!1}},this.gestures={tap:{enabled:!0,threshold:10,timeout:300},swipe:{enabled:!0,minDistance:30,maxTime:1e3},hold:{enabled:!0,duration:500}},this.virtualControls={enabled:!1,leftButton:null,rightButton:null,jumpButton:null},this.initialize()},(t=[{key:"initialize",value:function(){this.isMobileDevice()&&(console.log("Initializing mobile optimizations..."),console.log("Mobile optimizations initialized"))}},{key:"isMobileDevice",value:function(){return this.responsiveManager&&(this.responsiveManager.screenInfo.isMobile||this.responsiveManager.screenInfo.isTablet)}},{key:"getOptimizations",value:function(){return ie({},this.optimizations)}},{key:"updateOptimizations",value:function(e){this.optimizations=ie(ie({},this.optimizations),e),this.initialize()}},{key:"destroy",value:function(){console.log("MobileOptimizer destroyed")}}])&&oe(e.prototype,t),Object.defineProperty(e,"prototype",{writable:!1}),e;var e,t}();function se(e){return se="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},se(e)}function le(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch(e){}return(le=function(){return!!e})()}function ce(e){return ce=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(e){return e.__proto__||Object.getPrototypeOf(e)},ce(e)}function ue(e,t){return ue=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e},ue(e,t)}function he(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function fe(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,pe(n.key),n)}}function de(e,t,i){return t&&fe(e.prototype,t),i&&fe(e,i),Object.defineProperty(e,"prototype",{writable:!1}),e}function pe(e){var t=function(e){if("object"!=se(e)||!e)return e;var t=e[Symbol.toPrimitive];if(void 0!==t){var i=t.call(e,"string");if("object"!=se(i))return i;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(e)}(e);return"symbol"==se(t)?t:t+""}var ye=function(e){function t(e){var i,n,o,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:20;return he(this,t),i=this,o=[function(){return new e(0,0,100,20)},function(e){e.x=0,e.y=0,e.width=100,e.height=20,e.velocity={x:0,y:0},e.isActive=!1,e.type="normal",e.reset&&e.reset()},r],n=ce(n=t),function(e,t){if(t&&("object"==se(t)||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e)}(i,le()?Reflect.construct(n,o||[],ce(i).constructor):n.apply(i,o))}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&ue(e,t)}(t,e),de(t,[{key:"acquirePlatform",value:function(e,t,i,n,o){var r=this.acquire();return r.x=t,r.y=i,r.width=n,r.height=o,r.type=e,r.isActive=!0,r}}])}(function(){return de(function e(t,i){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:10;he(this,e),this.createFn=t,this.resetFn=i,this.pool=[],this.active=new Set;for(var o=0;o<n;o++)this.pool.push(this.createFn());console.log("ObjectPool initialized with ".concat(n," objects"))},[{key:"acquire",value:function(){var e;return this.pool.length>0?e=this.pool.pop():(e=this.createFn(),console.log("ObjectPool: Created new object (pool exhausted)")),this.active.add(e),e}},{key:"release",value:function(e){this.active.has(e)?(this.active.delete(e),this.resetFn&&this.resetFn(e),this.pool.push(e)):console.warn("ObjectPool: Attempting to release object not from this pool")}},{key:"releaseAll",value:function(e){var t=this;e.forEach(function(e){return t.release(e)})}},{key:"clear",value:function(){this.pool.length=0,this.active.clear()}},{key:"getStats",value:function(){return{poolSize:this.pool.length,activeCount:this.active.size,totalCreated:this.pool.length+this.active.size}}},{key:"warmUp",value:function(e){for(var t=0;t<e;t++)this.pool.push(this.createFn());console.log("ObjectPool: Warmed up with ".concat(e," additional objects"))}},{key:"shrink",value:function(e){if(this.pool.length>e){var t=this.pool.length-e;this.pool.splice(e,t),console.log("ObjectPool: Shrunk by ".concat(t," objects"))}}}])}()),ve=new(function(){return de(function e(){he(this,e),this.pools=new Map,this.stats={totalAcquired:0,totalReleased:0,peakMemoryUsage:0}},[{key:"registerPool",value:function(e,t){this.pools.set(e,t),console.log("PoolManager: Registered pool '".concat(e,"'"))}},{key:"getPool",value:function(e){return this.pools.get(e)}},{key:"acquire",value:function(e){var t=this.pools.get(e);if(!t)throw new Error("Pool '".concat(e,"' not found"));return this.stats.totalAcquired++,t.acquire()}},{key:"release",value:function(e,t){var i=this.pools.get(e);if(!i)throw new Error("Pool '".concat(e,"' not found"));this.stats.totalReleased++,i.release(t)}},{key:"clearAll",value:function(){this.pools.forEach(function(e,t){e.clear(),console.log("PoolManager: Cleared pool '".concat(t,"'"))})}},{key:"getAllStats",value:function(){var e={},t=0,i=0;return this.pools.forEach(function(n,o){var r=n.getStats();e[o]=r,t+=r.activeCount,i+=r.poolSize}),{pools:e,global:{totalActive:t,totalPooled:i,totalAcquired:this.stats.totalAcquired,totalReleased:this.stats.totalReleased,memoryEfficiency:this.stats.totalReleased/Math.max(this.stats.totalAcquired,1)}}}},{key:"optimize",value:function(){this.pools.forEach(function(e,t){var i=e.getStats();if(i.poolSize>3*i.activeCount&&i.poolSize>10){var n=Math.max(2*i.activeCount,5);e.shrink(n),console.log("PoolManager: Optimized pool '".concat(t,"' to size ").concat(n))}})}},{key:"warmUpAll",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1.5;this.pools.forEach(function(t,i){var n=t.getStats(),o=Math.floor(n.activeCount*e);o>0&&(t.warmUp(o),console.log("PoolManager: Warmed up pool '".concat(i,"' with ").concat(o," objects")))})}},{key:"destroy",value:function(){this.clearAll(),this.pools.clear(),console.log("PoolManager destroyed")}}])}());function me(e){return me="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},me(e)}function ge(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,be(n.key),n)}}function be(e){var t=function(e){if("object"!=me(e)||!e)return e;var t=e[Symbol.toPrimitive];if(void 0!==t){var i=t.call(e,"string");if("object"!=me(i))return i;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(e)}(e);return"symbol"==me(t)?t:t+""}var we=function(){return e=function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.isEnabled=!0,this.metrics={fps:{current:0,average:0,min:1/0,max:0,history:[]},frameTime:{current:0,average:0,min:1/0,max:0,history:[]},memory:{used:0,total:0,peak:0,history:[]},renderTime:{current:0,average:0,history:[]},updateTime:{current:0,average:0,history:[]}},this.thresholds={fps:{good:55,warning:45,critical:30},frameTime:{good:16.67,warning:22.22,critical:33.33},memory:{warning:52428800,critical:104857600}},this.historySize=60,this.lastFrameTime=performance.now(),this.frameCount=0,this.startTime=performance.now(),this.onPerformanceWarning=null,this.onPerformanceCritical=null,this.autoOptimize={enabled:!1,fpsThreshold:45,memoryThreshold:83886080},console.log("PerformanceMonitor initialized")},t=[{key:"startFrame",value:function(){this.isEnabled&&(this.frameStartTime=performance.now(),this.updateStartTime=this.frameStartTime)}},{key:"endUpdate",value:function(){if(this.isEnabled){var e=performance.now()-this.updateStartTime;this.updateMetric("updateTime",e),this.renderStartTime=performance.now()}}},{key:"endRender",value:function(){if(this.isEnabled){var e=performance.now()-this.renderStartTime;this.updateMetric("renderTime",e)}}},{key:"endFrame",value:function(){if(this.isEnabled){var e=performance.now(),t=e-this.frameStartTime,i=1e3/(e-this.lastFrameTime);this.updateMetric("fps",i),this.updateMetric("frameTime",t),this.updateMemoryMetrics(),this.lastFrameTime=e,this.frameCount++,this.checkPerformanceThresholds(),this.autoOptimize.enabled&&this.checkAutoOptimize()}}},{key:"updateMetric",value:function(e,t){var i=this.metrics[e];i&&(i.current=t,i.history.push(t),i.history.length>this.historySize&&i.history.shift(),i.min=Math.min(i.min,t),i.max=Math.max(i.max,t),i.average=i.history.reduce(function(e,t){return e+t},0)/i.history.length)}},{key:"updateMemoryMetrics",value:function(){if(performance.memory){var e=performance.memory,t=e.usedJSHeapSize||0,i=e.totalJSHeapSize||0;this.metrics.memory.used=t,this.metrics.memory.total=i,this.metrics.memory.peak=Math.max(this.metrics.memory.peak,t),this.metrics.memory.history.push(t),this.metrics.memory.history.length>this.historySize&&this.metrics.memory.history.shift()}}},{key:"checkPerformanceThresholds",value:function(){var e=this.metrics.fps.current,t=this.metrics.memory.used;e<this.thresholds.fps.critical?this.triggerPerformanceAlert("critical","fps",e):e<this.thresholds.fps.warning&&this.triggerPerformanceAlert("warning","fps",e),t>this.thresholds.memory.critical?this.triggerPerformanceAlert("critical","memory",t):t>this.thresholds.memory.warning&&this.triggerPerformanceAlert("warning","memory",t)}},{key:"triggerPerformanceAlert",value:function(e,t,i){var n={level:e,metric:t,value:i,timestamp:Date.now(),suggestions:this.getOptimizationSuggestions(t,e)};console.warn("Performance ".concat(e,": ").concat(t," = ").concat(i),n.suggestions),"critical"===e&&this.onPerformanceCritical?this.onPerformanceCritical(n):"warning"===e&&this.onPerformanceWarning&&this.onPerformanceWarning(n)}},{key:"getOptimizationSuggestions",value:function(e,t){var i=[];switch(e){case"fps":i.push("減少同時渲染的對象數量"),i.push("啟用對象池以減少垃圾回收"),i.push("降低粒子效果品質"),"critical"===t&&(i.push("啟用低品質模式"),i.push("減少動畫效果"));break;case"memory":i.push("清理未使用的對象"),i.push("啟用對象池"),i.push("減少紋理快取"),"critical"===t&&(i.push("強制垃圾回收"),i.push("重新載入遊戲"))}return i}},{key:"checkAutoOptimize",value:function(){var e=this.metrics.fps.average||this.metrics.fps.current,t=this.metrics.memory.used;(e<this.autoOptimize.fpsThreshold||t>this.autoOptimize.memoryThreshold)&&this.applyAutoOptimizations()}},{key:"applyAutoOptimizations",value:function(){console.log("Applying automatic performance optimizations..."),"undefined"!=typeof document&&document.dispatchEvent(new CustomEvent("autoOptimize",{detail:{fps:this.metrics.fps.average,memory:this.metrics.memory.used,suggestions:this.getOptimizationSuggestions("fps","warning")}}))}},{key:"getPerformanceReport",value:function(){return{runtime:performance.now()-this.startTime,frameCount:this.frameCount,averageFPS:this.metrics.fps.average,minFPS:this.metrics.fps.min,maxFPS:this.metrics.fps.max,averageFrameTime:this.metrics.frameTime.average,averageUpdateTime:this.metrics.updateTime.average,averageRenderTime:this.metrics.renderTime.average,memoryUsage:{current:this.metrics.memory.used,peak:this.metrics.memory.peak,total:this.metrics.memory.total},performanceGrade:this.calculatePerformanceGrade()}}},{key:"calculatePerformanceGrade",value:function(){var e=this.metrics.fps.current||this.metrics.fps.average;return e>=this.thresholds.fps.good?"A":e>=this.thresholds.fps.warning?"B":e>=this.thresholds.fps.critical?"C":"D"}},{key:"reset",value:function(){var e=this;Object.keys(this.metrics).forEach(function(t){var i=e.metrics[t];i.current=0,i.average=0,i.min=1/0,i.max=0,i.history=[]}),this.frameCount=0,this.startTime=performance.now(),this.lastFrameTime=this.startTime,console.log("PerformanceMonitor reset")}},{key:"setCallbacks",value:function(e,t){this.onPerformanceWarning=e,this.onPerformanceCritical=t}},{key:"enableAutoOptimize",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};this.autoOptimize.enabled=!0,this.autoOptimize.fpsThreshold=e.fpsThreshold||45,this.autoOptimize.memoryThreshold=e.memoryThreshold||83886080,console.log("Auto-optimization enabled",this.autoOptimize)}},{key:"disableAutoOptimize",value:function(){this.autoOptimize.enabled=!1,console.log("Auto-optimization disabled")}},{key:"enable",value:function(){this.isEnabled=!0,console.log("PerformanceMonitor enabled")}},{key:"disable",value:function(){this.isEnabled=!1,console.log("PerformanceMonitor disabled")}},{key:"getRealTimeData",value:function(){return{fps:Math.round(this.metrics.fps.current),frameTime:Math.round(100*this.metrics.frameTime.current)/100,updateTime:Math.round(100*this.metrics.updateTime.current)/100,renderTime:Math.round(100*this.metrics.renderTime.current)/100,memoryMB:Math.round(this.metrics.memory.used/1024/1024*100)/100}}},{key:"getChartData",value:function(e){var t=this,i=this.metrics[e];return i&&i.history?i.history.map(function(e,n){return{frame:t.frameCount-i.history.length+n+1,value:Math.round(100*e)/100}}):[]}},{key:"destroy",value:function(){var e=this;this.isEnabled=!1,this.onPerformanceWarning=null,this.onPerformanceCritical=null,Object.keys(this.metrics).forEach(function(t){e.metrics[t].history=[]}),console.log("PerformanceMonitor destroyed")}}],t&&ge(e.prototype,t),Object.defineProperty(e,"prototype",{writable:!1}),e;var e,t}();function Se(e){return Se="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},Se(e)}function ke(){var e,t,i="function"==typeof Symbol?Symbol:{},n=i.iterator||"@@iterator",o=i.toStringTag||"@@toStringTag";function r(i,n,o,r){var l=n&&n.prototype instanceof s?n:s,c=Object.create(l.prototype);return xe(c,"_invoke",function(i,n,o){var r,s,l,c=0,u=o||[],h=!1,f={p:0,n:0,v:e,a:d,f:d.bind(e,4),d:function(t,i){return r=t,s=0,l=e,f.n=i,a}};function d(i,n){for(s=i,l=n,t=0;!h&&c&&!o&&t<u.length;t++){var o,r=u[t],d=f.p,p=r[2];i>3?(o=p===n)&&(l=r[(s=r[4])?5:(s=3,3)],r[4]=r[5]=e):r[0]<=d&&((o=i<2&&d<r[1])?(s=0,f.v=n,f.n=r[1]):d<p&&(o=i<3||r[0]>n||n>p)&&(r[4]=i,r[5]=n,f.n=p,s=0))}if(o||i>1)return a;throw h=!0,n}return function(o,u,p){if(c>1)throw TypeError("Generator is already running");for(h&&1===u&&d(u,p),s=u,l=p;(t=s<2?e:l)||!h;){r||(s?s<3?(s>1&&(f.n=-1),d(s,l)):f.n=l:f.v=l);try{if(c=2,r){if(s||(o="next"),t=r[o]){if(!(t=t.call(r,l)))throw TypeError("iterator result is not an object");if(!t.done)return t;l=t.value,s<2&&(s=0)}else 1===s&&(t=r.return)&&t.call(r),s<2&&(l=TypeError("The iterator does not provide a '"+o+"' method"),s=1);r=e}else if((t=(h=f.n<0)?l:i.call(n,f))!==a)break}catch(t){r=e,s=1,l=t}finally{c=1}}return{value:t,done:h}}}(i,o,r),!0),c}var a={};function s(){}function l(){}function c(){}t=Object.getPrototypeOf;var u=[][n]?t(t([][n]())):(xe(t={},n,function(){return this}),t),h=c.prototype=s.prototype=Object.create(u);function f(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,c):(e.__proto__=c,xe(e,o,"GeneratorFunction")),e.prototype=Object.create(h),e}return l.prototype=c,xe(h,"constructor",c),xe(c,"constructor",l),l.displayName="GeneratorFunction",xe(c,o,"GeneratorFunction"),xe(h),xe(h,o,"Generator"),xe(h,n,function(){return this}),xe(h,"toString",function(){return"[object Generator]"}),(ke=function(){return{w:r,m:f}})()}function xe(e,t,i,n){var o=Object.defineProperty;try{o({},"",{})}catch(e){o=0}xe=function(e,t,i,n){function r(t,i){xe(e,t,function(e){return this._invoke(t,i,e)})}t?o?o(e,t,{value:i,enumerable:!n,configurable:!n,writable:!n}):e[t]=i:(r("next",0),r("throw",1),r("return",2))},xe(e,t,i,n)}function Pe(e,t,i,n,o,r,a){try{var s=e[r](a),l=s.value}catch(e){return void i(e)}s.done?t(l):Promise.resolve(l).then(n,o)}function Ee(e){return function(){var t=this,i=arguments;return new Promise(function(n,o){var r=e.apply(t,i);function a(e){Pe(r,n,o,a,s,"next",e)}function s(e){Pe(r,n,o,a,s,"throw",e)}a(void 0)})}}function Te(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,Oe(n.key),n)}}function Oe(e){var t=function(e){if("object"!=Se(e)||!e)return e;var t=e[Symbol.toPrimitive];if(void 0!==t){var i=t.call(e,"string");if("object"!=Se(i))return i;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(e)}(e);return"symbol"==Se(t)?t:t+""}var Me=function(){return e=function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.registration=null,this.isSupported="undefined"!=typeof navigator&&"serviceWorker"in navigator,this.updateAvailable=!1,this.isOnline="undefined"==typeof navigator||navigator.onLine,this.onUpdateAvailable=null,this.onInstalled=null,this.onError=null,this.onOffline=null,this.onOnline=null,console.log("ServiceWorkerManager initialized, supported:",this.isSupported)},t=[{key:"register",value:(c=Ee(ke().m(function e(){var t,i,n=arguments;return ke().w(function(e){for(;;)switch(e.p=e.n){case 0:if(t=n.length>0&&void 0!==n[0]?n[0]:"/sw.js",this.isSupported){e.n=1;break}return console.warn("Service Worker not supported in this browser"),e.a(2,!1);case 1:return e.p=1,console.log("Registering Service Worker..."),e.n=2,navigator.serviceWorker.register(t,{scope:"/"});case 2:return this.registration=e.v,console.log("Service Worker registered successfully:",this.registration),this.setupEventListeners(),this.checkForUpdates(),e.a(2,!0);case 3:return e.p=3,i=e.v,console.error("Service Worker registration failed:",i),this.onError&&this.onError(i),e.a(2,!1)}},e,this,[[1,3]])})),function(){return c.apply(this,arguments)})},{key:"setupEventListeners",value:function(){var e=this;this.registration&&(this.registration.addEventListener("updatefound",function(){console.log("Service Worker update found");var t=e.registration.installing;t&&t.addEventListener("statechange",function(){switch(console.log("Service Worker state changed:",t.state),t.state){case"installed":navigator.serviceWorker.controller?(console.log("New Service Worker available"),e.updateAvailable=!0,e.onUpdateAvailable&&e.onUpdateAvailable(t)):(console.log("Service Worker installed for the first time"),e.onInstalled&&e.onInstalled(t));break;case"activated":console.log("Service Worker activated");break;case"redundant":console.log("Service Worker became redundant")}})}),navigator.serviceWorker.addEventListener("message",function(t){e.handleMessage(t.data)}),window.addEventListener("online",function(){console.log("Network: Online"),e.isOnline=!0,e.onOnline&&e.onOnline()}),window.addEventListener("offline",function(){console.log("Network: Offline"),e.isOnline=!1,e.onOffline&&e.onOffline()}))}},{key:"handleMessage",value:function(e){console.log("Message from Service Worker:",e),"SW_UPDATED"===e.type?(console.log("Service Worker has been updated"),this.updateAvailable=!0,this.onUpdateAvailable&&this.onUpdateAvailable()):console.log("Unknown message type:",e.type)}},{key:"checkForUpdates",value:(l=Ee(ke().m(function e(){var t;return ke().w(function(e){for(;;)switch(e.p=e.n){case 0:if(this.registration){e.n=1;break}return e.a(2);case 1:return e.p=1,console.log("Checking for Service Worker updates..."),e.n=2,this.registration.update();case 2:e.n=4;break;case 3:e.p=3,t=e.v,console.error("Failed to check for updates:",t);case 4:return e.a(2)}},e,this,[[1,3]])})),function(){return l.apply(this,arguments)})},{key:"applyUpdate",value:(s=Ee(ke().m(function e(){var t,i;return ke().w(function(e){for(;;)switch(e.p=e.n){case 0:if(this.registration&&this.updateAvailable){e.n=1;break}return console.warn("No update available"),e.a(2,!1);case 1:if(e.p=1,!(t=this.registration.waiting)){e.n=3;break}return t.postMessage({type:"SKIP_WAITING"}),e.n=2,new Promise(function(e){navigator.serviceWorker.addEventListener("controllerchange",e,{once:!0})});case 2:return console.log("Service Worker update applied"),this.updateAvailable=!1,e.a(2,!0);case 3:e.n=5;break;case 4:return e.p=4,i=e.v,console.error("Failed to apply update:",i),e.a(2,!1);case 5:return e.a(2,!1)}},e,this,[[1,4]])})),function(){return s.apply(this,arguments)})},{key:"getVersion",value:(a=Ee(ke().m(function e(){var t=this;return ke().w(function(e){for(;;)switch(e.n){case 0:if(this.registration&&this.registration.active){e.n=1;break}return e.a(2,null);case 1:return e.a(2,new Promise(function(e,i){var n=new MessageChannel;n.port1.onmessage=function(t){e(t.data)},setTimeout(function(){i(new Error("Timeout waiting for version info"))},5e3),t.registration.active.postMessage({type:"GET_VERSION"},[n.port2])}))}},e,this)})),function(){return a.apply(this,arguments)})},{key:"clearCache",value:(r=Ee(ke().m(function e(){var t=this;return ke().w(function(e){for(;;)switch(e.n){case 0:if(this.registration&&this.registration.active){e.n=1;break}return e.a(2,!1);case 1:return e.a(2,new Promise(function(e){var i=new MessageChannel;i.port1.onmessage=function(t){e(t.data.success)},setTimeout(function(){e(!1)},1e4),t.registration.active.postMessage({type:"CLEAR_CACHE"},[i.port2])}))}},e,this)})),function(){return r.apply(this,arguments)})},{key:"updateCache",value:(o=Ee(ke().m(function e(){var t=this;return ke().w(function(e){for(;;)switch(e.n){case 0:if(this.registration&&this.registration.active){e.n=1;break}return e.a(2,!1);case 1:return e.a(2,new Promise(function(e){var i=new MessageChannel;i.port1.onmessage=function(t){e(t.data.success)},setTimeout(function(){e(!1)},3e4),t.registration.active.postMessage({type:"UPDATE_CACHE"},[i.port2])}))}},e,this)})),function(){return o.apply(this,arguments)})},{key:"isOffline",value:function(){return!this.isOnline}},{key:"getCacheSize",value:(n=Ee(ke().m(function e(){var t,i;return ke().w(function(e){for(;;)switch(e.p=e.n){case 0:if("undefined"!=typeof navigator&&"storage"in navigator&&"estimate"in navigator.storage){e.n=1;break}return e.a(2,null);case 1:return e.p=1,e.n=2,navigator.storage.estimate();case 2:return t=e.v,e.a(2,{quota:t.quota,usage:t.usage,usagePercentage:(t.usage/t.quota*100).toFixed(2)});case 3:return e.p=3,i=e.v,console.error("Failed to get cache size:",i),e.a(2,null)}},e,null,[[1,3]])})),function(){return n.apply(this,arguments)})},{key:"setCallbacks",value:function(e){this.onUpdateAvailable=e.onUpdateAvailable||null,this.onInstalled=e.onInstalled||null,this.onError=e.onError||null,this.onOffline=e.onOffline||null,this.onOnline=e.onOnline||null}},{key:"unregister",value:(i=Ee(ke().m(function e(){var t,i;return ke().w(function(e){for(;;)switch(e.p=e.n){case 0:if(this.registration){e.n=1;break}return e.a(2,!1);case 1:return e.p=1,e.n=2,this.registration.unregister();case 2:return t=e.v,console.log("Service Worker unregistered:",t),this.registration=null,this.updateAvailable=!1,e.a(2,t);case 3:return e.p=3,i=e.v,console.error("Failed to unregister Service Worker:",i),e.a(2,!1)}},e,this,[[1,3]])})),function(){return i.apply(this,arguments)})},{key:"getStatus",value:function(){return{isSupported:this.isSupported,isRegistered:!!this.registration,isActive:!(!this.registration||!this.registration.active),updateAvailable:this.updateAvailable,isOnline:this.isOnline,scope:this.registration?this.registration.scope:null}}},{key:"destroy",value:function(){window.removeEventListener("online",this.onOnline),window.removeEventListener("offline",this.onOffline),this.onUpdateAvailable=null,this.onInstalled=null,this.onError=null,this.onOffline=null,this.onOnline=null,console.log("ServiceWorkerManager destroyed")}}],t&&Te(e.prototype,t),Object.defineProperty(e,"prototype",{writable:!1}),e;var e,t,i,n,o,r,a,s,l,c}();function Ce(e){return Ce="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},Ce(e)}function Ae(){var e,t,i="function"==typeof Symbol?Symbol:{},n=i.iterator||"@@iterator",o=i.toStringTag||"@@toStringTag";function r(i,n,o,r){var l=n&&n.prototype instanceof s?n:s,c=Object.create(l.prototype);return je(c,"_invoke",function(i,n,o){var r,s,l,c=0,u=o||[],h=!1,f={p:0,n:0,v:e,a:d,f:d.bind(e,4),d:function(t,i){return r=t,s=0,l=e,f.n=i,a}};function d(i,n){for(s=i,l=n,t=0;!h&&c&&!o&&t<u.length;t++){var o,r=u[t],d=f.p,p=r[2];i>3?(o=p===n)&&(l=r[(s=r[4])?5:(s=3,3)],r[4]=r[5]=e):r[0]<=d&&((o=i<2&&d<r[1])?(s=0,f.v=n,f.n=r[1]):d<p&&(o=i<3||r[0]>n||n>p)&&(r[4]=i,r[5]=n,f.n=p,s=0))}if(o||i>1)return a;throw h=!0,n}return function(o,u,p){if(c>1)throw TypeError("Generator is already running");for(h&&1===u&&d(u,p),s=u,l=p;(t=s<2?e:l)||!h;){r||(s?s<3?(s>1&&(f.n=-1),d(s,l)):f.n=l:f.v=l);try{if(c=2,r){if(s||(o="next"),t=r[o]){if(!(t=t.call(r,l)))throw TypeError("iterator result is not an object");if(!t.done)return t;l=t.value,s<2&&(s=0)}else 1===s&&(t=r.return)&&t.call(r),s<2&&(l=TypeError("The iterator does not provide a '"+o+"' method"),s=1);r=e}else if((t=(h=f.n<0)?l:i.call(n,f))!==a)break}catch(t){r=e,s=1,l=t}finally{c=1}}return{value:t,done:h}}}(i,o,r),!0),c}var a={};function s(){}function l(){}function c(){}t=Object.getPrototypeOf;var u=[][n]?t(t([][n]())):(je(t={},n,function(){return this}),t),h=c.prototype=s.prototype=Object.create(u);function f(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,c):(e.__proto__=c,je(e,o,"GeneratorFunction")),e.prototype=Object.create(h),e}return l.prototype=c,je(h,"constructor",c),je(c,"constructor",l),l.displayName="GeneratorFunction",je(c,o,"GeneratorFunction"),je(h),je(h,o,"Generator"),je(h,n,function(){return this}),je(h,"toString",function(){return"[object Generator]"}),(Ae=function(){return{w:r,m:f}})()}function je(e,t,i,n){var o=Object.defineProperty;try{o({},"",{})}catch(e){o=0}je=function(e,t,i,n){function r(t,i){je(e,t,function(e){return this._invoke(t,i,e)})}t?o?o(e,t,{value:i,enumerable:!n,configurable:!n,writable:!n}):e[t]=i:(r("next",0),r("throw",1),r("return",2))},je(e,t,i,n)}function ze(e,t,i,n,o,r,a){try{var s=e[r](a),l=s.value}catch(e){return void i(e)}s.done?t(l):Promise.resolve(l).then(n,o)}function Fe(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,Ie(n.key),n)}}function Ie(e){var t=function(e){if("object"!=Ce(e)||!e)return e;var t=e[Symbol.toPrimitive];if(void 0!==t){var i=t.call(e,"string");if("object"!=Ce(i))return i;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(e)}(e);return"symbol"==Ce(t)?t:t+""}var Be=function(){return e=function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.deferredPrompt=null,this.isInstalled=!1,this.isInstallable=!1,this.installButton=null,this.onInstallable=null,this.onInstalled=null,this.onInstallDeclined=null,this.initialize(),console.log("PWAInstallManager initialized")},t=[{key:"initialize",value:function(){this.checkInstallStatus(),this.setupEventListeners(),this.createInstallButton()}},{key:"checkInstallStatus",value:function(){this.isInstalled=window.matchMedia("(display-mode: standalone)").matches||window.matchMedia("(display-mode: fullscreen)").matches||!0===window.navigator.standalone,console.log("PWA install status:",this.isInstalled?"installed":"not installed")}},{key:"setupEventListeners",value:function(){var e=this;window.addEventListener("beforeinstallprompt",function(t){console.log("PWA install prompt available"),t.preventDefault(),e.deferredPrompt=t,e.isInstallable=!0,e.showInstallButton(),e.onInstallable&&e.onInstallable(t)}),window.addEventListener("appinstalled",function(t){console.log("PWA was installed"),e.isInstalled=!0,e.isInstallable=!1,e.deferredPrompt=null,e.hideInstallButton(),e.onInstalled&&e.onInstalled(t)}),window.matchMedia("(display-mode: standalone)").addEventListener("change",function(t){e.isInstalled=t.matches,console.log("Display mode changed, installed:",e.isInstalled)})}},{key:"createInstallButton",value:function(){var e=this;this.installButton=document.createElement("button"),this.installButton.id="pwa-install-button",this.installButton.className="pwa-install-btn",this.installButton.innerHTML='\n      <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">\n        <path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/>\n      </svg>\n      <span>安裝應用</span>\n    ';var t=document.createElement("style");t.textContent="\n      .pwa-install-btn {\n        position: fixed;\n        bottom: 20px;\n        right: 20px;\n        background: #4CAF50;\n        color: white;\n        border: none;\n        border-radius: 50px;\n        padding: 12px 20px;\n        font-size: 14px;\n        font-weight: bold;\n        cursor: pointer;\n        box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3);\n        z-index: 1000;\n        display: none;\n        align-items: center;\n        gap: 8px;\n        transition: all 0.3s ease;\n        font-family: Arial, sans-serif;\n      }\n      \n      .pwa-install-btn:hover {\n        background: #45a049;\n        transform: translateY(-2px);\n        box-shadow: 0 6px 16px rgba(76, 175, 80, 0.4);\n      }\n      \n      .pwa-install-btn:active {\n        transform: translateY(0);\n      }\n      \n      .pwa-install-btn svg {\n        width: 20px;\n        height: 20px;\n      }\n      \n      @media (max-width: 768px) {\n        .pwa-install-btn {\n          bottom: 80px;\n          right: 15px;\n          padding: 10px 16px;\n          font-size: 12px;\n        }\n        \n        .pwa-install-btn svg {\n          width: 16px;\n          height: 16px;\n        }\n      }\n    ",document.head.appendChild(t),document.body.appendChild(this.installButton),this.installButton.addEventListener("click",function(){e.promptInstall()})}},{key:"showInstallButton",value:function(){var e=this;this.installButton&&!this.isInstalled&&(this.installButton.style.display="flex",setTimeout(function(){e.installButton.style.opacity="1",e.installButton.style.transform="scale(1)"},100))}},{key:"hideInstallButton",value:function(){this.installButton&&(this.installButton.style.display="none")}},{key:"promptInstall",value:(i=Ae().m(function e(){var t,i,n;return Ae().w(function(e){for(;;)switch(e.p=e.n){case 0:if(this.deferredPrompt){e.n=1;break}return console.warn("Install prompt not available"),e.a(2,!1);case 1:return e.p=1,this.deferredPrompt.prompt(),e.n=2,this.deferredPrompt.userChoice;case 2:return t=e.v,i=t.outcome,console.log("Install prompt outcome:",i),"accepted"===i?console.log("User accepted the install prompt"):(console.log("User dismissed the install prompt"),this.onInstallDeclined&&this.onInstallDeclined()),this.deferredPrompt=null,this.isInstallable=!1,e.a(2,"accepted"===i);case 3:return e.p=3,n=e.v,console.error("Error showing install prompt:",n),e.a(2,!1)}},e,this,[[1,3]])}),n=function(){var e=this,t=arguments;return new Promise(function(n,o){var r=i.apply(e,t);function a(e){ze(r,n,o,a,s,"next",e)}function s(e){ze(r,n,o,a,s,"throw",e)}a(void 0)})},function(){return n.apply(this,arguments)})},{key:"canInstall",value:function(){return this.isInstallable&&!this.isInstalled&&this.deferredPrompt}},{key:"isAppInstalled",value:function(){return this.isInstalled}},{key:"getInstallStatus",value:function(){return{isInstalled:this.isInstalled,isInstallable:this.isInstallable,canPrompt:this.canInstall(),displayMode:this.getDisplayMode()}}},{key:"getDisplayMode",value:function(){return window.matchMedia("(display-mode: fullscreen)").matches?"fullscreen":window.matchMedia("(display-mode: standalone)").matches?"standalone":window.matchMedia("(display-mode: minimal-ui)").matches?"minimal-ui":"browser"}},{key:"createInstallBanner",value:function(){var e=this;if(!this.isInstalled&&this.isInstallable){var t=document.createElement("div");t.id="pwa-install-banner",t.className="pwa-install-banner",t.innerHTML='\n      <div class="banner-content">\n        <div class="banner-icon">📱</div>\n        <div class="banner-text">\n          <div class="banner-title">安裝無限跳躍遊戲</div>\n          <div class="banner-subtitle">獲得更好的遊戲體驗</div>\n        </div>\n        <div class="banner-actions">\n          <button class="banner-install-btn">安裝</button>\n          <button class="banner-close-btn">×</button>\n        </div>\n      </div>\n    ';var i=document.createElement("style");i.textContent="\n      .pwa-install-banner {\n        position: fixed;\n        top: 0;\n        left: 0;\n        right: 0;\n        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);\n        color: white;\n        z-index: 10000;\n        transform: translateY(-100%);\n        transition: transform 0.3s ease;\n      }\n      \n      .pwa-install-banner.show {\n        transform: translateY(0);\n      }\n      \n      .banner-content {\n        display: flex;\n        align-items: center;\n        padding: 15px 20px;\n        gap: 15px;\n      }\n      \n      .banner-icon {\n        font-size: 24px;\n      }\n      \n      .banner-text {\n        flex: 1;\n      }\n      \n      .banner-title {\n        font-weight: bold;\n        font-size: 16px;\n        margin-bottom: 2px;\n      }\n      \n      .banner-subtitle {\n        font-size: 12px;\n        opacity: 0.9;\n      }\n      \n      .banner-actions {\n        display: flex;\n        gap: 10px;\n        align-items: center;\n      }\n      \n      .banner-install-btn {\n        background: white;\n        color: #667eea;\n        border: none;\n        padding: 8px 16px;\n        border-radius: 20px;\n        font-weight: bold;\n        cursor: pointer;\n        font-size: 12px;\n      }\n      \n      .banner-close-btn {\n        background: none;\n        border: none;\n        color: white;\n        font-size: 20px;\n        cursor: pointer;\n        padding: 5px;\n        line-height: 1;\n      }\n      \n      @media (max-width: 768px) {\n        .banner-content {\n          padding: 12px 15px;\n          gap: 12px;\n        }\n        \n        .banner-title {\n          font-size: 14px;\n        }\n        \n        .banner-subtitle {\n          font-size: 11px;\n        }\n      }\n    ",document.head.appendChild(i),document.body.appendChild(t),t.querySelector(".banner-install-btn").addEventListener("click",function(){e.promptInstall(),t.remove()}),t.querySelector(".banner-close-btn").addEventListener("click",function(){t.remove()}),setTimeout(function(){t.classList.add("show")},500),setTimeout(function(){t.parentNode&&(t.classList.remove("show"),setTimeout(function(){return t.remove()},300))},1e4)}}},{key:"setCallbacks",value:function(e){this.onInstallable=e.onInstallable||null,this.onInstalled=e.onInstalled||null,this.onInstallDeclined=e.onInstallDeclined||null}},{key:"getInstallStats",value:function(){return{userAgent:navigator.userAgent,platform:navigator.platform,displayMode:this.getDisplayMode(),isStandalone:window.navigator.standalone,supportsPWA:"serviceWorker"in navigator&&"PushManager"in window,supportsInstall:"beforeinstallprompt"in window}}},{key:"destroy",value:function(){this.installButton&&(this.installButton.remove(),this.installButton=null);var e=document.getElementById("pwa-install-banner");e&&e.remove(),this.deferredPrompt=null,this.onInstallable=null,this.onInstalled=null,this.onInstallDeclined=null,console.log("PWAInstallManager destroyed")}}],t&&Fe(e.prototype,t),Object.defineProperty(e,"prototype",{writable:!1}),e;var e,t,i,n}();function Re(e){return Re="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},Re(e)}function De(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,Le(n.key),n)}}function Le(e){var t=function(e){if("object"!=Re(e)||!e)return e;var t=e[Symbol.toPrimitive];if(void 0!==t){var i=t.call(e,"string");if("object"!=Re(i))return i;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(e)}(e);return"symbol"==Re(t)?t:t+""}var We=function(){return e=function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.name=t,this.isActive=!1,this.entities=[],this.systems=new Map},(t=[{key:"enter",value:function(){this.isActive=!0,console.log("Entering scene: ".concat(this.name))}},{key:"exit",value:function(){this.isActive=!1,console.log("Exiting scene: ".concat(this.name))}},{key:"update",value:function(e){this.isActive&&(this.entities.forEach(function(t){t.update&&t.update(e)}),this.systems.forEach(function(t){t.update&&t.update(e)}))}},{key:"render",value:function(e){this.isActive&&(this.entities.forEach(function(t){t.render&&t.render(e)}),this.systems.forEach(function(t){t.render&&t.render(e)}))}},{key:"addEntity",value:function(e){this.entities.push(e)}},{key:"removeEntity",value:function(e){var t=this.entities.indexOf(e);t>-1&&this.entities.splice(t,1)}},{key:"clearEntities",value:function(){this.entities=[]}},{key:"registerSystem",value:function(e,t){this.systems.set(e,t)}},{key:"getSystem",value:function(e){return this.systems.get(e)}},{key:"handleInput",value:function(e){}},{key:"reset",value:function(){this.clearEntities(),this.systems.clear()}}])&&De(e.prototype,t),Object.defineProperty(e,"prototype",{writable:!1}),e;var e,t}();function Ge(e){return Ge="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},Ge(e)}function Ye(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,Ne(n.key),n)}}function Ne(e){var t=function(e){if("object"!=Ge(e)||!e)return e;var t=e[Symbol.toPrimitive];if(void 0!==t){var i=t.call(e,"string");if("object"!=Ge(i))return i;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(e)}(e);return"symbol"==Ge(t)?t:t+""}function Ve(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch(e){}return(Ve=function(){return!!e})()}function _e(e,t,i,n){var o=Ue(He(1&n?e.prototype:e),t,i);return 2&n&&"function"==typeof o?function(e){return o.apply(i,e)}:o}function Ue(){return Ue="undefined"!=typeof Reflect&&Reflect.get?Reflect.get.bind():function(e,t,i){var n=function(e,t){for(;!{}.hasOwnProperty.call(e,t)&&null!==(e=He(e)););return e}(e,t);if(n){var o=Object.getOwnPropertyDescriptor(n,t);return o.get?o.get.call(arguments.length<3?e:i):o.value}},Ue.apply(null,arguments)}function He(e){return He=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(e){return e.__proto__||Object.getPrototypeOf(e)},He(e)}function Ke(e,t){return Ke=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e},Ke(e,t)}var Xe=function(e){function t(e){var i;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),(i=function(e,t,i){return t=He(t),function(e,t){if(t&&("object"==Ge(t)||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e)}(e,Ve()?Reflect.construct(t,i||[],He(e).constructor):t.apply(e,i))}(this,t,["menu"])).gameEngine=e,i.selectedOption=0,i.menuOptions=[{text:"開始遊戲",action:"start"},{text:"排行榜",action:"leaderboard"},{text:"設置",action:"settings"}],i.titleY=150,i.menuStartY=300,i.menuSpacing=80,i.animationTime=0,i}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&Ke(e,t)}(t,e),i=t,(n=[{key:"enter",value:function(){_e(t,"enter",this,3)([]),this.selectedOption=0,this.animationTime=0,this.adjustLayoutForScreen(),console.log("MenuScene entered successfully")}},{key:"adjustLayoutForScreen",value:function(){var e=w.canvas.scale||1,t=w.canvas.height;this.titleY=x(150,e),this.menuStartY=Math.max(.4*t,x(300,e)),this.menuSpacing=x(80,e);var i=this.menuOptions.length*this.menuSpacing,n=t-this.menuStartY-x(100,e);i>n&&(this.menuSpacing=Math.floor(n/this.menuOptions.length))}},{key:"update",value:function(e){_e(t,"update",this,3)([e]),this.animationTime+=e;var i=this.gameEngine.getSystem("input");if(i){var n=i.getCurrentInput();if(n&&n.isPressed){if(n.isTap){console.log("Menu tap detected at:",n.startPosition);var o=this.getClickedOption(n.startPosition.x,n.startPosition.y);-1!==o&&(this.selectedOption=o,console.log("Selected option:",this.selectedOption),this.executeSelectedOption())}if(n.isSwipe){var r=n.swipeAngle;Math.abs(Math.sin(r))>.7&&(Math.sin(r)<0?this.selectedOption=Math.max(0,this.selectedOption-1):this.selectedOption=Math.min(this.menuOptions.length-1,this.selectedOption+1))}}i.isKeyPressed&&i.isKeyHeld&&((i.isKeyPressed("ArrowUp")||i.isKeyPressed("KeyW"))&&(this.selectedOption=Math.max(0,this.selectedOption-1)),(i.isKeyPressed("ArrowDown")||i.isKeyPressed("KeyS"))&&(this.selectedOption=Math.min(this.menuOptions.length-1,this.selectedOption+1)),(i.isKeyPressed("Enter")||i.isKeyPressed("Space"))&&this.executeSelectedOption())}}},{key:"render",value:function(e){if(this.isActive){e.save(),e.setTransform(1,0,0,1,0,0);var i=e.createLinearGradient(0,0,0,e.canvas.height);i.addColorStop(0,"#667eea"),i.addColorStop(1,"#764ba2"),e.fillStyle=i,e.fillRect(0,0,e.canvas.width,e.canvas.height),this.renderTitle(e),this.renderMenuOptions(e),this.renderInstructions(e),_e(t,"render",this,3)([e])}}},{key:"renderTitle",value:function(e){e.save();var t=w.canvas.scale||1;e.fillStyle="#FFFFFF",e.font="bold ".concat(k("xlarge",1.2*t),"px Arial"),e.textAlign="center",e.textBaseline="middle",e.shadowColor="rgba(0, 0, 0, 0.5)",e.shadowBlur=x(10,t),e.shadowOffsetX=x(2,t),e.shadowOffsetY=x(2,t);var i=e.canvas.width/2,n=Math.sin(2*this.animationTime)*x(5,t);e.fillText("無限跳躍",i,this.titleY+n),e.font="".concat(k("medium",t),"px Arial"),e.shadowBlur=x(5,t),e.fillText("Infinite Jump",i,this.titleY+x(50,t)+n),e.restore()}},{key:"renderMenuOptions",value:function(e){var t=this;e.save();var i=w.canvas.scale||1;this.menuOptions.forEach(function(n,o){var r=t.menuStartY+o*t.menuSpacing,a=o===t.selectedOption,s=x(240,i),l=x(50,i);if(a&&(e.fillStyle="rgba(255, 255, 255, 0.2)",e.fillRect(e.canvas.width/2-s/2,r-l/2,s,l),e.strokeStyle="#FFFFFF",e.lineWidth=x(2,i),e.strokeRect(e.canvas.width/2-s/2,r-l/2,s,l)),e.fillStyle=a?"#FFD700":"#FFFFFF",e.font=a?"bold ".concat(k("large",i),"px Arial"):"".concat(k("medium",i),"px Arial"),e.textAlign="center",e.textBaseline="middle",e.shadowColor="rgba(0, 0, 0, 0.5)",e.shadowBlur=x(5,i),e.shadowOffsetX=x(1,i),e.shadowOffsetY=x(1,i),a){var c=1+.05*Math.sin(4*t.animationTime);e.save(),e.translate(e.canvas.width/2,r),e.scale(c,c),e.fillText(n.text,0,0),e.restore()}else e.fillText(n.text,e.canvas.width/2,r)}),e.restore()}},{key:"renderInstructions",value:function(e){e.save();var t=w.canvas.scale||1;e.fillStyle="rgba(255, 255, 255, 0.8)",e.font="".concat(k("small",t),"px Arial"),e.textAlign="center",e.textBaseline="middle";var i=e.canvas.height-x(80,t),n=x(20,t);["電腦: 使用 A/D 鍵或方向鍵控制","手機: 左右滑動控制移動","點擊或按 Enter 選擇選項"].forEach(function(t,o){e.fillText(t,e.canvas.width/2,i+o*n)}),e.restore()}},{key:"getClickedOption",value:function(e,t){for(var i=0;i<this.menuOptions.length;i++){var n=this.menuStartY+i*this.menuSpacing,o=n-this.menuSpacing/2,r=n+this.menuSpacing/2;if(t>=o&&t<=r)return i}return-1}},{key:"handleInput",value:function(e){if(e&&e.isPressed&&e.isTap){var t=this.getClickedOption(e.startPosition.x,e.startPosition.y);-1!==t&&(this.selectedOption=t,this.executeSelectedOption())}}},{key:"executeSelectedOption",value:function(){switch(this.menuOptions[this.selectedOption].action){case"start":this.startGame();break;case"leaderboard":this.showLeaderboard();break;case"settings":this.showSettings()}}},{key:"startGame",value:function(){var e=this.gameEngine.getSystem("state");e&&(e.changeState(s.PLAYING),this.gameEngine.switchScene("game"))}},{key:"showLeaderboard",value:function(){var e=this.gameEngine.getSystem("state");e&&(e.changeState(s.LEADERBOARD),this.gameEngine.switchScene("leaderboard"))}},{key:"showSettings",value:function(){var e=this.gameEngine.getSystem("state");e&&e.changeState(s.SETTINGS)}},{key:"reset",value:function(){_e(t,"reset",this,3)([]),this.selectedOption=0,this.animationTime=0}}])&&Ye(i.prototype,n),Object.defineProperty(i,"prototype",{writable:!1}),i;var i,n}(We);function qe(e){return qe="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},qe(e)}function Je(e,t){var i="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!i){if(Array.isArray(e)||(i=function(e,t){if(e){if("string"==typeof e)return Ze(e,t);var i={}.toString.call(e).slice(8,-1);return"Object"===i&&e.constructor&&(i=e.constructor.name),"Map"===i||"Set"===i?Array.from(e):"Arguments"===i||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(i)?Ze(e,t):void 0}}(e))||t&&e&&"number"==typeof e.length){i&&(e=i);var n=0,o=function(){};return{s:o,n:function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}},e:function(e){throw e},f:o}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var r,a=!0,s=!1;return{s:function(){i=i.call(e)},n:function(){var e=i.next();return a=e.done,e},e:function(e){s=!0,r=e},f:function(){try{a||null==i.return||i.return()}finally{if(s)throw r}}}}function Ze(e,t){(null==t||t>e.length)&&(t=e.length);for(var i=0,n=Array(t);i<t;i++)n[i]=e[i];return n}function Qe(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,$e(n.key),n)}}function $e(e){var t=function(e){if("object"!=qe(e)||!e)return e;var t=e[Symbol.toPrimitive];if(void 0!==t){var i=t.call(e,"string");if("object"!=qe(i))return i;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(e)}(e);return"symbol"==qe(t)?t:t+""}var et=function(){return e=function e(t,i){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.position={x:t,y:i},this.size={width:40,height:40},this.audioManager=n,this.physics={velocity:{x:0,y:0},affectedByGravity:!0,airResistance:!0,bounciness:0,checkBounds:!0,bounds:{left:0,right:400,top:-1/0,bottom:1/0},bounceOnBounds:!1},this.collider={width:36,height:36,offset:{x:0,y:0},layer:1,mask:4294967295},this.moveSpeed=200,this.jumpHeight=120,this.jumpVelocity=-650,this.isAlive=!0,this.isJumping=!1,this.isGrounded=!1,this.direction=0,this.currentLevel=0,this.color="#FF6B6B",this.trailParticles=[],this.animationTime=0,this.scale=1,this.rotation=0,this.animationState="idle"},t=[{key:"update",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[];if(this.isAlive){this.animationTime+=e,this.physics.velocity.x=this.direction*this.moveSpeed,this.physics.velocity.y+=800*e,this.position.x+=this.physics.velocity.x*e,this.position.y+=this.physics.velocity.y*e;var i=this.size.width/2;this.position.x<i&&(this.position.x=i),this.position.x>600-i&&(this.position.x=600-i),this.checkPlatformCollisions(t),this.position.y>1300&&console.log("Player fell too far, should trigger game over"),this.updateAnimationState(),this.updateVisualEffects(e),this.updateTrailParticles(e),this.checkGrounded()}}},{key:"checkPlatformCollisions",value:function(e){var t,i=Je(e);try{for(i.s();!(t=i.n()).done;){var n=t.value;if(this.position.x+this.size.width/2>n.position.x-n.size.width/2&&this.position.x-this.size.width/2<n.position.x+n.size.width/2&&this.position.y+this.size.height/2>n.position.y-n.size.height/2&&this.position.y-this.size.height/2<n.position.y+n.size.height/2&&this.physics.velocity.y>0&&this.position.y-this.size.height/2<n.position.y){if(n.hasSpikes)return void this.die();this.position.y=n.position.y-n.size.height/2-this.size.height/2,this.physics.velocity.y=0,this.isGrounded=!0,this.isJumping=!1,this.audioManager&&this.audioManager.playSound("land",{volume:.4}),this.addLandingParticles();break}}}catch(e){i.e(e)}finally{i.f()}}},{key:"render",value:function(e){this.isAlive&&(e.save(),e.fillStyle=this.color,e.fillRect(this.position.x-this.size.width/2,this.position.y-this.size.height/2,this.size.width,this.size.height),e.fillStyle="#FFFFFF",e.fillRect(this.position.x-8,this.position.y-8,6,6),e.fillRect(this.position.x+2,this.position.y-8,6,6),e.fillStyle="#000000",e.fillRect(this.position.x-6,this.position.y-6,3,3),e.fillRect(this.position.x+4,this.position.y-6,3,3),e.restore())}},{key:"moveLeft",value:function(){this.direction=-1}},{key:"moveRight",value:function(){this.direction=1}},{key:"stopMoving",value:function(){this.direction=0}},{key:"jump",value:function(){this.physics.velocity.y=this.jumpVelocity,this.isJumping=!0,this.isGrounded=!1,this.audioManager&&this.audioManager.playSound("jump",{volume:.6}),this.addJumpParticles(),this.scale=1.2,this.rotation=.2*(Math.random()-.5)}},{key:"checkCollision",value:function(e){var t,i=this.getBoundingRect(),n=Je(e);try{for(n.s();!(t=n.n()).done;){var o=t.value,r=o.getBoundingRect();if(this.isRectColliding(i,r))return o}}catch(e){n.e(e)}finally{n.f()}return null}},{key:"getBoundingRect",value:function(){return{x:this.position.x-this.size.width/2,y:this.position.y-this.size.height/2,width:this.size.width,height:this.size.height}}},{key:"isRectColliding",value:function(e,t){return e.x<t.x+t.width&&e.x+e.width>t.x&&e.y<t.y+t.height&&e.y+e.height>t.y}},{key:"setPosition",value:function(e,t){this.position.x=e,this.position.y=t}},{key:"reset",value:function(){this.physics.velocity={x:0,y:0},this.isAlive=!0,this.isJumping=!1,this.isGrounded=!1,this.direction=0,this.currentLevel=0,this.trailParticles=[],this.animationTime=0,this.scale=1,this.rotation=0,this.animationState="idle"}},{key:"die",value:function(){console.log("PLAYER DIED! Position:",this.position,"Velocity:",this.physics.velocity),console.trace("Death stack trace:"),this.isAlive=!1,this.physics.velocity={x:0,y:0},this.audioManager&&this.audioManager.playSound("gameOver",{volume:.7}),this.scale=.8,this.rotation=Math.PI/4;for(var e=0;e<15;e++)this.trailParticles.push({x:this.position.x+(Math.random()-.5)*this.size.width,y:this.position.y+(Math.random()-.5)*this.size.height,life:1,maxLife:1,velocityX:200*(Math.random()-.5),velocityY:-100*Math.random()-50})}},{key:"updateTrailParticles",value:function(e){(Math.abs(this.physics.velocity.x)>50||Math.abs(this.physics.velocity.y)>50)&&this.trailParticles.push({x:this.position.x+(Math.random()-.5)*this.size.width*.5,y:this.position.y+(Math.random()-.5)*this.size.height*.5,life:.4,maxLife:.4,velocityX:20*(Math.random()-.5),velocityY:20*(Math.random()-.5)}),this.trailParticles=this.trailParticles.filter(function(t){return t.life-=e,void 0!==t.velocityX&&(t.x+=t.velocityX*e,t.y+=t.velocityY*e,t.velocityY+=100*e),t.life>0}),this.trailParticles.length>20&&(this.trailParticles=this.trailParticles.slice(-20))}},{key:"renderTrailParticles",value:function(e){var t=this;this.trailParticles.forEach(function(i){var n=i.life/i.maxLife,o=Math.max(2,t.size.width*n*.3),r=e.createRadialGradient(i.x,i.y,0,i.x,i.y,o);r.addColorStop(0,"rgba(255, 107, 107, ".concat(.8*n,")")),r.addColorStop(1,"rgba(255, 107, 107, 0)"),e.fillStyle=r,e.beginPath(),e.arc(i.x,i.y,o,0,2*Math.PI),e.fill()})}},{key:"addJumpParticles",value:function(){for(var e=0;e<8;e++)this.trailParticles.push({x:this.position.x+(Math.random()-.5)*this.size.width,y:this.position.y+this.size.height/2,life:.8,maxLife:.8,velocityX:100*(Math.random()-.5),velocityY:-50*Math.random()-50})}},{key:"updateAnimationState",value:function(){this.physics.velocity.y<-50?this.animationState="jumping":this.physics.velocity.y>50?this.animationState="falling":this.animationState="idle"}},{key:"updateVisualEffects",value:function(e){if(this.scale>1&&(this.scale=Math.max(1,this.scale-2*e)),Math.abs(this.rotation)>.01?this.rotation*=Math.pow(.9,60*e):this.rotation=0,0!==this.direction){var t=.1*this.direction;this.rotation+=(t-this.rotation)*e*5}}},{key:"checkGrounded",value:function(){this.physics.velocity.y<-5&&(this.isGrounded=!1)}},{key:"drawRoundedRect",value:function(e,t,i,n,o,r,a){e.fillStyle=a,e.beginPath(),e.moveTo(t+r,i),e.lineTo(t+n-r,i),e.quadraticCurveTo(t+n,i,t+n,i+r),e.lineTo(t+n,i+o-r),e.quadraticCurveTo(t+n,i+o,t+n-r,i+o),e.lineTo(t+r,i+o),e.quadraticCurveTo(t,i+o,t,i+o-r),e.lineTo(t,i+r),e.quadraticCurveTo(t,i,t+r,i),e.closePath(),e.fill(),e.strokeStyle="#CC5555",e.lineWidth=2,e.stroke()}},{key:"renderEyes",value:function(e){var t=-6;e.fillStyle="#FFFFFF",e.beginPath(),e.arc(-10,t,4,0,2*Math.PI),e.arc(10,t,4,0,2*Math.PI),e.fill(),e.fillStyle="#000000";var i=1*this.direction,n="falling"===this.animationState?1:0;e.beginPath(),e.arc(-10+i,t+n,2,0,2*Math.PI),e.arc(10+i,t+n,2,0,2*Math.PI),e.fill(),e.fillStyle="#FFFFFF",e.beginPath(),e.arc(-10+i-1,t+n-1,1,0,2*Math.PI),e.arc(10+i-1,t+n-1,1,0,2*Math.PI),e.fill()}},{key:"renderExpression",value:function(e){e.strokeStyle="#000000",e.lineWidth=2,e.lineCap="round","jumping"===this.animationState?(e.beginPath(),e.arc(0,8,6,0,Math.PI),e.stroke()):"falling"===this.animationState?(e.beginPath(),e.arc(0,10,3,0,2*Math.PI),e.stroke()):(e.beginPath(),e.moveTo(-4,10),e.lineTo(4,10),e.stroke())}},{key:"renderAnimationEffects",value:function(e){if("jumping"===this.animationState){var t=2*Math.sin(10*this.animationTime)+25;e.strokeStyle="rgba(255, 255, 255, 0.3)",e.lineWidth=3,e.beginPath(),e.arc(0,0,t,0,2*Math.PI),e.stroke()}}},{key:"renderDebugInfo",value:function(e){e.strokeStyle="#00FF00",e.lineWidth=1,e.strokeRect(this.position.x-this.collider.width/2,this.position.y-this.collider.height/2,this.collider.width,this.collider.height),e.strokeStyle="#FF0000",e.lineWidth=2,e.beginPath(),e.moveTo(this.position.x,this.position.y),e.lineTo(this.position.x+.1*this.physics.velocity.x,this.position.y+.1*this.physics.velocity.y),e.stroke(),e.fillStyle="#000000",e.font="12px Arial",e.fillText("State: ".concat(this.animationState),this.position.x-30,this.position.y-30),e.fillText("Vel: ".concat(Math.round(this.physics.velocity.x),", ").concat(Math.round(this.physics.velocity.y)),this.position.x-30,this.position.y-45)}},{key:"onCollision",value:function(e){"platform"===e.entityType&&this.handlePlatformCollision(e)}},{key:"handlePlatformCollision",value:function(e){if(e.hasSpikes)this.die();else{this.position.y,this.size.height;var t=e.position.y-e.size.height/2,i=this.position.y-this.size.height/2;e.position.y,e.size.height,this.physics.velocity.y>0&&i<e.position.y&&(this.position.y=t-this.size.height/2,this.physics.velocity.y=0,this.isGrounded=!0,this.isJumping=!1,this.audioManager&&this.audioManager.playSound("land",{volume:.4}),e.isMoving&&(this.physics.velocity.x+=.3*e.physics.velocity.x),this.addLandingParticles())}}},{key:"addLandingParticles",value:function(){for(var e=0;e<6;e++)this.trailParticles.push({x:this.position.x+(Math.random()-.5)*this.size.width,y:this.position.y+this.size.height/2,life:.6,maxLife:.6,velocityX:80*(Math.random()-.5),velocityY:-30*Math.random()-10})}}],t&&Qe(e.prototype,t),Object.defineProperty(e,"prototype",{writable:!1}),e;var e,t}();function tt(e){return tt="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},tt(e)}function it(e,t,i){return(t=ot(t))in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}function nt(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,ot(n.key),n)}}function ot(e){var t=function(e){if("object"!=tt(e)||!e)return e;var t=e[Symbol.toPrimitive];if(void 0!==t){var i=t.call(e,"string");if("object"!=tt(i))return i;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(e)}(e);return"symbol"==tt(t)?t:t+""}var rt="normal",at="small",st="sliding",lt="spiky",ct=function(){return e=function e(t,i,n){var o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:rt;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.position={x:t,y:i},this.size={width:n,height:20},this.type=o,this.entityType="platform",this.isMoving=o===st,this.moveSpeed=100,this.moveDirection=Math.random()>.5?1:-1,this.moveRange=150,this.initialX=t,this.colors=it(it(it(it({},rt,"#4ECDC4"),at,"#45B7D1"),st,"#F9CA24"),lt,"#F0932B"),this.hasSpikes=o===lt,this.spikeHeight=15,this.collider={width:n,height:20,offset:{x:0,y:0},layer:2,mask:1},this.physics={velocity:{x:0,y:0},affectedByGravity:!1,airResistance:!1,bounciness:0,checkBounds:!1,bounds:{},bounceOnBounds:!1}},(t=[{key:"update",value:function(e){this.isMoving?this.updateSlidingMovement(e):this.physics.velocity.x=0,this.animationTime=(this.animationTime||0)+e}},{key:"updateSlidingMovement",value:function(e){var t=this.initialX-this.moveRange/2,i=this.initialX+this.moveRange/2;this.physics.velocity.x=this.moveDirection*this.moveSpeed;var n=this.position.x+this.physics.velocity.x*e;n<=t?(this.position.x=t,this.moveDirection=1,this.onDirectionChange()):n>=i?(this.position.x=i,this.moveDirection=-1,this.onDirectionChange()):this.position.x=n;var o=Math.min(Math.abs(this.position.x-t),Math.abs(this.position.x-i));if(o<20){var r=Math.max(.3,o/20);this.physics.velocity.x*=r}}},{key:"onDirectionChange",value:function(){this.directionChangeTime=this.animationTime||0}},{key:"isPlayerStandingOn",value:function(e){if(!this.isMoving)return!1;var t=e.position.y+e.size.height/2,i=this.position.y-this.size.height/2;return Math.abs(t-i)<=5&&e.position.x>=this.position.x-this.size.width/2&&e.position.x<=this.position.x+this.size.width/2&&e.physics.velocity.y>=0}},{key:"movePlayerWithPlatform",value:function(e,t){if(this.isPlayerStandingOn(e)){var i=this.physics.velocity.x*t;e.position.x+=i;var n=e.size.width/2;e.position.x-n<0?e.position.x=n:e.position.x+n>400&&(e.position.x=400-n)}}},{key:"render",value:function(e){switch(e.save(),this.type){case rt:this.renderNormalPlatform(e);break;case at:this.renderSmallPlatform(e);break;case st:this.renderSlidingPlatform(e);break;case lt:this.renderSpikyPlatform(e)}e.restore()}},{key:"renderNormalPlatform",value:function(e){e.fillStyle=this.colors[this.type],this.drawRoundedRect(e,this.position.x-this.size.width/2,this.position.y-this.size.height/2,this.size.width,this.size.height,4),e.fillStyle="rgba(255, 255, 255, 0.3)",this.drawRoundedRect(e,this.position.x-this.size.width/2,this.position.y-this.size.height/2,this.size.width,this.size.height/2,4)}},{key:"renderSmallPlatform",value:function(e){e.fillStyle=this.colors[this.type],e.globalAlpha=.9,this.drawRoundedRect(e,this.position.x-this.size.width/2,this.position.y-this.size.height/2,this.size.width,this.size.height,6),e.globalAlpha=1,e.strokeStyle="#2980B9",e.lineWidth=2,e.strokeRect(this.position.x-this.size.width/2,this.position.y-this.size.height/2,this.size.width,this.size.height)}},{key:"renderSlidingPlatform",value:function(e){this.renderTrack(e);var t=.1*Math.sin(4*(this.animationTime||0))+1;e.fillStyle=this.colors[this.type],e.globalAlpha=t,this.drawRoundedRect(e,this.position.x-this.size.width/2,this.position.y-this.size.height/2,this.size.width,this.size.height,4),e.globalAlpha=1,this.renderMovingIndicator(e),this.renderSpeedLines(e),this.directionChangeTime&&this.animationTime-this.directionChangeTime<.2&&this.renderDirectionChangeEffect(e)}},{key:"renderTrack",value:function(e){var t=this.initialX-this.moveRange/2,i=this.initialX+this.moveRange/2;e.fillStyle="rgba(249, 202, 36, 0.2)",e.fillRect(t-5,this.position.y-2,i-t+10,4),e.strokeStyle="rgba(249, 202, 36, 0.6)",e.lineWidth=1,e.setLineDash([3,3]),e.beginPath(),e.moveTo(t,this.position.y-15),e.lineTo(t,this.position.y+15),e.stroke(),e.beginPath(),e.moveTo(i,this.position.y-15),e.lineTo(i,this.position.y+15),e.stroke(),e.setLineDash([])}},{key:"renderSpeedLines",value:function(e){if(!(Math.abs(this.physics.velocity.x)<10)){e.strokeStyle="rgba(255, 255, 255, 0.6)",e.lineWidth=2;for(var t=0;t<3;t++){var i=-this.moveDirection*(8*(t+1)),n=1-.3*t;e.globalAlpha=n,e.beginPath(),e.moveTo(this.position.x+i,this.position.y-7.5),e.lineTo(this.position.x+i,this.position.y+7.5),e.stroke()}e.globalAlpha=1}}},{key:"renderDirectionChangeEffect",value:function(e){var t=(this.animationTime-this.directionChangeTime)/.2;if(!(t>=1)){var i=.8*(1-t);e.fillStyle="rgba(255, 255, 255, ".concat(i,")");var n=20*t;e.fillRect(this.position.x-this.size.width/2-n,this.position.y-this.size.height/2-n,this.size.width+2*n,this.size.height+2*n)}}},{key:"renderSpikyPlatform",value:function(e){e.fillStyle=this.colors[this.type],e.fillRect(this.position.x-this.size.width/2,this.position.y-this.size.height/2,this.size.width,this.size.height),e.fillStyle="#E74C3C";for(var t=this.position.x-this.size.width/2;t<this.position.x+this.size.width/2;t+=16)e.fillRect(t,this.position.y-this.size.height/2,8,this.size.height);this.renderSpikes(e)}},{key:"drawRoundedRect",value:function(e,t,i,n,o,r){e.beginPath(),e.moveTo(t+r,i),e.lineTo(t+n-r,i),e.quadraticCurveTo(t+n,i,t+n,i+r),e.lineTo(t+n,i+o-r),e.quadraticCurveTo(t+n,i+o,t+n-r,i+o),e.lineTo(t+r,i+o),e.quadraticCurveTo(t,i+o,t,i+o-r),e.lineTo(t,i+r),e.quadraticCurveTo(t,i,t+r,i),e.closePath(),e.fill()}},{key:"renderSpikes",value:function(e){e.fillStyle="#E74C3C";for(var t=Math.floor(this.size.width/15),i=this.size.width/t,n=0;n<t;n++){var o=this.position.x-this.size.width/2+n*i,r=this.position.y-this.size.height/2;e.beginPath(),e.moveTo(o,r),e.lineTo(o+i/2,r-this.spikeHeight),e.lineTo(o+i,r),e.closePath(),e.fill()}}},{key:"renderMovingIndicator",value:function(e){e.fillStyle="#2C3E50";var t=this.position.y+this.size.height/2+5;this.moveDirection>0?(e.beginPath(),e.moveTo(this.position.x-8,t),e.lineTo(this.position.x+8,t),e.lineTo(this.position.x+8-4,t-4),e.moveTo(this.position.x+8,t),e.lineTo(this.position.x+8-4,t+4),e.stroke()):(e.beginPath(),e.moveTo(this.position.x+8,t),e.lineTo(this.position.x-8,t),e.lineTo(this.position.x-8+4,t-4),e.moveTo(this.position.x-8,t),e.lineTo(this.position.x-8+4,t+4),e.stroke())}},{key:"checkCollision",value:function(e){var t=e.getBoundingRect(),i=this.getBoundingRect();return this.isRectColliding(t,i)}},{key:"getBoundingRect",value:function(){return{x:this.position.x-this.size.width/2,y:this.position.y-this.size.height/2,width:this.size.width,height:this.size.height}}},{key:"isRectColliding",value:function(e,t){return e.x<t.x+t.width&&e.x+e.width>t.x&&e.y<t.y+t.height&&e.y+e.height>t.y}},{key:"isDangerous",value:function(){return this.hasSpikes}},{key:"getTopY",value:function(){return this.position.y-this.size.height/2}},{key:"isPlayerAbove",value:function(e){return e.position.y+e.size.height/2<=this.getTopY()+10&&e.position.x>=this.position.x-this.size.width/2&&e.position.x<=this.position.x+this.size.width/2}}])&&nt(e.prototype,t),Object.defineProperty(e,"prototype",{writable:!1}),e;var e,t}();function ut(e){return ut="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},ut(e)}function ht(e,t){if(e){if("string"==typeof e)return ft(e,t);var i={}.toString.call(e).slice(8,-1);return"Object"===i&&e.constructor&&(i=e.constructor.name),"Map"===i||"Set"===i?Array.from(e):"Arguments"===i||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(i)?ft(e,t):void 0}}function ft(e,t){(null==t||t>e.length)&&(t=e.length);for(var i=0,n=Array(t);i<t;i++)n[i]=e[i];return n}function dt(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,pt(n.key),n)}}function pt(e){var t=function(e){if("object"!=ut(e)||!e)return e;var t=e[Symbol.toPrimitive];if(void 0!==t){var i=t.call(e,"string");if("object"!=ut(i))return i;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(e)}(e);return"symbol"==ut(t)?t:t+""}var yt=function(){return e=function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.platforms=[],this.nextPlatformY=0,this.platformSpacing=w.platforms.spacing,this.gameSpeed=1,this.generationConfig={minWidth:w.platforms.minWidth,maxWidth:w.platforms.maxWidth,height:w.platforms.height,spacing:w.platforms.spacing,normalChance:w.platforms.normalChance,smallChance:w.platforms.smallChance,slidingChance:w.platforms.slidingChance,spikeChance:w.platforms.spikeChance},this.generationBounds={minX:80,maxX:520,screenWidth:w.canvas.width},this.cleanupDistance=800},t=[{key:"initialize",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:500,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;this.platforms=[],this.nextPlatformY=e-this.platformSpacing,this.startY=e,this.generateInitialPlatforms(t)}},{key:"generateInitialPlatforms",value:function(e){var t=this.startY+20,i=new ct(300,t,200,rt);this.platforms.push(i),this.nextPlatformY=t;for(var n=e?e.position.y:this.startY-600,o=Math.ceil((t-n)/this.platformSpacing)+5,r=0;r<Math.max(8,Math.ceil(o/2));r++)this.generateNextPlatform()}},{key:"update",value:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;this.platforms.forEach(function(t){t.update&&t.update(e)}),t&&(this.generatePlatformsAhead(t,i),this.cleanupPlatformsBehind(t,i))}},{key:"generatePlatformsAhead",value:function(e,t){var i=t?t.position.y:e.position.y-300;if(0!==this.platforms.length)Math.min.apply(Math,function(e){return function(e){if(Array.isArray(e))return ft(e)}(e)||function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(e)||ht(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}(this.platforms.map(function(e){return e.position.y})))-i>-800&&this.generateNextPlatform();else{this.nextPlatformY=i-100;for(var n=0;n<10;n++)this.generateNextPlatform()}}},{key:"cleanupPlatformsBehind",value:function(e,t){var i=this,n=t?t.position.y+600:e.position.y+300;this.platforms=this.platforms.filter(function(e){return e.position.y<n+i.cleanupDistance})}},{key:"generateNextPlatform",value:function(){var e=this.selectPlatformType(),t=this.selectPlatformWidth(e),i=this.selectPlatformX(t);this.nextPlatformY-=this.platformSpacing;var n=new ct(i,this.nextPlatformY,t,e);return this.platforms.push(n),n}},{key:"selectPlatformType",value:function(){var e=Math.random(),t=0;return e<(t+=this.generationConfig.normalChance)?rt:e<(t+=this.generationConfig.smallChance)?at:e<(t+=this.generationConfig.slidingChance)?st:rt}},{key:"selectPlatformWidth",value:function(e){var t=this.generationConfig.minWidth,i=this.generationConfig.maxWidth;return e===at&&(t=60,i=100),Math.random()*(i-t)+t}},{key:"selectPlatformX",value:function(e){var t=this.generationBounds.minX+e/2,i=this.generationBounds.maxX-e/2;return Math.random()*(i-t)+t}},{key:"getPlatforms",value:function(){return this.platforms}},{key:"getPlatformsInRange",value:function(e,t){return this.platforms.filter(function(i){return i.position.y>=e&&i.position.y<=t})}},{key:"getNearestPlatform",value:function(e){var t=null,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:200;return this.platforms.forEach(function(n){var o=Math.sqrt(Math.pow(n.position.x-e.x,2)+Math.pow(n.position.y-e.y,2));o<i&&(i=o,t=n)}),t}},{key:"checkCollisions",value:function(e){var t,i=function(e){var t="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!t){if(Array.isArray(e)||(t=ht(e))){t&&(e=t);var i=0,n=function(){};return{s:n,n:function(){return i>=e.length?{done:!0}:{done:!1,value:e[i++]}},e:function(e){throw e},f:n}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,r=!0,a=!1;return{s:function(){t=t.call(e)},n:function(){var e=t.next();return r=e.done,e},e:function(e){a=!0,o=e},f:function(){try{r||null==t.return||t.return()}finally{if(a)throw o}}}}(this.platforms);try{for(i.s();!(t=i.n()).done;){var n=t.value;if(n.checkCollision&&n.checkCollision(e))return n}}catch(e){i.e(e)}finally{i.f()}return null}},{key:"setGameSpeed",value:function(e){this.gameSpeed=e,this.platformSpacing=w.platforms.spacing/e}},{key:"adjustDifficulty",value:function(e){var t=Math.min(e/50,1);this.generationConfig.spikeChance=Math.min(w.platforms.spikeChance+.1*t,.3),this.generationConfig.smallChance=Math.min(w.platforms.smallChance+.1*t,.4),this.generationConfig.normalChance=Math.max(w.platforms.normalChance-.2*t,.2)}},{key:"render",value:function(e){this.platforms.forEach(function(t){t.render&&t.render(e)})}},{key:"clear",value:function(){this.platforms=[],this.nextPlatformY=0}},{key:"getStats",value:function(){var e={total:this.platforms.length,types:{normal:0,small:0,sliding:0,spiky:0}};return this.platforms.forEach(function(t){e.types[t.type]++}),e}},{key:"reset",value:function(){this.clear(),this.gameSpeed=1,this.generationConfig={minWidth:w.platforms.minWidth,maxWidth:w.platforms.maxWidth,height:w.platforms.height,spacing:w.platforms.spacing,normalChance:w.platforms.normalChance,smallChance:w.platforms.smallChance,slidingChance:w.platforms.slidingChance,spikeChance:w.platforms.spikeChance}}}],t&&dt(e.prototype,t),Object.defineProperty(e,"prototype",{writable:!1}),e;var e,t}();function vt(e){return vt="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},vt(e)}function mt(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,gt(n.key),n)}}function gt(e){var t=function(e){if("object"!=vt(e)||!e)return e;var t=e[Symbol.toPrimitive];if(void 0!==t){var i=t.call(e,"string");if("object"!=vt(i))return i;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(e)}(e);return"symbol"==vt(t)?t:t+""}var bt=function(){return e=function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.gameEngine=t,this.isPaused=!1,this.showDebugInfo=!1,this.animationTime=0,this.pauseButton={x:0,y:0,width:0,height:0},this.updateResponsiveSizes()},t=[{key:"updateResponsiveSizes",value:function(){var e=w.canvas.scale||1,t=w.canvas.width;this.pauseButton.width=x(60,e),this.pauseButton.height=x(40,e),this.pauseButton.x=t-this.pauseButton.width-x(10,e),this.pauseButton.y=x(10,e)}},{key:"update",value:function(e){this.animationTime+=e,this.handleInput()}},{key:"handleInput",value:function(){var e=this.gameEngine.getSystem("input");if(e){var t=e.getCurrentInput();t&&t.isPressed&&t.isTap&&this.isPointInPauseButton(t.startPosition.x,t.startPosition.y)&&this.togglePause(),e.isKeyPressed&&e.isKeyPressed("Escape")&&this.togglePause(),e.isKeyPressed&&e.isKeyPressed("F3")&&(this.showDebugInfo=!this.showDebugInfo)}}},{key:"isPointInPauseButton",value:function(e,t){return e>=this.pauseButton.x&&e<=this.pauseButton.x+this.pauseButton.width&&t>=this.pauseButton.y&&t<=this.pauseButton.y+this.pauseButton.height}},{key:"togglePause",value:function(){this.gameEngine.getSystem("state")&&(this.isPaused?(this.isPaused=!1,this.gameEngine.resume(),console.log("Game resumed")):(this.isPaused=!0,this.gameEngine.pause(),console.log("Game paused")))}},{key:"render",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};e.save(),this.renderScore(e,t.level||0),this.renderSpeed(e,t.gameSpeed||1),this.renderPauseButton(e),this.showDebugInfo&&this.renderDebugInfo(e,t),this.isPaused&&this.renderPauseOverlay(e),this.renderControls(e),e.restore()}},{key:"renderScore",value:function(e,t){var i=w.canvas.scale||1;e.save();var n=x(120,i),o=x(50,i),r=x(20,i),a=x(20,i);e.fillStyle="rgba(0, 0, 0, 0.6)",e.fillRect(r,a,n,o),e.strokeStyle="#FFD700",e.lineWidth=x(2,i),e.strokeRect(r,a,n,o),e.fillStyle="#FFD700",e.font="bold ".concat(k("large",i),"px Arial"),e.textAlign="center",e.textBaseline="middle",e.shadowColor="rgba(0, 0, 0, 0.8)",e.shadowBlur=x(3,i),e.shadowOffsetX=x(1,i),e.shadowOffsetY=x(1,i),e.fillText("層數: ".concat(t),r+n/2,a+o/2),e.restore()}},{key:"renderSpeed",value:function(e,t){var i=w.canvas.scale||1;e.save();var n=x(100,i),o=x(35,i),r=x(20,i),a=x(80,i);e.fillStyle="rgba(0, 0, 0, 0.5)",e.fillRect(r,a,n,o);var s=(n-x(10,i))*Math.min(t/3,1),l=x(8,i),c=r+x(5,i),u=a+o-x(15,i);e.fillStyle="rgba(255, 255, 255, 0.3)",e.fillRect(c,u,n-x(10,i),l);var h=t<1.5?"#00FF00":t<2.5?"#FFFF00":"#FF0000";e.fillStyle=h,e.fillRect(c,u,s,l),e.fillStyle="#FFFFFF",e.font="".concat(k("small",i),"px Arial"),e.textAlign="center",e.textBaseline="top",e.fillText("速度: ".concat(t.toFixed(1),"x"),r+n/2,a+x(5,i)),e.restore()}},{key:"renderPauseButton",value:function(e){var t=w.canvas.scale||1;e.save(),e.fillStyle=this.isPaused?"rgba(0, 255, 0, 0.8)":"rgba(0, 0, 0, 0.6)",e.fillRect(this.pauseButton.x,this.pauseButton.y,this.pauseButton.width,this.pauseButton.height),e.strokeStyle="#FFFFFF",e.lineWidth=x(2,t),e.strokeRect(this.pauseButton.x,this.pauseButton.y,this.pauseButton.width,this.pauseButton.height),e.fillStyle="#FFFFFF",e.font="bold ".concat(k("small",t),"px Arial"),e.textAlign="center",e.textBaseline="middle";var i=this.isPaused?"繼續":"暫停";e.fillText(i,this.pauseButton.x+this.pauseButton.width/2,this.pauseButton.y+this.pauseButton.height/2),e.restore()}},{key:"renderPauseOverlay",value:function(e){var t=w.canvas.scale||1;e.save(),e.fillStyle="rgba(0, 0, 0, 0.7)",e.fillRect(0,0,e.canvas.width,e.canvas.height),e.fillStyle="#FFFFFF",e.font="bold ".concat(k("xlarge",t),"px Arial"),e.textAlign="center",e.textBaseline="middle",e.shadowColor="rgba(0, 0, 0, 0.8)",e.shadowBlur=x(10,t),e.shadowOffsetX=x(2,t),e.shadowOffsetY=x(2,t);var i=e.canvas.width/2,n=e.canvas.height/2;e.fillText("遊戲暫停",i,n-x(50,t)),e.font="".concat(k("medium",t),"px Arial"),e.shadowBlur=x(5,t),e.fillText("點擊暫停按鈕或按 ESC 繼續",i,n+x(20,t)),e.restore()}},{key:"renderControls",value:function(e){var t=w.canvas.scale||1;e.save(),e.fillStyle="rgba(255, 255, 255, 0.8)",e.font="".concat(k("small",t),"px Arial"),e.textAlign="center",e.textBaseline="bottom";var i=e.canvas.height-x(20,t),n=e.canvas.width/2;e.fillText("左右滑動或 A/D 鍵控制移動 | ESC 暫停 | F3 調試",n,i),e.restore()}},{key:"renderDebugInfo",value:function(e,t){var i,n=w.canvas.scale||1;e.save();var o=x(250,n),r=x(150,n),a=e.canvas.width-o-x(10,n),s=x(60,n);e.fillStyle="rgba(0, 0, 0, 0.8)",e.fillRect(a,s,o,r),e.strokeStyle="#00FF00",e.lineWidth=x(1,n),e.strokeRect(a,s,o,r),e.fillStyle="#00FF00",e.font="".concat(k("small",n),"px monospace"),e.textAlign="left",e.textBaseline="top";var l=x(16,n),c=s+x(10,n);["FPS: ".concat(Math.round(1/(t.deltaTime||.016))),"玩家位置: ".concat(t.playerX||0,", ").concat(t.playerY||0),"玩家速度: ".concat(t.playerVelX||0,", ").concat(t.playerVelY||0),"實體數量: ".concat(t.entityCount||0),"平台數量: ".concat(t.platformCount||0),"遊戲時間: ".concat((t.gameTime||0).toFixed(1),"s"),"記憶體: ".concat(((null===(i=performance.memory)||void 0===i?void 0:i.usedJSHeapSize)/1024/1024).toFixed(1),"MB")].forEach(function(t){e.fillText(t,a+x(10,n),c),c+=l}),e.restore()}},{key:"onResize",value:function(e,t){this.updateResponsiveSizes()}},{key:"reset",value:function(){this.isPaused=!1,this.animationTime=0,this.updateResponsiveSizes()}}],t&&mt(e.prototype,t),Object.defineProperty(e,"prototype",{writable:!1}),e;var e,t}();function wt(e){return wt="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},wt(e)}function St(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,kt(n.key),n)}}function kt(e){var t=function(e){if("object"!=wt(e)||!e)return e;var t=e[Symbol.toPrimitive];if(void 0!==t){var i=t.call(e,"string");if("object"!=wt(i))return i;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(e)}(e);return"symbol"==wt(t)?t:t+""}var xt=function(){return e=function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.gameEngine=t,this.isVisible=!1,this.animationTime=0,this.fadeInDuration=1,this.restartButton={x:0,y:0,width:0,height:0},this.menuButton={x:0,y:0,width:0,height:0},this.gameData={level:0,gameTime:0,isNewRecord:!1,rank:-1},this.updateResponsiveSizes()},t=[{key:"updateResponsiveSizes",value:function(){var e=w.canvas.scale||1,t=w.canvas.width,i=w.canvas.height,n=x(180,e),o=x(50,e),r=x(20,e);this.restartButton.width=n,this.restartButton.height=o,this.restartButton.x=t/2-n-r/2,this.restartButton.y=i/2+x(80,e),this.menuButton.width=n,this.menuButton.height=o,this.menuButton.x=t/2+r/2,this.menuButton.y=i/2+x(80,e)}},{key:"show",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};this.isVisible=!0,this.animationTime=0,this.gameData={level:e.level||0,gameTime:e.gameTime||0,isNewRecord:e.isNewRecord||!1,rank:e.rank||-1},console.log("Game Over screen shown with data:",this.gameData)}},{key:"hide",value:function(){this.isVisible=!1,this.animationTime=0}},{key:"update",value:function(e){this.isVisible&&(this.animationTime+=e,this.handleInput())}},{key:"handleInput",value:function(){var e=this.gameEngine.getSystem("input");if(e){var t=e.getCurrentInput();if(t&&t.isPressed&&t.isTap){var i=t.startPosition.x,n=t.startPosition.y;this.isPointInButton(i,n,this.restartButton)?this.restartGame():this.isPointInButton(i,n,this.menuButton)&&this.returnToMenu()}e.isKeyPressed&&(e.isKeyPressed("Enter")||e.isKeyPressed("Space")?this.restartGame():e.isKeyPressed("Escape")&&this.returnToMenu())}}},{key:"isPointInButton",value:function(e,t,i){return e>=i.x&&e<=i.x+i.width&&t>=i.y&&t<=i.y+i.height}},{key:"restartGame",value:function(){console.log("Restarting game..."),this.hide();var e=this.gameEngine.getCurrentScene();e&&e.restartGame&&e.restartGame()}},{key:"returnToMenu",value:function(){console.log("Returning to menu..."),this.hide();var e=this.gameEngine.getSystem("state");e&&(e.changeState(s.MENU),this.gameEngine.switchScene("menu"))}},{key:"render",value:function(e){if(this.isVisible){e.save();var t=Math.min(this.animationTime/this.fadeInDuration,1);this.renderBackground(e,t),this.renderContent(e,t),this.renderButtons(e,t),e.restore()}}},{key:"renderBackground",value:function(e,t){e.save(),e.fillStyle="rgba(0, 0, 0, ".concat(.8*t,")"),e.fillRect(0,0,e.canvas.width,e.canvas.height);var i=e.createRadialGradient(e.canvas.width/2,e.canvas.height/2,0,e.canvas.width/2,e.canvas.height/2,e.canvas.width/2);i.addColorStop(0,"rgba(139, 69, 19, ".concat(.3*t,")")),i.addColorStop(1,"rgba(0, 0, 0, ".concat(.5*t,")")),e.fillStyle=i,e.fillRect(0,0,e.canvas.width,e.canvas.height),e.restore()}},{key:"renderContent",value:function(e,t){var i=w.canvas.scale||1,n=e.canvas.width/2,o=e.canvas.height/2;e.save(),e.globalAlpha=t,e.fillStyle="#FF6B6B",e.font="bold ".concat(k("xlarge",1.5*i),"px Arial"),e.textAlign="center",e.textBaseline="middle",e.shadowColor="rgba(0, 0, 0, 0.8)",e.shadowBlur=x(10,i),e.shadowOffsetX=x(3,i),e.shadowOffsetY=x(3,i);var r=Math.sin(3*this.animationTime)*x(5,i);e.fillText("遊戲結束",n,o-x(120,i)+r),e.fillStyle="#FFD700",e.font="bold ".concat(k("large",i),"px Arial"),e.shadowBlur=x(5,i),e.fillText("最終層數: ".concat(this.gameData.level),n,o-x(70,i));var a=Math.floor(this.gameData.gameTime/60),s=Math.floor(this.gameData.gameTime%60);if(e.fillStyle="#FFFFFF",e.font="".concat(k("medium",i),"px Arial"),e.fillText("遊戲時間: ".concat(a,":").concat(s.toString().padStart(2,"0")),n,o-x(40,i)),this.gameData.isNewRecord){e.fillStyle="#00FF00",e.font="bold ".concat(k("medium",i),"px Arial");var l=(Math.sin(8*this.animationTime)+1)/2;e.globalAlpha=t*l,e.fillText("🎉 新記錄！ 🎉",n,o-x(10,i)),e.globalAlpha=t}this.gameData.rank>0&&(e.fillStyle="#BDC3C7",e.font="".concat(k("small",i),"px Arial"),e.fillText("排名: 第 ".concat(this.gameData.rank," 名"),n,o+x(20,i))),e.restore()}},{key:"renderButtons",value:function(e,t){var i=w.canvas.scale||1;e.save(),e.globalAlpha=t,this.renderButton(e,this.restartButton,"重新開始","#4ECDC4",i),this.renderButton(e,this.menuButton,"返回選單","#95A5A6",i),e.fillStyle="rgba(255, 255, 255, 0.8)",e.font="".concat(k("small",i),"px Arial"),e.textAlign="center",e.textBaseline="top";var n=Math.max(this.restartButton.y,this.menuButton.y)+this.restartButton.height+x(20,i);e.fillText("Enter/空格鍵重新開始 | ESC返回選單",e.canvas.width/2,n),e.restore()}},{key:"renderButton",value:function(e,t,i,n,o){e.save(),e.fillStyle=n,e.fillRect(t.x,t.y,t.width,t.height),e.strokeStyle="#FFFFFF",e.lineWidth=x(2,o),e.strokeRect(t.x,t.y,t.width,t.height),e.fillStyle="#FFFFFF",e.font="bold ".concat(k("medium",o),"px Arial"),e.textAlign="center",e.textBaseline="middle",e.shadowColor="rgba(0, 0, 0, 0.5)",e.shadowBlur=x(3,o),e.shadowOffsetX=x(1,o),e.shadowOffsetY=x(1,o),e.fillText(i,t.x+t.width/2,t.y+t.height/2),e.restore()}},{key:"onResize",value:function(e,t){this.updateResponsiveSizes()}},{key:"reset",value:function(){this.isVisible=!1,this.animationTime=0,this.gameData={level:0,gameTime:0,isNewRecord:!1,rank:-1}}}],t&&St(e.prototype,t),Object.defineProperty(e,"prototype",{writable:!1}),e;var e,t}();function Pt(e){return Pt="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},Pt(e)}function Et(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,Tt(n.key),n)}}function Tt(e){var t=function(e){if("object"!=Pt(e)||!e)return e;var t=e[Symbol.toPrimitive];if(void 0!==t){var i=t.call(e,"string");if("object"!=Pt(i))return i;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(e)}(e);return"symbol"==Pt(t)?t:t+""}const Ot=function(){return e=function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.storagePrefix="infiniteJump_",this.isStorageAvailable=this.checkStorageAvailability()},t=[{key:"checkStorageAvailability",value:function(){try{var e=this.storagePrefix+"test";return localStorage.setItem(e,"test"),localStorage.removeItem(e),!0}catch(e){return console.warn("localStorage not available:",e),!1}}},{key:"getStorageKey",value:function(e){return this.storagePrefix+e}},{key:"serialize",value:function(e){try{return JSON.stringify(e)}catch(e){throw console.error("Failed to serialize data:",e),new Error("Data serialization failed")}}},{key:"deserialize",value:function(e){try{return JSON.parse(e)}catch(e){throw console.error("Failed to deserialize data:",e),new Error("Data deserialization failed")}}},{key:"save",value:function(e,t){if(!this.isStorageAvailable)return console.warn("Storage not available, cannot save data"),!1;try{var i=this.getStorageKey(e),n=this.serialize(t);return localStorage.setItem(i,n),!0}catch(e){return console.error("Failed to save data:",e),!1}}},{key:"load",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;if(!this.isStorageAvailable)return console.warn("Storage not available, returning default value"),t;try{var i=this.getStorageKey(e),n=localStorage.getItem(i);return null===n?t:this.deserialize(n)}catch(e){return console.error("Failed to load data:",e),t}}},{key:"remove",value:function(e){if(!this.isStorageAvailable)return console.warn("Storage not available, cannot remove data"),!1;try{var t=this.getStorageKey(e);return localStorage.removeItem(t),!0}catch(e){return console.error("Failed to remove data:",e),!1}}},{key:"clear",value:function(){if(!this.isStorageAvailable)return console.warn("Storage not available, cannot clear data"),!1;try{for(var e=[],t=0;t<localStorage.length;t++){var i=localStorage.key(t);i&&i.startsWith(this.storagePrefix)&&e.push(i)}return e.forEach(function(e){localStorage.removeItem(e)}),!0}catch(e){return console.error("Failed to clear data:",e),!1}}},{key:"getAllKeys",value:function(){if(!this.isStorageAvailable)return[];var e=[];try{for(var t=0;t<localStorage.length;t++){var i=localStorage.key(t);i&&i.startsWith(this.storagePrefix)&&e.push(i.substring(this.storagePrefix.length))}}catch(e){console.error("Failed to get keys:",e)}return e}},{key:"exists",value:function(e){if(!this.isStorageAvailable)return!1;try{var t=this.getStorageKey(e);return null!==localStorage.getItem(t)}catch(e){return console.error("Failed to check key existence:",e),!1}}},{key:"getStorageStats",value:function(){var e=this;if(!this.isStorageAvailable)return{available:!1,totalKeys:0,gameKeys:0,estimatedSize:0};try{var t=this.getAllKeys(),i=0;return t.forEach(function(t){var n=localStorage.getItem(e.getStorageKey(t));n&&(i+=n.length)}),{available:!0,totalKeys:localStorage.length,gameKeys:t.length,estimatedSize:i}}catch(e){return console.error("Failed to get storage stats:",e),{available:!1,totalKeys:0,gameKeys:0,estimatedSize:0}}}}],t&&Et(e.prototype,t),Object.defineProperty(e,"prototype",{writable:!1}),e;var e,t}();function Mt(e){return Mt="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},Mt(e)}function Ct(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),i.push.apply(i,n)}return i}function At(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?Ct(Object(i),!0).forEach(function(t){jt(e,t,i[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):Ct(Object(i)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))})}return e}function jt(e,t,i){return(t=Rt(t))in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}function zt(e){return function(e){if(Array.isArray(e))return It(e)}(e)||function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(e)||Ft(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function Ft(e,t){if(e){if("string"==typeof e)return It(e,t);var i={}.toString.call(e).slice(8,-1);return"Object"===i&&e.constructor&&(i=e.constructor.name),"Map"===i||"Set"===i?Array.from(e):"Arguments"===i||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(i)?It(e,t):void 0}}function It(e,t){(null==t||t>e.length)&&(t=e.length);for(var i=0,n=Array(t);i<t;i++)n[i]=e[i];return n}function Bt(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,Rt(n.key),n)}}function Rt(e){var t=function(e){if("object"!=Mt(e)||!e)return e;var t=e[Symbol.toPrimitive];if(void 0!==t){var i=t.call(e,"string");if("object"!=Mt(i))return i;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(e)}(e);return"symbol"==Mt(t)?t:t+""}const Dt=function(){return e=function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.storageManager=new Ot,this.storageKey="leaderboard",this.maxEntries=10,this.defaultLeaderboard={entries:[],lastUpdated:null,version:"1.0"}},t=[{key:"getLeaderboardData",value:function(){return this.storageManager.load(this.storageKey,this.defaultLeaderboard)}},{key:"saveLeaderboardData",value:function(e){return e.lastUpdated=Date.now(),this.storageManager.save(this.storageKey,e)}},{key:"addScore",value:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};if(!e||"string"!=typeof e||0===e.trim().length)return console.warn("Invalid player name provided:",e),{success:!1,rank:null,isNewRecord:!1};if("number"!=typeof t||t<0)return console.warn("Invalid score provided:",t),{success:!1,rank:null,isNewRecord:!1};try{var n=this.getLeaderboardData(),o=zt(n.entries),r=At({id:this.generateEntryId(),playerName:e.trim(),score:t,timestamp:Date.now()},i);o.push(r),o.sort(function(e,t){return t.score-e.score});var a=o.slice(0,this.maxEntries),s=a.findIndex(function(e){return e.id===r.id});if(-1!==s){var l=0===s,c=s+1,u=At(At({},n),{},{entries:a});return this.saveLeaderboardData(u)?(console.log("Score added to leaderboard: ".concat(e," - ").concat(t," (Rank: ").concat(c,")")),{success:!0,rank:c,isNewRecord:l}):(console.error("Failed to save leaderboard data"),{success:!1,rank:null,isNewRecord:!1})}return{success:!0,rank:null,isNewRecord:!1}}catch(e){return console.error("Failed to add score to leaderboard:",e),{success:!1,rank:null,isNewRecord:!1}}}},{key:"getTopScores",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.maxEntries;try{return(this.getLeaderboardData().entries||[]).sort(function(e,t){return t.score-e.score}).slice(0,Math.max(1,Math.min(e,this.maxEntries)))}catch(e){return console.error("Failed to get top scores:",e),[]}}},{key:"getPlayerRank",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;if(!e||"string"!=typeof e)return null;try{for(var i=this.getTopScores(),n=0;n<i.length;n++){var o=i[n];if(o.playerName===e.trim()){if(null!==t&&o.score!==t)continue;return n+1}}return null}catch(e){return console.error("Failed to get player rank:",e),null}}},{key:"canEnterLeaderboard",value:function(e){if("number"!=typeof e||e<0)return!1;try{var t=this.getTopScores();return t.length<this.maxEntries||e>t[t.length-1].score}catch(e){return console.error("Failed to check leaderboard entry eligibility:",e),!1}}},{key:"getLeaderboardStats",value:function(){try{var e=this.getLeaderboardData(),t=e.entries||[];if(0===t.length)return{totalEntries:0,highestScore:0,lowestScore:0,averageScore:0,lastUpdated:e.lastUpdated};var i=t.map(function(e){return e.score}),n=i.reduce(function(e,t){return e+t},0);return{totalEntries:t.length,highestScore:Math.max.apply(Math,zt(i)),lowestScore:Math.min.apply(Math,zt(i)),averageScore:Math.round(n/t.length),lastUpdated:e.lastUpdated}}catch(e){return console.error("Failed to get leaderboard stats:",e),{totalEntries:0,highestScore:0,lowestScore:0,averageScore:0,lastUpdated:null}}}},{key:"clearLeaderboard",value:function(){try{var e=At(At({},this.defaultLeaderboard),{},{lastUpdated:Date.now()}),t=this.saveLeaderboardData(e);return t&&console.log("Leaderboard cleared successfully"),t}catch(e){return console.error("Failed to clear leaderboard:",e),!1}}},{key:"removePlayerRecord",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;if(!e||"string"!=typeof e)return!1;try{var i=this.getLeaderboardData(),n=i.entries||[],o=n.filter(function(i){return i.playerName!==e.trim()||null!==t&&i.score!==t});if(o.length===n.length)return!1;var r=At(At({},i),{},{entries:o}),a=this.saveLeaderboardData(r);return a&&console.log("Removed record for player: ".concat(e)),a}catch(e){return console.error("Failed to remove player record:",e),!1}}},{key:"exportLeaderboard",value:function(){try{var e=this.getLeaderboardData();return JSON.stringify(e,null,2)}catch(e){return console.error("Failed to export leaderboard:",e),null}}},{key:"importLeaderboard",value:function(e){try{var t=JSON.parse(e);return this.validateLeaderboardData(t)?(t.entries&&(t.entries.sort(function(e,t){return t.score-e.score}),t.entries=t.entries.slice(0,this.maxEntries)),this.saveLeaderboardData(t)):(console.warn("Invalid leaderboard data structure"),!1)}catch(e){return console.error("Failed to import leaderboard:",e),!1}}},{key:"validateLeaderboardData",value:function(e){if(!e||"object"!==Mt(e))return!1;if(!Array.isArray(e.entries))return!1;var t,i=function(e){var t="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!t){if(Array.isArray(e)||(t=Ft(e))){t&&(e=t);var i=0,n=function(){};return{s:n,n:function(){return i>=e.length?{done:!0}:{done:!1,value:e[i++]}},e:function(e){throw e},f:n}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,r=!0,a=!1;return{s:function(){t=t.call(e)},n:function(){var e=t.next();return r=e.done,e},e:function(e){a=!0,o=e},f:function(){try{r||null==t.return||t.return()}finally{if(a)throw o}}}}(e.entries);try{for(i.s();!(t=i.n()).done;){var n=t.value;if(!n||"object"!==Mt(n))return!1;if(!n.playerName||"string"!=typeof n.playerName)return!1;if("number"!=typeof n.score||n.score<0)return!1;if(n.timestamp&&"number"!=typeof n.timestamp)return!1}}catch(e){i.e(e)}finally{i.f()}return!0}},{key:"generateEntryId",value:function(){return"entry_".concat(Date.now(),"_").concat(Math.random().toString(36).substr(2,9))}},{key:"getVersion",value:function(){return this.getLeaderboardData().version||"1.0"}},{key:"mergeLeaderboards",value:function(e){if(!Array.isArray(e)||0===e.length)return!1;try{var t=[];e.forEach(function(e){e&&Array.isArray(e.entries)&&t.push.apply(t,zt(e.entries))});var i=[],n=new Set;t.forEach(function(e){var t="".concat(e.playerName,"_").concat(e.score);n.has(t)||(n.add(t),i.push(e))}),i.sort(function(e,t){return t.score-e.score});var o={entries:i.slice(0,this.maxEntries),lastUpdated:Date.now(),version:"1.0"};return this.saveLeaderboardData(o)}catch(e){return console.error("Failed to merge leaderboards:",e),!1}}}],t&&Bt(e.prototype,t),Object.defineProperty(e,"prototype",{writable:!1}),e;var e,t}();function Lt(e){return Lt="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},Lt(e)}function Wt(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,Gt(n.key),n)}}function Gt(e){var t=function(e){if("object"!=Lt(e)||!e)return e;var t=e[Symbol.toPrimitive];if(void 0!==t){var i=t.call(e,"string");if("object"!=Lt(i))return i;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(e)}(e);return"symbol"==Lt(t)?t:t+""}function Yt(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch(e){}return(Yt=function(){return!!e})()}function Nt(e,t,i,n){var o=Vt(_t(1&n?e.prototype:e),t,i);return 2&n&&"function"==typeof o?function(e){return o.apply(i,e)}:o}function Vt(){return Vt="undefined"!=typeof Reflect&&Reflect.get?Reflect.get.bind():function(e,t,i){var n=function(e,t){for(;!{}.hasOwnProperty.call(e,t)&&null!==(e=_t(e)););return e}(e,t);if(n){var o=Object.getOwnPropertyDescriptor(n,t);return o.get?o.get.call(arguments.length<3?e:i):o.value}},Vt.apply(null,arguments)}function _t(e){return _t=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(e){return e.__proto__||Object.getPrototypeOf(e)},_t(e)}function Ut(e,t){return Ut=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e},Ut(e,t)}var Ht=function(e){function t(e){var i;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),(i=function(e,t,i){return t=_t(t),function(e,t){if(t&&("object"==Lt(t)||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e)}(e,Yt()?Reflect.construct(t,i||[],_t(e).constructor):t.apply(e,i))}(this,t,["game"])).gameEngine=e,i.player=null,i.platforms=[],i.score=0,i.level=0,i.gameSpeed=1,i.isGameOver=!1,i.camera=null,i.physics=null,i.platformManager=null,i.gameTime=0,i.lastJumpTime=0,i.jumpInterval=w.game.initialJumpInterval,i.leaderboard=new Dt,i.hudManager=new bt(e),i.gameOverManager=new xt(e),i}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&Ut(e,t)}(t,e),i=t,(n=[{key:"enter",value:function(){Nt(t,"enter",this,3)([]),this.camera=this.gameEngine.getSystem("camera");var e=this.gameEngine.getSystem("audio");e&&e.playBackgroundMusic("backgroundMusic",{volume:.3}),this.physics=new I,this.registerSystem("physics",this.physics),this.platformManager=new yt,this.registerSystem("gameOver",this.gameOverManager),this.initializeGame()}},{key:"exit",value:function(){Nt(t,"exit",this,3)([]);var e=this.gameEngine.getSystem("audio");e&&e.stopBackgroundMusic(),this.cleanup()}},{key:"initializeGame",value:function(){var e=this;try{console.log("Initializing game...");var t=w.canvas.height,i=w.canvas.width;this.camera&&this.camera.canvas&&(t=this.camera.canvas.height,i=this.camera.canvas.width),console.log("Step 1 - Canvas dimensions:",{configHeight:w.canvas.height,actualHeight:t,configWidth:w.canvas.width,actualWidth:i});var n=t-50;console.log("Step 2 - Player target position:",{playerBottomY:n,calculation:"".concat(t," - 50 = ").concat(n)});var o=this.gameEngine.getSystem("audio");if(this.player=new et(w.player.startPosition.x,n,o),this.addEntity(this.player),console.log("Step 3 - Player created at:",{x:this.player.position.x,y:this.player.position.y}),this.camera){this.camera.setTarget(this.player);var r=w.camera.offsetY,a=this.player.position.y-(t-r);console.log("Step 4 - Camera calculation:",{playerY:this.player.position.y,canvasHeight:t,offsetY:r,calculation:"".concat(this.player.position.y," - (").concat(t," - ").concat(r,") = ").concat(a),cameraY:a}),this.camera.setPosition(this.player.position.x-i/2,a),console.log("Step 4 - Camera positioned at:",{x:this.camera.position.x,y:this.camera.position.y})}this.platformManager.initialize(this.player.position.y,this.camera),this.platforms=this.platformManager.getPlatforms(),this.platforms.forEach(function(t){e.addEntity(t),e.physics&&e.physics.addEntity(t)}),console.log("Platform manager initialized with",this.platforms.length,"platforms"),this.score=0,this.level=0,this.gameSpeed=1,this.isGameOver=!1,this.gameTime=0,this.lastJumpTime=0,this.jumpInterval=w.game.initialJumpInterval,console.log("Game initialized successfully"),console.log("Player:",this.player),console.log("Platforms:",this.platforms.length)}catch(e){console.error("Error initializing game:",e)}}},{key:"update",value:function(e){var t=this;if(this.isGameOver)return this.hudManager&&this.hudManager.update(e),void(this.gameOverManager&&this.gameOverManager.update(e));if(this.gameTime+=e,this.handlePlayerInput(),this.handleAutoJump(e),this.platformManager){this.platformManager.update(e,this.player,this.camera);var i=this.platformManager.getPlatforms();i.forEach(function(e){t.platforms.includes(e)||(t.platforms.push(e),t.addEntity(e),t.physics&&t.physics.addEntity(e))}),this.platforms=this.platforms.filter(function(e){return!!i.includes(e)||(t.removeEntity(e),t.physics&&t.physics.removeEntity(e),!1)})}this.player&&(this.player.update(e,this.platforms),this.platforms.forEach(function(i){i.isMoving&&i.movePlayerWithPlatform&&i.movePlayerWithPlatform(t.player,e)})),this.entities.forEach(function(i){i!==t.player&&i.update&&i.update(e)}),this.systems.forEach(function(t){t.update&&t.update(e)}),this.updateCamera(e),this.hudManager&&this.hudManager.update(e),this.gameOverManager&&this.gameOverManager.update(e),this.checkGameOver()}},{key:"render",value:function(e){this.renderBackground(e),this.camera?(this.camera.applyTransform(e),Nt(t,"render",this,3)([e]),this.camera.restoreTransform(e)):Nt(t,"render",this,3)([e]),this.renderUI(e)}},{key:"renderBackground",value:function(e){var t=e.createLinearGradient(0,0,0,e.canvas.height);t.addColorStop(0,"#87CEEB"),t.addColorStop(1,"#98FB98"),e.fillStyle=t,e.fillRect(0,0,e.canvas.width,e.canvas.height)}},{key:"renderUI",value:function(e){if(this.hudManager){var t={level:this.level,gameSpeed:this.gameSpeed,deltaTime:.016,playerX:this.player?Math.round(this.player.position.x):0,playerY:this.player?Math.round(this.player.position.y):0,playerVelX:this.player?Math.round(this.player.physics.velocity.x):0,playerVelY:this.player?Math.round(this.player.physics.velocity.y):0,entityCount:this.entities.length,platformCount:this.platforms.length,gameTime:this.gameTime};this.hudManager.render(e,t)}this.renderTouchIndicators(e),this.isGameOver&&this.gameOverManager&&this.gameOverManager.render(e)}},{key:"renderGameOverUI",value:function(e){e.fillStyle="rgba(0, 0, 0, 0.7)",e.fillRect(0,0,e.canvas.width,e.canvas.height),e.fillStyle="#FFFFFF",e.font="bold 36px Arial",e.textAlign="center",e.textBaseline="middle",e.fillText("遊戲結束",e.canvas.width/2,e.canvas.height/2-100),e.font="24px Arial",e.fillText("最終層數: ".concat(this.level),e.canvas.width/2,e.canvas.height/2-50);var t=Math.floor(this.gameTime/60),i=Math.floor(this.gameTime%60);e.font="18px Arial",e.fillStyle="#BDC3C7",e.fillText("遊戲時間: ".concat(t,":").concat(i.toString().padStart(2,"0")),e.canvas.width/2,e.canvas.height/2-20),this.renderLeaderboardStatus(e),e.font="16px Arial",e.fillStyle="#FFD700",e.fillText("點擊任意位置重新開始",e.canvas.width/2,e.canvas.height/2+60),e.font="14px Arial",e.fillStyle="#95A5A6",e.fillText("或按 ESC 返回主選單",e.canvas.width/2,e.canvas.height/2+85)}},{key:"renderLeaderboardStatus",value:function(e){try{var t=this.getPlayerName(),i=this.leaderboard.getPlayerRank(t,this.level),n=this.leaderboard.canEnterLeaderboard(this.level);e.save(),e.font="16px Arial",e.textAlign="center",e.textBaseline="middle",1===i?(e.fillStyle="#F1C40F",e.fillText("🏆 新的最高記錄！",e.canvas.width/2,e.canvas.height/2+10)):i&&i<=10?(e.fillStyle="#E67E22",e.fillText("🎉 排行榜第 ".concat(i," 名！"),e.canvas.width/2,e.canvas.height/2+10)):n?(e.fillStyle="#3498DB",e.fillText("分數已記錄到排行榜",e.canvas.width/2,e.canvas.height/2+10)):(e.fillStyle="#95A5A6",e.fillText("繼續努力，爭取進入排行榜！",e.canvas.width/2,e.canvas.height/2+10)),e.restore()}catch(e){console.error("渲染排行榜狀態時發生錯誤:",e)}}},{key:"handlePlayerInput",value:function(){var e=this.gameEngine.getSystem("input");if(e&&this.player){var t=e.getCurrentInput();if(e.isMovingLeft()?this.player.moveLeft():e.isMovingRight()?this.player.moveRight():this.player.stopMoving(),t.isPressed&&(t.isLongPress&&e.isLongPress()&&this.pause(),this.isGameOver&&t.isTap&&this.restartGame()),this.isGameOver){if(e.isKeyPressed&&e.isKeyHeld){if(e.isKeyPressed("Escape"))return console.log("ESC pressed, returning to menu..."),void this.returnToMenu();if(e.isKeyPressed("Enter")||e.isKeyPressed("Space"))return console.log("Enter/Space pressed, restarting game..."),void this.restartGame()}if(t&&t.isPressed&&t.isTap)return console.log("Game over tap detected, restarting game..."),void this.restartGame()}}}},{key:"handleAutoJump",value:function(e){this.player&&!this.isGameOver&&this.player.isGrounded&&this.gameTime-this.lastJumpTime>=this.jumpInterval&&(this.player.jump(),this.lastJumpTime=this.gameTime,this.level++,this.updateGameSpeed())}},{key:"updateGameSpeed",value:function(){var e=Math.floor(this.level/w.game.difficultyIncreaseInterval)*w.game.speedIncrement;this.gameSpeed=Math.min(1+e,w.game.maxSpeedMultiplier),this.jumpInterval=Math.max(w.game.initialJumpInterval/this.gameSpeed,w.game.minJumpInterval)}},{key:"updateCamera",value:function(e){if(this.camera){var t=this.camera.position.y;this.camera.update(e);var i=this.camera.position.y;Math.abs(i-t)>.1&&console.log("Camera moved:",{playerY:this.player?this.player.position.y:"no player",oldCameraY:t,newCameraY:i,cameraTarget:this.camera.target?"has target":"no target"}),this.player&&!this.player.isAlive&&this.camera.startShake(10,.5)}}},{key:"checkGameOver",value:function(){if(this.player)if(this.player.isAlive){var e=this.camera?this.camera.position.y:0,t=this.camera?this.camera.canvas.height:w.canvas.height;this.player.position.y-(e+t)>200&&(console.log("Player fell too far, triggering game over"),this.gameOver())}else this.gameOver()}},{key:"gameOver",value:function(){this.isGameOver=!0,this.player.die(),console.log("Game Over! Final level: ".concat(this.level));var e=this.saveScoreToLeaderboard();if(this.gameOverManager){var t={level:this.level,gameTime:this.gameTime,isNewRecord:e.isNewRecord||!1,rank:e.rank||-1};this.gameOverManager.show(t)}}},{key:"saveScoreToLeaderboard",value:function(){var e={isNewRecord:!1,rank:-1};try{if(this.leaderboard.canEnterLeaderboard(this.level)){var t=this.getPlayerName(),i={gameTime:Math.round(this.gameTime),gameSpeed:this.gameSpeed,timestamp:Date.now()},n=this.leaderboard.addScore(t,this.level,i);n.success&&n.rank?(console.log("新記錄！排名第 ".concat(n.rank," 名")),e.rank=n.rank,n.isNewRecord&&(console.log("恭喜！創造了新的最高記錄！"),e.isNewRecord=!0)):n.success?console.log("分數已記錄，但未進入前10名"):console.log("分數記錄失敗")}else console.log("分數未達到排行榜標準")}catch(e){console.error("保存分數到排行榜時發生錯誤:",e)}return e}},{key:"getPlayerName",value:function(){var e=(new Date).toLocaleTimeString("zh-TW",{hour:"2-digit",minute:"2-digit"});return"玩家".concat(e)}},{key:"restartGame",value:function(){this.cleanup(),this.initializeGame()}},{key:"returnToMenu",value:function(){var e=this.gameEngine.getSystem("state");e&&(e.changeState(s.MENU),this.gameEngine.switchScene("menu"))}},{key:"cleanup",value:function(){this.clearEntities(),this.physics&&this.physics.clearEntities(),this.platformManager&&this.platformManager.clear(),this.hudManager&&this.hudManager.reset(),this.gameOverManager&&this.gameOverManager.reset(),this.player=null,this.platforms=[]}},{key:"pause",value:function(){var e=this.gameEngine.getSystem("state");e&&e.changeState(s.PAUSED)}},{key:"resume",value:function(){var e=this.gameEngine.getSystem("state");e&&e.changeState(s.PLAYING)}},{key:"renderTouchIndicators",value:function(e){var t=this.gameEngine.getSystem("input");if(t){var i=t.getCurrentInput();e.save(),e.globalAlpha=.1,t.isMovingLeft()&&(e.fillStyle="#FF6B6B",e.fillRect(0,0,e.canvas.width/2,e.canvas.height)),t.isMovingRight()&&(e.fillStyle="#4ECDC4",e.fillRect(e.canvas.width/2,0,e.canvas.width/2,e.canvas.height)),e.restore(),i.isPressed&&(e.save(),e.fillStyle="rgba(255, 255, 255, 0.8)",e.strokeStyle="rgba(0, 0, 0, 0.5)",e.lineWidth=2,e.beginPath(),e.arc(i.startPosition.x,i.startPosition.y,15,0,2*Math.PI),e.fill(),e.stroke(),i.isSwipe&&(e.strokeStyle="rgba(255, 255, 255, 0.6)",e.lineWidth=3,e.beginPath(),e.moveTo(i.startPosition.x,i.startPosition.y),e.lineTo(i.currentPosition.x,i.currentPosition.y),e.stroke(),e.fillStyle="rgba(255, 255, 0, 0.8)",e.beginPath(),e.arc(i.currentPosition.x,i.currentPosition.y,10,0,2*Math.PI),e.fill()),e.restore())}}}])&&Wt(i.prototype,n),Object.defineProperty(i,"prototype",{writable:!1}),i;var i,n}(We);function Kt(e){return Kt="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},Kt(e)}function Xt(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,qt(n.key),n)}}function qt(e){var t=function(e){if("object"!=Kt(e)||!e)return e;var t=e[Symbol.toPrimitive];if(void 0!==t){var i=t.call(e,"string");if("object"!=Kt(i))return i;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(e)}(e);return"symbol"==Kt(t)?t:t+""}function Jt(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch(e){}return(Jt=function(){return!!e})()}function Zt(e,t,i,n){var o=Qt($t(1&n?e.prototype:e),t,i);return 2&n&&"function"==typeof o?function(e){return o.apply(i,e)}:o}function Qt(){return Qt="undefined"!=typeof Reflect&&Reflect.get?Reflect.get.bind():function(e,t,i){var n=function(e,t){for(;!{}.hasOwnProperty.call(e,t)&&null!==(e=$t(e)););return e}(e,t);if(n){var o=Object.getOwnPropertyDescriptor(n,t);return o.get?o.get.call(arguments.length<3?e:i):o.value}},Qt.apply(null,arguments)}function $t(e){return $t=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(e){return e.__proto__||Object.getPrototypeOf(e)},$t(e)}function ei(e,t){return ei=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e},ei(e,t)}var ti=function(e){function t(e){var i;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),(i=function(e,t,i){return t=$t(t),function(e,t){if(t&&("object"==Kt(t)||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e)}(e,Jt()?Reflect.construct(t,i||[],$t(e).constructor):t.apply(e,i))}(this,t,["leaderboard"])).gameEngine=e,i.leaderboard=new Dt,i.titleY=80,i.headerY=140,i.entryStartY=180,i.entrySpacing=45,i.animationTime=0,i.selectedEntry=-1,i.leaderboardData=[],i.currentPlayerRank=null,i.stats=null,i.backButton={x:50,y:50,width:80,height:35,text:"返回"},i.clearButton={x:0,y:0,width:100,height:35,text:"清空記錄"},i}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&ei(e,t)}(t,e),i=t,(n=[{key:"enter",value:function(){Zt(t,"enter",this,3)([]),this.animationTime=0,this.selectedEntry=-1,this.adjustLayoutForScreen(),this.loadLeaderboardData(),console.log("LeaderboardScene entered successfully")}},{key:"adjustLayoutForScreen",value:function(){var e=w.canvas.scale||1;w.canvas.width,w.canvas.height,this.titleY=x(80,e),this.headerY=x(140,e),this.entryStartY=x(180,e),this.entrySpacing=x(45,e),this.backButton.width=x(80,e),this.backButton.height=x(35,e),this.backButton.x=x(20,e),this.backButton.y=x(20,e),this.clearButton.width=x(100,e),this.clearButton.height=x(35,e)}},{key:"loadLeaderboardData",value:function(){try{if(this.leaderboardData=this.leaderboard.getTopScores(10),this.stats=this.leaderboard.getLeaderboardStats(),this.leaderboardData.length>0){var e=this.leaderboardData.reduce(function(e,t){return t.timestamp>e.timestamp?t:e});this.currentPlayerRank=this.leaderboard.getPlayerRank(e.playerName,e.score)}console.log("Leaderboard data loaded:",{entries:this.leaderboardData.length,stats:this.stats,currentPlayerRank:this.currentPlayerRank})}catch(e){console.error("Failed to load leaderboard data:",e),this.leaderboardData=[],this.stats=null,this.currentPlayerRank=null}}},{key:"update",value:function(e){Zt(t,"update",this,3)([e]),this.animationTime+=e,this.handleInput()}},{key:"handleInput",value:function(){var e=this.gameEngine.getSystem("input");if(e){var t=e.getCurrentInput();if(e.isKeyPressed&&e.isKeyHeld){if(e.isKeyPressed("Escape"))return console.log("ESC pressed in leaderboard, going back..."),void this.goBack();if(e.isKeyPressed("Backspace"))return console.log("Backspace pressed in leaderboard, going back..."),void this.goBack()}if(t&&t.isPressed){if(t.isTap){var i=t.startPosition.x,n=t.startPosition.y;if(console.log("Leaderboard tap detected at:",i,n),this.isPointInButton(i,n,this.backButton))return console.log("Back button clicked"),void this.goBack();if(this.isPointInButton(i,n,this.clearButton))return console.log("Clear button clicked"),void this.clearLeaderboard();this.checkEntrySelection(i,n)}if(t.isSwipe){var o=t.swipeAngle;console.log("Swipe detected, angle:",o),Math.abs(Math.cos(o))>.7&&Math.cos(o)>0&&(console.log("Right swipe detected, going back..."),this.goBack())}}}}},{key:"isPointInButton",value:function(e,t,i){return e>=i.x&&e<=i.x+i.width&&t>=i.y&&t<=i.y+i.height}},{key:"checkEntrySelection",value:function(e,t){for(var i=this.entrySpacing,n=0;n<this.leaderboardData.length;n++){var o=this.entryStartY+n*i;if(t>=o-i/2&&t<=o+i/2){this.selectedEntry=n,console.log("Selected leaderboard entry ".concat(n+1,": ").concat(this.leaderboardData[n].playerName));break}}}},{key:"render",value:function(e){e.save(),e.setTransform(1,0,0,1,0,0),this.renderBackground(e),this.renderTitle(e),this.renderLeaderboard(e),this.renderButtons(e),this.renderStats(e),e.restore(),Zt(t,"render",this,3)([e])}},{key:"renderBackground",value:function(e){var t=e.createLinearGradient(0,0,0,e.canvas.height);t.addColorStop(0,"#2C3E50"),t.addColorStop(.5,"#34495E"),t.addColorStop(1,"#2C3E50"),e.fillStyle=t,e.fillRect(0,0,e.canvas.width,e.canvas.height),this.renderBackgroundPattern(e)}},{key:"renderBackgroundPattern",value:function(e){e.save(),e.globalAlpha=.1,e.strokeStyle="#ECF0F1",e.lineWidth=1;for(var t=0;t<e.canvas.width;t+=50)e.beginPath(),e.moveTo(t,0),e.lineTo(t,e.canvas.height),e.stroke();for(var i=0;i<e.canvas.height;i+=50)e.beginPath(),e.moveTo(0,i),e.lineTo(e.canvas.width,i),e.stroke();e.restore()}},{key:"renderTitle",value:function(e){e.save();var t=w.canvas.scale||1;e.fillStyle="#ECF0F1",e.font="bold ".concat(k("xlarge",t),"px Arial"),e.textAlign="center",e.textBaseline="middle",e.shadowColor="rgba(0, 0, 0, 0.5)",e.shadowBlur=x(8,t),e.shadowOffsetX=x(2,t),e.shadowOffsetY=x(2,t);var i=e.canvas.width/2,n=.3*Math.sin(2*this.animationTime)+.7;e.globalAlpha=n,e.fillText("排行榜",i,this.titleY),e.globalAlpha=.8,e.font="".concat(k("medium",t),"px Arial"),e.shadowBlur=x(4,t),e.fillText("Leaderboard",i,this.titleY+x(35,t)),e.restore()}},{key:"renderLeaderboardHeader",value:function(e){e.save(),e.fillStyle="rgba(52, 73, 94, 0.8)",e.fillRect(20,this.headerY-15,e.canvas.width-40,30),e.strokeStyle="#BDC3C7",e.lineWidth=1,e.strokeRect(20,this.headerY-15,e.canvas.width-40,30),e.fillStyle="#ECF0F1",e.font="bold 16px Arial",e.textBaseline="middle",e.textAlign="center",e.fillText("排名",70,this.headerY),e.textAlign="left",e.fillText("玩家",120,this.headerY),e.textAlign="right",e.fillText("層數",e.canvas.width-60,this.headerY),e.restore()}},{key:"renderLeaderboard",value:function(e){var t=this;this.renderLeaderboardHeader(e),0!==this.leaderboardData.length?(e.save(),this.leaderboardData.forEach(function(i,n){t.renderLeaderboardEntry(e,i,n)}),e.restore()):this.renderEmptyLeaderboard(e)}},{key:"renderEmptyLeaderboard",value:function(e){e.save(),e.fillStyle="rgba(149, 165, 166, 0.8)",e.font="18px Arial",e.textAlign="center",e.textBaseline="middle";var t=e.canvas.width/2,i=this.entryStartY+100;e.fillText("暫無記錄",t,i),e.font="14px Arial",e.fillText("開始遊戲來創建你的第一個記錄！",t,i+30),e.restore()}},{key:"renderLeaderboardEntry",value:function(e,t,i){var n=this.entryStartY+i*this.entrySpacing,o=i+1,r=this.currentPlayerRank===o,a=this.selectedEntry===i;e.save();var s="rgba(52, 73, 94, 0.3)";if(r?s="rgba(241, 196, 15, 0.3)":a&&(s="rgba(52, 152, 219, 0.3)"),i%2==1&&(s=s.replace("0.3","0.2")),e.fillStyle=s,e.fillRect(20,n-this.entrySpacing/2+5,e.canvas.width-40,this.entrySpacing-10),(r||a)&&(e.strokeStyle=r?"#F1C40F":"#3498DB",e.lineWidth=2,e.strokeRect(20,n-this.entrySpacing/2+5,e.canvas.width-40,this.entrySpacing-10)),this.renderRankBadge(e,o,70,n),e.fillStyle=r?"#F1C40F":"#ECF0F1",e.font=r?"bold 16px Arial":"16px Arial",e.textAlign="left",e.textBaseline="middle",e.fillText(t.playerName,120,n),e.fillStyle=r?"#F1C40F":"#BDC3C7",e.font=r?"bold 18px Arial":"16px Arial",e.textAlign="right",e.fillText(t.score.toString(),e.canvas.width-60,n),t.timestamp){var l=new Date(t.timestamp).toLocaleDateString("zh-TW",{month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"});e.fillStyle="rgba(149, 165, 166, 0.8)",e.font="12px Arial",e.textAlign="right",e.fillText(l,e.canvas.width-60,n+15)}r&&(e.fillStyle="#F1C40F",e.font="bold 12px Arial",e.textAlign="left",e.fillText("你",95,n-8)),e.restore()}},{key:"renderRankBadge",value:function(e,t,i,n){e.save();var o="#95A5A6",r="#FFFFFF";if(1===t?(o="#F1C40F",r="#2C3E50"):2===t?(o="#BDC3C7",r="#2C3E50"):3===t&&(o="#E67E22",r="#FFFFFF"),e.fillStyle=o,e.beginPath(),e.arc(i,n,18,0,2*Math.PI),e.fill(),e.strokeStyle=r,e.lineWidth=2,e.stroke(),e.fillStyle=r,e.font="bold 14px Arial",e.textAlign="center",e.textBaseline="middle",e.fillText(t.toString(),i,n),t<=3){var a=2*Math.sin(3*this.animationTime)+20;e.save(),e.globalAlpha=.3,e.fillStyle=o,e.beginPath(),e.arc(i,n,a,0,2*Math.PI),e.fill(),e.restore()}e.restore()}},{key:"renderButtons",value:function(e){this.clearButton.x=e.canvas.width-this.clearButton.width-20,this.clearButton.y=e.canvas.height-this.clearButton.height-20,this.renderButton(e,this.backButton,"#3498DB"),this.leaderboardData.length>0&&this.renderButton(e,this.clearButton,"#E74C3C")}},{key:"renderButton",value:function(e,t,i){e.save(),e.fillStyle=i,e.fillRect(t.x,t.y,t.width,t.height),e.strokeStyle="#FFFFFF",e.lineWidth=2,e.strokeRect(t.x,t.y,t.width,t.height),e.fillStyle="#FFFFFF",e.font="bold 14px Arial",e.textAlign="center",e.textBaseline="middle",e.fillText(t.text,t.x+t.width/2,t.y+t.height/2),e.restore()}},{key:"renderStats",value:function(e){if(this.stats){e.save();var t=e.canvas.height-80;e.fillStyle="rgba(44, 62, 80, 0.8)",e.fillRect(20,t-10,e.canvas.width-40,60),e.strokeStyle="#BDC3C7",e.lineWidth=1,e.strokeRect(20,t-10,e.canvas.width-40,60),e.fillStyle="#BDC3C7",e.font="12px Arial",e.textAlign="left",e.textBaseline="top";var i=["總記錄數: ".concat(this.stats.totalEntries),"最高分: ".concat(this.stats.highestScore),"平均分: ".concat(this.stats.averageScore)];if(this.stats.lastUpdated){var n=new Date(this.stats.lastUpdated);i.push("最後更新: ".concat(n.toLocaleDateString("zh-TW")))}i.forEach(function(i,n){var o=30+n%2*(e.canvas.width/2-40),r=t+20*Math.floor(n/2);e.fillText(i,o,r)}),e.restore()}}},{key:"goBack",value:function(){var e=this.gameEngine.getSystem("state");e&&(e.changeState(s.MENU),this.gameEngine.switchScene("menu"))}},{key:"clearLeaderboard",value:function(){confirm("確定要清空所有排行榜記錄嗎？此操作無法撤銷。")&&(this.leaderboard.clearLeaderboard()?(console.log("Leaderboard cleared successfully"),this.loadLeaderboardData()):(console.error("Failed to clear leaderboard"),alert("清空排行榜失敗，請稍後再試。")))}},{key:"reset",value:function(){Zt(t,"reset",this,3)([]),this.animationTime=0,this.selectedEntry=-1,this.leaderboardData=[],this.currentPlayerRank=null,this.stats=null}}])&&Xt(i.prototype,n),Object.defineProperty(i,"prototype",{writable:!1}),i;var i,n}(We);function ii(e){return ii="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},ii(e)}function ni(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){var i=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=i){var n,o,r,a,s=[],l=!0,c=!1;try{if(r=(i=i.call(e)).next,0===t){if(Object(i)!==i)return;l=!1}else for(;!(l=(n=r.call(i)).done)&&(s.push(n.value),s.length!==t);l=!0);}catch(e){c=!0,o=e}finally{try{if(!l&&null!=i.return&&(a=i.return(),Object(a)!==a))return}finally{if(c)throw o}}return s}}(e,t)||function(e,t){if(e){if("string"==typeof e)return oi(e,t);var i={}.toString.call(e).slice(8,-1);return"Object"===i&&e.constructor&&(i=e.constructor.name),"Map"===i||"Set"===i?Array.from(e):"Arguments"===i||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(i)?oi(e,t):void 0}}(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function oi(e,t){(null==t||t>e.length)&&(t=e.length);for(var i=0,n=Array(t);i<t;i++)n[i]=e[i];return n}function ri(){var e,t,i="function"==typeof Symbol?Symbol:{},n=i.iterator||"@@iterator",o=i.toStringTag||"@@toStringTag";function r(i,n,o,r){var l=n&&n.prototype instanceof s?n:s,c=Object.create(l.prototype);return ai(c,"_invoke",function(i,n,o){var r,s,l,c=0,u=o||[],h=!1,f={p:0,n:0,v:e,a:d,f:d.bind(e,4),d:function(t,i){return r=t,s=0,l=e,f.n=i,a}};function d(i,n){for(s=i,l=n,t=0;!h&&c&&!o&&t<u.length;t++){var o,r=u[t],d=f.p,p=r[2];i>3?(o=p===n)&&(l=r[(s=r[4])?5:(s=3,3)],r[4]=r[5]=e):r[0]<=d&&((o=i<2&&d<r[1])?(s=0,f.v=n,f.n=r[1]):d<p&&(o=i<3||r[0]>n||n>p)&&(r[4]=i,r[5]=n,f.n=p,s=0))}if(o||i>1)return a;throw h=!0,n}return function(o,u,p){if(c>1)throw TypeError("Generator is already running");for(h&&1===u&&d(u,p),s=u,l=p;(t=s<2?e:l)||!h;){r||(s?s<3?(s>1&&(f.n=-1),d(s,l)):f.n=l:f.v=l);try{if(c=2,r){if(s||(o="next"),t=r[o]){if(!(t=t.call(r,l)))throw TypeError("iterator result is not an object");if(!t.done)return t;l=t.value,s<2&&(s=0)}else 1===s&&(t=r.return)&&t.call(r),s<2&&(l=TypeError("The iterator does not provide a '"+o+"' method"),s=1);r=e}else if((t=(h=f.n<0)?l:i.call(n,f))!==a)break}catch(t){r=e,s=1,l=t}finally{c=1}}return{value:t,done:h}}}(i,o,r),!0),c}var a={};function s(){}function l(){}function c(){}t=Object.getPrototypeOf;var u=[][n]?t(t([][n]())):(ai(t={},n,function(){return this}),t),h=c.prototype=s.prototype=Object.create(u);function f(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,c):(e.__proto__=c,ai(e,o,"GeneratorFunction")),e.prototype=Object.create(h),e}return l.prototype=c,ai(h,"constructor",c),ai(c,"constructor",l),l.displayName="GeneratorFunction",ai(c,o,"GeneratorFunction"),ai(h),ai(h,o,"Generator"),ai(h,n,function(){return this}),ai(h,"toString",function(){return"[object Generator]"}),(ri=function(){return{w:r,m:f}})()}function ai(e,t,i,n){var o=Object.defineProperty;try{o({},"",{})}catch(e){o=0}ai=function(e,t,i,n){function r(t,i){ai(e,t,function(e){return this._invoke(t,i,e)})}t?o?o(e,t,{value:i,enumerable:!n,configurable:!n,writable:!n}):e[t]=i:(r("next",0),r("throw",1),r("return",2))},ai(e,t,i,n)}function si(e,t,i,n,o,r,a){try{var s=e[r](a),l=s.value}catch(e){return void i(e)}s.done?t(l):Promise.resolve(l).then(n,o)}function li(e){return function(){var t=this,i=arguments;return new Promise(function(n,o){var r=e.apply(t,i);function a(e){si(r,n,o,a,s,"next",e)}function s(e){si(r,n,o,a,s,"throw",e)}a(void 0)})}}function ci(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function ui(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,fi(n.key),n)}}function hi(e,t,i){return t&&ui(e.prototype,t),i&&ui(e,i),Object.defineProperty(e,"prototype",{writable:!1}),e}function fi(e){var t=function(e){if("object"!=ii(e)||!e)return e;var t=e[Symbol.toPrimitive];if(void 0!==t){var i=t.call(e,"string");if("object"!=ii(i))return i;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(e)}(e);return"symbol"==ii(t)?t:t+""}var di=new(function(){return hi(function e(){ci(this,e),this.canvas=null,this.gameEngine=null,this.stateManager=null,this.inputManager=null,this.isInitialized=!1},[{key:"initialize",value:(i=li(ri().m(function e(){var t,i,o=this;return ri().w(function(e){for(;;)switch(e.p=e.n){case 0:if(e.p=0,this.canvas=document.getElementById("gameCanvas"),this.canvas){e.n=1;break}throw new Error("Canvas element not found");case 1:return this.setupCanvas(),this.gameEngine=new n(this.canvas),this.stateManager=new l,this.inputManager=new y(this.canvas),this.renderManager=new b(this.canvas),this.cameraSystem=new A(this.canvas),this.physicsSystem=new I,this.audioManager=new H,this.responsiveManager=new $,this.mobileOptimizer=new ae(this.responsiveManager,this.inputManager),this.performanceMonitor=new we,this.serviceWorkerManager=new Me,this.pwaInstallManager=new Be,this.gameEngine.registerSystem("state",this.stateManager),this.gameEngine.registerSystem("input",this.inputManager),this.gameEngine.registerSystem("render",this.renderManager),this.gameEngine.registerSystem("camera",this.cameraSystem),this.gameEngine.registerSystem("physics",this.physicsSystem),this.gameEngine.registerSystem("audio",this.audioManager),this.gameEngine.registerSystem("responsive",this.responsiveManager),this.gameEngine.registerSystem("mobile",this.mobileOptimizer),this.gameEngine.registerSystem("performance",this.performanceMonitor),this.gameEngine.registerSystem("serviceWorker",this.serviceWorkerManager),this.gameEngine.registerSystem("pwaInstall",this.pwaInstallManager),this.setupObjectPools(),this.setupScenes(),this.setupEventListeners(),(t=document.getElementById("loadingText"))&&(t.style.display="none"),this.isInitialized=!0,console.log("Game initialized successfully"),setTimeout(function(){console.log("延遲檢查尺寸 (500ms)"),o.setupCanvas()},500),e.n=2,this.loadAudioAssets();case 2:return e.n=3,this.setupServiceWorker();case 3:this.start(),e.n=5;break;case 4:e.p=4,i=e.v,console.error("Failed to initialize game:",i),this.showError("遊戲初始化失敗，請重新整理頁面");case 5:return e.a(2)}},e,this,[[0,4]])})),function(){return i.apply(this,arguments)})},{key:"setupCanvas",value:function(){var e=Math.max(window.innerWidth,document.documentElement.clientWidth,document.body.clientWidth||0),t=Math.max(window.innerHeight,document.documentElement.clientHeight,document.body.clientHeight||0),i=e,n=t;this.canvas.width=i,this.canvas.height=n,this.canvas.style.width="".concat(i,"px"),this.canvas.style.height="".concat(n,"px");var o=S(i,n);w.canvas.width=i,w.canvas.height=n,w.canvas.scale=o,w.player.startPosition.x=i/2,w.player.startPosition.y=n-60,console.log("Canvas設置完成:"),console.log("- 螢幕尺寸: ".concat(e,"x").concat(t)),console.log("- Canvas尺寸: ".concat(this.canvas.width,"x").concat(this.canvas.height)),console.log("- 顯示尺寸: ".concat(i,"x").concat(n)),console.log("- 縮放比例: ".concat(o.toFixed(2))),console.log("- 是否為手機: ".concat(this.isMobile()))}},{key:"resizeCanvas",value:function(){console.log("觸發 resizeCanvas"),this.setupCanvas(),this.gameEngine&&this.gameEngine.resize(w.canvas.width,w.canvas.height)}},{key:"isMobile",value:function(){return/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)||window.innerWidth<=768}},{key:"requestFullscreen",value:function(){if(!document.fullscreenElement){var e=document.documentElement;e.requestFullscreen?e.requestFullscreen().catch(function(e){console.log("無法進入全螢幕模式:",e)}):e.webkitRequestFullscreen?e.webkitRequestFullscreen():e.msRequestFullscreen&&e.msRequestFullscreen()}}},{key:"exitFullscreen",value:function(){document.fullscreenElement&&(document.exitFullscreen?document.exitFullscreen():document.webkitExitFullscreen?document.webkitExitFullscreen():document.msExitFullscreen&&document.msExitFullscreen())}},{key:"setupServiceWorker",value:(t=li(ri().m(function e(){var t=this;return ri().w(function(e){for(;;)switch(e.n){case 0:return console.log("Setting up Service Worker..."),this.serviceWorkerManager.setCallbacks({onUpdateAvailable:function(){console.log("Service Worker update available"),t.showUpdateNotification()},onInstalled:function(){console.log("Service Worker installed for the first time"),t.showInstallNotification()},onError:function(e){console.error("Service Worker error:",e)},onOffline:function(){console.log("App is now offline"),t.showOfflineNotification()},onOnline:function(){console.log("App is back online"),t.hideOfflineNotification()}}),e.n=1,this.serviceWorkerManager.register("/sw.js");case 1:e.v?console.log("Service Worker registered successfully"):console.warn("Service Worker registration failed or not supported"),this.pwaInstallManager.setCallbacks({onInstallable:function(){console.log("PWA install prompt available"),t.pwaInstallManager.createInstallBanner()},onInstalled:function(){console.log("PWA installed successfully"),t.showInstallSuccessMessage()},onInstallDeclined:function(){console.log("User declined PWA installation")}});case 2:return e.a(2)}},e,this)})),function(){return t.apply(this,arguments)})},{key:"showUpdateNotification",value:function(){var e=this,t=document.createElement("div");t.id="update-notification",t.className="update-notification",t.innerHTML='\n      <div class="notification-content">\n        <span>遊戲有新版本可用</span>\n        <button id="update-btn" class="update-btn">更新</button>\n        <button id="dismiss-btn" class="dismiss-btn">稍後</button>\n      </div>\n    ';var i=document.createElement("style");i.textContent="\n      .update-notification {\n        position: fixed;\n        top: 20px;\n        right: 20px;\n        background: #4CAF50;\n        color: white;\n        padding: 15px;\n        border-radius: 8px;\n        box-shadow: 0 4px 12px rgba(0,0,0,0.3);\n        z-index: 10000;\n        font-family: Arial, sans-serif;\n      }\n      \n      .notification-content {\n        display: flex;\n        align-items: center;\n        gap: 10px;\n      }\n      \n      .update-btn, .dismiss-btn {\n        padding: 5px 10px;\n        border: none;\n        border-radius: 4px;\n        cursor: pointer;\n        font-size: 12px;\n      }\n      \n      .update-btn {\n        background: white;\n        color: #4CAF50;\n      }\n      \n      .dismiss-btn {\n        background: transparent;\n        color: white;\n        border: 1px solid white;\n      }\n    ",document.head.appendChild(i),document.body.appendChild(t),document.getElementById("update-btn").addEventListener("click",li(ri().m(function t(){return ri().w(function(t){for(;;)switch(t.n){case 0:return t.n=1,e.serviceWorkerManager.applyUpdate();case 1:t.v&&window.location.reload();case 2:return t.a(2)}},t)}))),document.getElementById("dismiss-btn").addEventListener("click",function(){t.remove()}),setTimeout(function(){t.parentNode&&t.remove()},1e4)}},{key:"showInstallSuccessMessage",value:function(){var e=document.createElement("div");e.innerHTML='\n      <div style="\n        position: fixed;\n        top: 50%;\n        left: 50%;\n        transform: translate(-50%, -50%);\n        background: #4CAF50;\n        color: white;\n        padding: 20px 30px;\n        border-radius: 12px;\n        box-shadow: 0 8px 24px rgba(0,0,0,0.3);\n        z-index: 10000;\n        font-family: Arial, sans-serif;\n        text-align: center;\n        max-width: 300px;\n      ">\n        <div style="font-size: 24px; margin-bottom: 10px;">🎉</div>\n        <div style="font-size: 16px; font-weight: bold; margin-bottom: 5px;">安裝成功！</div>\n        <div style="font-size: 14px; opacity: 0.9;">現在可以離線遊玩無限跳躍遊戲</div>\n      </div>\n    ',document.body.appendChild(e),setTimeout(function(){e.parentNode&&e.remove()},4e3)}},{key:"showInstallNotification",value:function(){console.log("App installed and ready for offline use");var e=document.createElement("div");e.className="install-notification",e.innerHTML='\n      <div style="\n        position: fixed;\n        bottom: 20px;\n        left: 50%;\n        transform: translateX(-50%);\n        background: #2196F3;\n        color: white;\n        padding: 10px 20px;\n        border-radius: 8px;\n        z-index: 10000;\n        font-family: Arial, sans-serif;\n      ">\n        遊戲已安裝，現在可以離線遊玩！\n      </div>\n    ',document.body.appendChild(e),setTimeout(function(){e.parentNode&&e.remove()},5e3)}},{key:"showOfflineNotification",value:function(){var e=document.createElement("div");e.id="offline-notification",e.innerHTML='\n      <div style="\n        position: fixed;\n        top: 0;\n        left: 0;\n        right: 0;\n        background: #FF9800;\n        color: white;\n        padding: 10px;\n        text-align: center;\n        z-index: 10000;\n        font-family: Arial, sans-serif;\n      ">\n        離線模式 - 某些功能可能受限\n      </div>\n    ',document.body.appendChild(e)}},{key:"hideOfflineNotification",value:function(){var e=document.getElementById("offline-notification");e&&e.remove()}},{key:"setupObjectPools",value:function(){var e=this;console.log("Setting up object pools...");var t=new ye(function(){return hi(function e(t,i,n,o){ci(this,e),this.x=t,this.y=i,this.width=n,this.height=o,this.velocity={x:0,y:0},this.isActive=!1,this.type="normal"},[{key:"reset",value:function(){this.velocity.x=0,this.velocity.y=0}}])}(),30);ve.registerPool("platforms",t),this.performanceMonitor.setCallbacks(function(e){console.warn("Performance warning:",e)},function(t){console.error("Performance critical:",t),e.handleCriticalPerformance(t)}),this.mobileOptimizer.isMobileDevice()&&this.performanceMonitor.enableAutoOptimize({fpsThreshold:45,memoryThreshold:83886080}),console.log("Object pools setup completed")}},{key:"handleCriticalPerformance",value:function(e){switch(console.log("Handling critical performance issue:",e),e.metric){case"fps":this.enableLowQualityMode();break;case"memory":this.cleanupMemory()}}},{key:"enableLowQualityMode",value:function(){console.log("Enabling low quality mode..."),document.dispatchEvent(new CustomEvent("lowQualityMode",{detail:{enabled:!0}}))}},{key:"cleanupMemory",value:function(){console.log("Cleaning up memory..."),ve.optimize(),window.gc&&window.gc()}},{key:"setupScenes",value:function(){console.log("Setting up scenes...");var e=new Xe(this.gameEngine),t=new Ht(this.gameEngine),i=new ti(this.gameEngine);console.log("Created menuScene:",e.name),console.log("Created gameScene:",t.name),console.log("Created leaderboardScene:",i.name),this.gameEngine.registerScene("menu",e),this.gameEngine.registerScene("game",t),this.gameEngine.registerScene("leaderboard",i),console.log("Scenes registered successfully")}},{key:"setupEventListeners",value:function(){var e=this;document.addEventListener("touchmove",function(t){t.target===e.canvas&&t.preventDefault()},{passive:!1}),document.addEventListener("gesturestart",function(e){return e.preventDefault()}),document.addEventListener("gesturechange",function(e){return e.preventDefault()}),document.addEventListener("gestureend",function(e){return e.preventDefault()}),document.addEventListener("visibilitychange",function(){document.hidden?e.pause():e.resume()}),window.addEventListener("blur",function(){return e.pause()}),window.addEventListener("focus",function(){return e.resume()}),window.addEventListener("resize",function(){console.log("Resize event triggered"),clearTimeout(e.resizeTimeout),e.resizeTimeout=setTimeout(function(){e.resizeCanvas()},100)}),window.addEventListener("orientationchange",function(){console.log("Orientation change event triggered"),setTimeout(function(){e.resizeCanvas()},300)});var t=window.innerWidth,i=window.innerHeight;setInterval(function(){var n=window.innerWidth,o=window.innerHeight;n===t&&o===i||(console.log("尺寸變化檢測: ".concat(t,"x").concat(i," -> ").concat(n,"x").concat(o)),t=n,i=o,e.resizeCanvas())},1e3),document.addEventListener("click",function(){e.requestFullscreen()},{once:!0}),document.addEventListener("fullscreenchange",function(){setTimeout(function(){e.resizeCanvas()},100)}),document.addEventListener("webkitfullscreenchange",function(){setTimeout(function(){e.resizeCanvas()},100)}),this.stateManager.addStateChangeListener("main",function(t,i){console.log("State changed from ".concat(t," to ").concat(i)),e.onStateChange(t,i)})}},{key:"onStateChange",value:function(e,t){switch(t){case s.MENU:this.showMenu();break;case s.PLAYING:this.startGame();break;case s.PAUSED:this.showPauseMenu();break;case s.GAME_OVER:this.showGameOver();break;case s.LEADERBOARD:this.showLeaderboard()}}},{key:"start",value:function(){this.isInitialized?(this.stateManager.changeState(s.MENU),this.gameEngine.start(),console.log("Game started")):console.error("Game not initialized")}},{key:"pause",value:function(){this.gameEngine&&this.stateManager.isState(s.PLAYING)&&(this.gameEngine.pause(),this.stateManager.changeState(s.PAUSED))}},{key:"resume",value:function(){this.gameEngine&&this.stateManager.isState(s.PAUSED)&&(this.gameEngine.resume(),this.stateManager.changeState(s.PLAYING))}},{key:"stop",value:function(){this.gameEngine&&this.gameEngine.stop(),this.audioManager&&this.audioManager.destroy(),this.responsiveManager&&this.responsiveManager.destroy(),this.mobileOptimizer&&this.mobileOptimizer.destroy(),this.performanceMonitor&&this.performanceMonitor.destroy(),this.serviceWorkerManager&&this.serviceWorkerManager.destroy(),this.pwaInstallManager&&this.pwaInstallManager.destroy(),ve.destroy()}},{key:"showMenu",value:function(){console.log("Switching to menu scene..."),this.gameEngine.switchScene("menu"),console.log("Showing main menu")}},{key:"startGame",value:function(){console.log("Switching to game scene..."),this.gameEngine.switchScene("game"),console.log("Starting game")}},{key:"showPauseMenu",value:function(){console.log("Showing pause menu")}},{key:"showGameOver",value:function(){console.log("Showing game over screen")}},{key:"showLeaderboard",value:function(){console.log("Switching to leaderboard scene..."),this.gameEngine.switchScene("leaderboard"),console.log("Showing leaderboard")}},{key:"loadAudioAssets",value:(e=li(ri().m(function e(){var t,i,n,o,r,a,s;return ri().w(function(e){for(;;)switch(e.p=e.n){case 0:e.p=0,console.log("Loading audio assets..."),t=0,i=Object.entries(this.audioManager.audioFiles);case 1:if(!(t<i.length)){e.n=6;break}return n=ni(i[t],2),o=n[0],r=n[1],e.p=2,e.n=3,this.audioManager.loadAudio(o,r);case 3:e.n=5;break;case 4:e.p=4,a=e.v,console.warn("Failed to load audio ".concat(o,":"),a.message);case 5:t++,e.n=1;break;case 6:console.log("Audio assets loading completed (some may have failed)"),e.n=8;break;case 7:e.p=7,s=e.v,console.warn("Failed to load audio assets:",s);case 8:return e.a(2)}},e,this,[[2,4],[0,7]])})),function(){return e.apply(this,arguments)})},{key:"showError",value:function(e){var t=document.getElementById("loadingText");t&&(t.textContent=e,t.style.color="#E74C3C",t.style.display="block")}}]);var e,t,i}());"loading"===document.readyState?document.addEventListener("DOMContentLoaded",function(){return di.initialize()}):di.initialize(),window.gameApp=di})();