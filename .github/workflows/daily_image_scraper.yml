name: å®šæ™‚åœ–ç‰‡æŠ“å– (08:00/13:25/20:00)

on:
  schedule:
    # å°ç£æ™‚é–“ 08:00 (UTC 00:00)
    - cron: '0 0 * * *'
    # å°ç£æ™‚é–“ 13:25 (UTC 05:25)
    - cron: '25 5 * * *'
    # å°ç£æ™‚é–“ 20:00 (UTC 12:00)
    - cron: '0 12 * * *'
  workflow_dispatch: # å…è¨±æ‰‹å‹•è§¸ç™¼

permissions:
  contents: write  # å…è¨±å¯«å…¥å…§å®¹å’Œæ¨é€

jobs:
  scheduled-scrape:
    runs-on: ubuntu-latest
    
    steps:
    - name: æª¢å‡ºç¨‹å¼ç¢¼
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: è¨­å®š Python ç’°å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        
    - name: å®‰è£ Chrome å’Œ ChromeDriver
      run: |
        # å®‰è£ Chrome
        wget -q -O - https://dl.google.com/linux/linux_signing_key.pub | sudo apt-key add -
        sudo sh -c 'echo "deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main" >> /etc/apt/sources.list.d/google-chrome.list'
        sudo apt-get update
        sudo apt-get install -y google-chrome-stable
        
        # å®‰è£ ChromeDriver
        CHROME_VERSION=$(google-chrome --version | cut -d " " -f3 | cut -d "." -f1)
        CHROMEDRIVER_VERSION=$(curl -s "https://chromedriver.storage.googleapis.com/LATEST_RELEASE_$CHROME_VERSION")
        wget -O /tmp/chromedriver.zip "https://chromedriver.storage.googleapis.com/$CHROMEDRIVER_VERSION/chromedriver_linux64.zip"
        sudo unzip /tmp/chromedriver.zip chromedriver -d /usr/local/bin/
        sudo chmod +x /usr/local/bin/chromedriver
        
        # é©—è­‰å®‰è£
        google-chrome --version
        chromedriver --version
        
    - name: å®‰è£ Python ä¾è³´
      run: |
        pip install selenium requests pillow
        
    - name: å‰µå»ºè¨­å®šæª”
      run: |
        cat > scripts/config.json << EOF
        {
          "images_directory": "../images",
          "colne_icol_directory": "../colne_icol_images",
          "line_bot": {
            "github_pages_base": "https://future801113.github.io/i-love-col"
          }
        }
        EOF
        
    - name: è¨­å®šç’°å¢ƒè®Šæ•¸
      run: |
        echo "LINE_CHANNEL_ACCESS_TOKEN=${{ secrets.LINE_CHANNEL_ACCESS_TOKEN }}" >> $GITHUB_ENV
        echo "LINE_TARGET_ID=${{ secrets.LINE_TARGET_ID }}" >> $GITHUB_ENV
        
    - name: åŸ·è¡Œæ¯æ—¥åœ–ç‰‡æŠ“å–
      run: |
        cd scripts
        echo "ğŸš€ é–‹å§‹åŸ·è¡Œæ¯æ—¥åœ–ç‰‡æŠ“å–..."
        echo "ç•¶å‰å·¥ä½œç›®éŒ„: $(pwd)"
        echo "ç›®éŒ„å…§å®¹:"
        ls -la
        echo "ç’°å¢ƒè®Šæ•¸æª¢æŸ¥:"
        echo "LINE_CHANNEL_ACCESS_TOKEN: ${LINE_CHANNEL_ACCESS_TOKEN:0:20}..." 
        echo "LINE_TARGET_ID: $LINE_TARGET_ID"
        
        python web_scraper_simple.py daily
        
        echo "åŸ·è¡Œå¾Œç›®éŒ„è®ŠåŒ–:"
        ls -la ../images/ || echo "images ç›®éŒ„ä¸å­˜åœ¨"
        ls -la ../colne_icol_images/ || echo "colne_icol_images ç›®éŒ„ä¸å­˜åœ¨"
        ls -la ../combined_images/ || echo "combined_images ç›®éŒ„ä¸å­˜åœ¨"
        
    - name: æª¢æŸ¥è®Šæ›´ä¸¦æäº¤
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # å…ˆåŒæ­¥é ç«¯è®Šæ›´
        echo "ğŸ”„ åŒæ­¥é ç«¯è®Šæ›´..."
        git fetch origin
        git pull --rebase origin master || true
        
        # æª¢æŸ¥æ˜¯å¦æœ‰è®Šæ›´
        if [ -n "$(git status --porcelain)" ]; then
          echo "âœ… æœ‰è®Šæ›´éœ€è¦æäº¤"
          
          # é¡¯ç¤ºè®Šæ›´çµ±è¨ˆ
          echo "ğŸ“Š è®Šæ›´çµ±è¨ˆ:"
          git status --porcelain | wc -l
          echo "ğŸ“ è®Šæ›´è©³æƒ…:"
          git status --porcelain
          
          # çµ±è¨ˆå„ç›®éŒ„çš„åœ–ç‰‡æ•¸é‡
          if [ -d images ]; then
            echo "ğŸ“¸ ice_deliverer åœ–ç‰‡ç¸½æ•¸: $(find images -name "*.jpg" -o -name "*.png" | wc -l)"
          fi
          if [ -d colne_icol_images ]; then
            echo "ğŸ“¸ colne_icol åœ–ç‰‡ç¸½æ•¸: $(find colne_icol_images -name "*.jpg" -o -name "*.png" | wc -l)"
          fi
          if [ -d combined_images ]; then
            echo "ğŸ¨ çµ„åˆåœ–ç‰‡ç¸½æ•¸: $(find combined_images -name "*.jpg" -o -name "*.png" | wc -l)"
          fi
          
          # æ·»åŠ æ‰€æœ‰è®Šæ›´
          git add .
          
          # æäº¤è®Šæ›´
          git commit -m "ğŸ¤– å®šæ™‚è‡ªå‹•æŠ“å–åœ–ç‰‡ - $(date '+%Y-%m-%d %H:%M:%S')"
          
          # æ¨é€è®Šæ›´
          echo "ğŸ“¤ æ¨é€è®Šæ›´åˆ°é ç«¯..."
          git push origin master
          echo "âœ… æ¨é€å®Œæˆ"
        else
          echo "ğŸ“° æ²’æœ‰è®Šæ›´éœ€è¦æäº¤"
        fi
        
    - name: é¡¯ç¤ºåŸ·è¡Œçµæœçµ±è¨ˆ
      if: always()
      run: |
        echo "ğŸ“Š åŸ·è¡Œçµæœçµ±è¨ˆ:"
        if [ -d images ]; then
          echo "ğŸ“¸ ice_deliverer åœ–ç‰‡ç¸½æ•¸: $(find images -name "*.jpg" -o -name "*.png" | wc -l)"
          echo "ğŸ“¸ ice_deliverer æœ€æ–°åœ–ç‰‡:"
          find images -name "*.jpg" -o -name "*.png" | sort -r | head -5
        fi
        if [ -d colne_icol_images ]; then
          echo "ğŸ“¸ colne_icol åœ–ç‰‡ç¸½æ•¸: $(find colne_icol_images -name "*.jpg" -o -name "*.png" | wc -l)"
          echo "ğŸ“¸ colne_icol æœ€æ–°åœ–ç‰‡:"
          find colne_icol_images -name "*.jpg" -o -name "*.png" | sort -r | head -5
        fi
        if [ -d combined_images ]; then
          echo "ğŸ¨ çµ„åˆåœ–ç‰‡ç¸½æ•¸: $(find combined_images -name "*.jpg" -o -name "*.png" | wc -l)"
          echo "ğŸ¨ æœ€æ–°çµ„åˆåœ–ç‰‡:"
          find combined_images -name "*.jpg" -o -name "*.png" | sort -r | head -3
        fi
