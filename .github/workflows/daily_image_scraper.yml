name: å®šæ™‚åœ–ç‰‡æŠ“å– (08:00/13:20/19:50)

on:
  schedule:
    # å°ç£æ™‚é–“ 07:00 (UTC 23:00 å‰ä¸€å¤©)
    - cron: '0 23 * * *'
    # å°ç£æ™‚é–“ 12:20 (UTC 04:20)
    - cron: '20 4 * * *'
    # å°ç£æ™‚é–“ 23:00 (UTC 15:00)
    - cron: '0 15 * * *'
  workflow_dispatch: # å…è¨±æ‰‹å‹•è§¸ç™¼

)
permissions:
  contents: write  # å…è¨±å¯«å…¥å…§å®¹å’Œæ¨é€

jobs:
  scheduled-scrape:
    runs-on: ubuntu-latest
    
    steps:
    - name: æª¢å‡ºç¨‹å¼ç¢¼
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: è¨­å®š Python ç’°å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        
    - name: è¨­å®š Chrome å’Œ ChromeDriver
      uses: browser-actions/setup-chrome@v1
      with:
        chrome-version: stable
        
    - name: é©—è­‰ Chrome å®‰è£
      run: |
        google-chrome --version
        which chromedriver || echo "ChromeDriver è·¯å¾‘æª¢æŸ¥..."
        
        # å¦‚æœ chromedriver ä¸åœ¨ PATH ä¸­ï¼Œå˜—è©¦å°‹æ‰¾ä¸¦é€£çµ
        if ! which chromedriver; then
          echo "å°‹æ‰¾ ChromeDriver..."
          CHROMEDRIVER_PATH=$(find /opt /usr -name "chromedriver" 2>/dev/null | head -1)
          if [ -n "$CHROMEDRIVER_PATH" ]; then
            echo "æ‰¾åˆ° ChromeDriver: $CHROMEDRIVER_PATH"
            sudo ln -sf "$CHROMEDRIVER_PATH" /usr/local/bin/chromedriver
          else
            echo "æ‰‹å‹•å®‰è£ ChromeDriver..."
            # ä½¿ç”¨æœ€æ–°ç©©å®šç‰ˆæœ¬
            LATEST_VERSION=$(curl -s "https://chromedriver.storage.googleapis.com/LATEST_RELEASE")
            wget -O /tmp/chromedriver.zip "https://chromedriver.storage.googleapis.com/$LATEST_VERSION/chromedriver_linux64.zip"
            cd /tmp && unzip chromedriver.zip
            sudo mv chromedriver /usr/local/bin/
            sudo chmod +x /usr/local/bin/chromedriver
          fi
        fi
        
        chromedriver --version
        
    - name: å®‰è£ Python ä¾è³´
      run: |
        pip install selenium requests pillow
        
    - name: å‰µå»ºè¨­å®šæª”
      run: |
        cat > scripts/config.json << EOF
        {
          "images_directory": "../images",
          "colne_icol_directory": "../colne_icol_images",
          "line_bot": {
            "github_pages_base": "https://future801113.github.io/i-love-col"
          }
        }
        EOF
        
    - name: è¨­å®šç’°å¢ƒè®Šæ•¸
      run: |
        echo "LINE_CHANNEL_ACCESS_TOKEN=${{ secrets.LINE_CHANNEL_ACCESS_TOKEN }}" >> $GITHUB_ENV
        echo "LINE_TARGET_ID=${{ secrets.LINE_TARGET_ID }}" >> $GITHUB_ENV
        
    - name: åŸ·è¡Œæ¯æ—¥åœ–ç‰‡æŠ“å– (ä¸ç™¼é€ LINE)
      run: |
        cd scripts
        echo "ğŸš€ é–‹å§‹åŸ·è¡Œæ¯æ—¥åœ–ç‰‡æŠ“å–..."
        echo "ç•¶å‰å·¥ä½œç›®éŒ„: $(pwd)"
        echo "ç›®éŒ„å…§å®¹:"
        ls -la
        echo "ç’°å¢ƒè®Šæ•¸æª¢æŸ¥:"
        echo "LINE_CHANNEL_ACCESS_TOKEN: ${LINE_CHANNEL_ACCESS_TOKEN:0:20}..." 
        echo "LINE_TARGET_ID: $LINE_TARGET_ID"
        
        # æš«æ™‚ç¦ç”¨ LINE ç™¼é€ï¼Œå…ˆå°ˆæ³¨æ–¼åœ–ç‰‡æŠ“å–å’Œçµ„åˆ
        export SKIP_LINE_SEND=true
        python web_scraper_simple.py daily
        
        echo "åŸ·è¡Œå¾Œç›®éŒ„è®ŠåŒ–:"
        ls -la ../images/ || echo "images ç›®éŒ„ä¸å­˜åœ¨"
        ls -la ../colne_icol_images/ || echo "colne_icol_images ç›®éŒ„ä¸å­˜åœ¨"
        ls -la ../combined_images/ || echo "combined_images ç›®éŒ„ä¸å­˜åœ¨"
        
    - name: æª¢æŸ¥è®Šæ›´ä¸¦æäº¤
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # å…ˆåŒæ­¥é ç«¯è®Šæ›´
        echo "ğŸ”„ åŒæ­¥é ç«¯è®Šæ›´..."
        git fetch origin
        git pull --rebase origin master || true
        
        # æª¢æŸ¥æ˜¯å¦æœ‰è®Šæ›´
        if [ -n "$(git status --porcelain)" ]; then
          echo "âœ… æœ‰è®Šæ›´éœ€è¦æäº¤"
          
          # é¡¯ç¤ºè®Šæ›´çµ±è¨ˆ
          echo "ğŸ“Š è®Šæ›´çµ±è¨ˆ:"
          git status --porcelain | wc -l
          echo "ğŸ“ è®Šæ›´è©³æƒ…:"
          git status --porcelain
          
          # çµ±è¨ˆå„ç›®éŒ„çš„åœ–ç‰‡æ•¸é‡
          if [ -d images ]; then
            echo "ğŸ“¸ ice_deliverer åœ–ç‰‡ç¸½æ•¸: $(find images -name "*.jpg" -o -name "*.png" | wc -l)"
          fi
          if [ -d colne_icol_images ]; then
            echo "ğŸ“¸ colne_icol åœ–ç‰‡ç¸½æ•¸: $(find colne_icol_images -name "*.jpg" -o -name "*.png" | wc -l)"
          fi
          if [ -d combined_images ]; then
            echo "ğŸ¨ çµ„åˆåœ–ç‰‡ç¸½æ•¸: $(find combined_images -name "*.jpg" -o -name "*.png" | wc -l)"
          fi
          
          # æ·»åŠ æ‰€æœ‰è®Šæ›´
          git add .
          
          # æäº¤è®Šæ›´
          git commit -m "ğŸ¤– å®šæ™‚è‡ªå‹•æŠ“å–åœ–ç‰‡ - $(date '+%Y-%m-%d %H:%M:%S')"
          
          # æ¨é€è®Šæ›´
          echo "ğŸ“¤ æ¨é€è®Šæ›´åˆ°é ç«¯..."
          git push origin master
          echo "âœ… æ¨é€å®Œæˆ"
        else
          echo "ğŸ“° æ²’æœ‰è®Šæ›´éœ€è¦æäº¤"
        fi
        
    - name: ç­‰å¾… GitHub Pages éƒ¨ç½²
      if: success()
      run: |
        echo "â³ ç­‰å¾… GitHub Pages éƒ¨ç½²å®Œæˆ..."
        echo "ç­‰å¾… 90 ç§’è®“ GitHub Pages æ›´æ–°..."
        sleep 90
        
    - name: ç™¼é€çµ„åˆåœ–ç‰‡åˆ° LINE ç¾¤çµ„
      if: success()
      run: |
        cd scripts
        echo "ğŸ“± é–‹å§‹ç™¼é€çµ„åˆåœ–ç‰‡åˆ° LINE ç¾¤çµ„..."
        
        # å¾ Python è…³æœ¬ç”¢ç”Ÿçš„é¸æ“‡æª”å–å¾—è¦ç™¼é€çš„æª”æ¡ˆï¼ˆè‹¥å­˜åœ¨å‰‡å„ªå…ˆä½¿ç”¨ï¼‰
        IMAGE_URL=""
        if [ -f scripts/selected_combined.json ]; then
          echo "ğŸ“‹ æ‰¾åˆ° scripts/selected_combined.jsonï¼Œå„ªå…ˆä½¿ç”¨è£¡é¢çš„é¸æ“‡"
          SEL_TYPE=$(python3 - <<'PY'
import json
try:
    j=json.load(open('scripts/selected_combined.json'))
    print(j.get('type',''))
except Exception:
    print('')
PY
)
          SEL_FILE=$(python3 - <<'PY'
import json
try:
    j=json.load(open('scripts/selected_combined.json'))
    print(j.get('filename',''))
except Exception:
    print('')
PY
)
          echo "   é¸æ“‡é¡å‹: $SEL_TYPE    æª”å: $SEL_FILE"

          if [ "$SEL_TYPE" = "daily_backup" ] || [ "$SEL_TYPE" = "daily_combined" ]; then
            if [ -n "$SEL_FILE" ]; then
              IMAGE_URL="https://future801113.github.io/i-love-col/combined_images/$SEL_FILE"
              echo "ğŸ–¼ï¸ ä½¿ç”¨é¸æ“‡æª”æŒ‡å®šçš„åœ–ç‰‡: $SEL_FILE"
            else
              echo "âš ï¸ é¸æ“‡æª”å…§æ²’æœ‰æª”åï¼Œå°‡å›é€€è‡³æŸ¥æ‰¾æœ€æ–°çµ„åˆåœ–ç‰‡çš„é‚è¼¯"
            fi
          else
            echo "ğŸ”• é¸æ“‡æª”æ¨™è¨˜ç‚º noneï¼Œè¡¨ç¤ºæœ¬æ¬¡æ²’æœ‰å¯ç™¼é€çš„çµ„åˆæˆ–å‚™ç”¨åœ–ç‰‡ï¼Œè·³é LINE ç™¼é€"
            exit 0
          fi
        fi

        # å¦‚æœå°šæœªæ±ºå®š IMAGE_URLï¼ˆé¸æ“‡æª”ä¸å­˜åœ¨æˆ–æ‰¾ä¸åˆ°æª”åï¼‰ï¼Œä½¿ç”¨èˆŠæœ‰çš„æœ€æ–°çµ„åˆåœ–ç‰‡é‚è¼¯
        if [ -z "$IMAGE_URL" ]; then
          # æª¢æŸ¥æ˜¯å¦æœ‰æ–°çš„çµ„åˆåœ–ç‰‡
          LATEST_COMBINED=$(find ../combined_images -name "daily_combined_*.jpg" 2>/dev/null | sort -r | head -1)
          if [ -n "$LATEST_COMBINED" ]; then
            echo "ğŸ–¼ï¸ æ‰¾åˆ°æœ€æ–°çµ„åˆåœ–ç‰‡: $LATEST_COMBINED"
            FILENAME=$(basename "$LATEST_COMBINED")
            IMAGE_URL="https://future801113.github.io/i-love-col/combined_images/$FILENAME"
          fi
        fi

        if [ -z "$IMAGE_URL" ]; then
          echo "ğŸ˜” æ²’æœ‰è¦ç™¼é€çš„åœ–ç‰‡ï¼Œè·³é LINE ç™¼é€"
          exit 0
        fi

        echo "ğŸ”— åœ–ç‰‡ URL: $IMAGE_URL"
          
          # æ¸¬è©¦ URL æ˜¯å¦å¯è¨ªå•
          echo "ğŸ§ª æ¸¬è©¦åœ–ç‰‡ URL å¯ç”¨æ€§..."
          HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$IMAGE_URL")
          echo "HTTP ç‹€æ…‹ç¢¼: $HTTP_STATUS"
          
          if [ "$HTTP_STATUS" = "200" ]; then
            echo "âœ… åœ–ç‰‡ URL å¯è¨ªå•"
            
            # ä½¿ç”¨ç¨ç«‹çš„ Python è…³æœ¬ç™¼é€ LINE è¨Šæ¯
            python3 send_line_image.py "$IMAGE_URL"
            
          else
            echo "âŒ åœ–ç‰‡ URL å°šæœªå¯è¨ªå• (ç‹€æ…‹ç¢¼: $HTTP_STATUS)"
            echo "â³ å†ç­‰å¾… 60 ç§’å¾Œé‡è©¦..."
            sleep 60
            
            HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$IMAGE_URL")
            if [ "$HTTP_STATUS" = "200" ]; then
              echo "âœ… é‡è©¦æˆåŠŸï¼Œåœ–ç‰‡ URL ç¾åœ¨å¯è¨ªå•"
              
              # é‡è©¦ç™¼é€ LINE è¨Šæ¯
              python3 send_line_image.py "$IMAGE_URL"
            else
              echo "âŒ åœ–ç‰‡ URL ä»ç„¶ç„¡æ³•è¨ªå•ï¼Œè·³é LINE ç™¼é€"
            fi
          fi
        else
          echo "ğŸ˜” æ²’æœ‰æ‰¾åˆ°æ–°çš„çµ„åˆåœ–ç‰‡"
        fi
        
    - name: é¡¯ç¤ºåŸ·è¡Œçµæœçµ±è¨ˆ
      if: always()
      run: |
        echo "ğŸ“Š åŸ·è¡Œçµæœçµ±è¨ˆ:"
        if [ -d images ]; then
          echo "ğŸ“¸ ice_deliverer åœ–ç‰‡ç¸½æ•¸: $(find images -name "*.jpg" -o -name "*.png" | wc -l)"
          echo "ğŸ“¸ ice_deliverer æœ€æ–°åœ–ç‰‡:"
          find images -name "*.jpg" -o -name "*.png" | sort -r | head -5
        fi
        if [ -d colne_icol_images ]; then
          echo "ğŸ“¸ colne_icol åœ–ç‰‡ç¸½æ•¸: $(find colne_icol_images -name "*.jpg" -o -name "*.png" | wc -l)"
          echo "ğŸ“¸ colne_icol æœ€æ–°åœ–ç‰‡:"
          find colne_icol_images -name "*.jpg" -o -name "*.png" | sort -r | head -5
        fi
        if [ -d combined_images ]; then
          echo "ğŸ¨ çµ„åˆåœ–ç‰‡ç¸½æ•¸: $(find combined_images -name "*.jpg" -o -name "*.png" | wc -l)"
          echo "ğŸ¨ æœ€æ–°çµ„åˆåœ–ç‰‡:"
          find combined_images -name "*.jpg" -o -name "*.png" | sort -r | head -3
        fi
